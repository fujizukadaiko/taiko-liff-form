<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>公演 出欠フォーム</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; padding: 16px; }
    h2 { margin: 0 0 12px; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px; margin:8px 0; }
    .muted { color:#666; font-size:13px; }
    button { padding:10px 14px; border-radius:10px; border:none; background:#06c; color:#fff; font-size:16px; }
    .ghost { background:#f5f5f5; color:#333; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    .ok { color:#0a7; }
    .err { color:#c33; }
  </style>
</head>
<body>
  <h2>出欠入力</h2>
  <div id="me" class="muted"></div>

  <div class="card">
    <div class="muted">現在配信中の公演</div>
    <div id="events">読み込み中...</div>
  </div>

  <div class="row" style="margin-top:8px;">
    <button id="btnStart">出欠入力を始める</button>
    <button id="btnPing" class="ghost">接続テスト</button>
  </div>

  <div id="log" class="muted" style="margin-top:10px;"></div>

<script>
  // ===== 設定（置換） =====
  const LIFF_ID = "＜あなたのLIFF ID＞";        // 例: 200xxx-xxxxxx
  const API_ENDPOINT = "＜GASの/exec URL＞";     // 例: https://script.google.com/macros/s/XXXX/exec

  // ===== 表示整形ユーティリティ =====
  function formatYmdDow(dateStr){
    const d = new Date(dateStr);
    if (isNaN(d)) return String(dateStr||"");
    const dow = "日月火水木金土"[d.getDay()];
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}/${m}/${dd}（${dow}）`;
  }
  function formatHm(timeStr){
    const t = new Date(timeStr);
    if (isNaN(t)) return String(timeStr||"");
    const hh = String(t.getHours()).padStart(2,"0");
    const mm = String(t.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  }

  // ===== 初期化 =====
  let myProfile = null;

  async function init(){
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login(); return; }

    // 表示用（profile スコープがONなら name が取れる）
    const payload = liff.getDecodedIDToken();
    const name = payload && payload.name ? payload.name : "";
    document.getElementById("me").textContent = name ? `こんにちは、${name} さん` : "";

    // 公演取得＆表示
    await loadEvents();

    // ボタン
    document.getElementById("btnPing").onclick = onPing;
    document.getElementById("btnStart").onclick = () => {
      // ここで既存の whoami → 初回登録 or 出欠入力 へ遷移する処理を呼んでください
      // 既存のロジックが別関数ならそこを呼ぶ形でOK
      log("ボタン反応OK（この先は既存の出欠フローに接続してください）");
    };
  }

  async function loadEvents(){
    const el = document.getElementById("events");
    el.textContent = "読み込み中...";
    try{
      const res = await fetch(API_ENDPOINT + "?events=1");
      const json = await res.json();
      if (json.status !== "ok") { el.innerHTML = `<span class="err">取得失敗</span>`; return; }
      const list = json.events || [];
      if (list.length === 0) { el.innerHTML = `<span>現在配信中の公演はありません</span>`; return; }

      el.innerHTML = list.map(ev => {
        const date = formatYmdDow(ev.date);
        const time = formatHm(ev.time);
        const line1 = `日時：${date} ${time}`;
        const line2 = `場所：${ev.place || ""}`;
        return `
          <div class="card" style="margin:8px 0;">
            <div>${line1}</div>
            <div>${line2}</div>
          </div>`;
      }).join("");
    } catch(err){
      el.innerHTML = `<span class="err">公演情報の取得に失敗しました。</span>`;
      log(err.message || String(err));
    }
  }

  // 接続テスト
  async function onPing(){
    try{
      const r = await fetch(API_ENDPOINT + "?ping=1");
      const j = await r.json();
      log(`接続テスト応答: ${j.status}`);
    } catch(e){
      log("接続テスト失敗: " + (e.message || e));
    }
  }

  function log(t){
    const el = document.getElementById("log");
    el.textContent = t;
  }

  init();
</script>
</body>
</html>
