<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>出欠フォーム（複数人一括＋複数演奏者登録）</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; padding:16px; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px; margin:12px 0; background:#fff; }
    label { display:block; margin:10px 0 6px; }
    input, select, textarea, button { width:100%; padding:10px; font-size:16px; box-sizing:border-box; }
    .primary { background:#06c; color:#fff; border:none; border-radius:8px; }
    .ghost { background:#f6f7f8; border:1px solid #ddd; border-radius:8px; }
    .danger { background:#e11; color:#fff; border:none; border-radius:8px; }
    .hint { color:#666; font-size:12px; }
    #msg { margin-top:8px; color:#444; }
    #loading {
      position: fixed; top: 12px; right: 12px;
      display: none; align-items: center; gap: 8px;
      background: rgba(0,0,0,0.65); color:#fff;
      padding: 6px 10px; border-radius: 999px; font-size: 13px;
    }
    .spinner {
      width: 14px; height: 14px; border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.4);
      border-top-color: #fff; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .disabled { opacity: .6; pointer-events: none; }

    /* table */
    table { width:100%; border-collapse: collapse; table-layout: fixed; }
    th, td { border-bottom:1px solid #eee; padding:10px 6px; font-size:15px; vertical-align: middle; }
    th { text-align:left; color:#333; background:#fafafa; }
    .nameCell { width:40%; word-break: break-all; }
    .attCell  { width:35%; }
    .pdCell   { width:25%; }

    .radio3 { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .radio3 label { display:flex; align-items:center; gap:6px; margin:0; }
    .pendingDate { width:100%; min-width: 120px; }
    .rowBtns { display:flex; gap:8px; }

    /* 演奏者の追加行 */
    .rowGrid { display:grid; grid-template-columns: 1fr 120px 90px; gap:10px; }
    .rowGrid > * { min-width: 0; }
    .toolbar { display:flex; gap:8px; }
  </style>
</head>
<body>
  <div id="loading"><div class="spinner"></div><span id="loadingText">処理中…</span></div>

  <h2>出欠フォーム</h2>

  <div class="card">
    <div id="eventBox" class="hint">公演情報を読み込み中…</div>
    <div style="display:flex; gap:8px; margin-top:8px;">
      <button id="beginBtn" class="primary" style="flex:1;">出欠入力をはじめる</button>
      <button id="pingBtn" class="ghost" style="flex:1;">接続テスト</button>
    </div>
    <div id="msg" class="hint"></div>
  </div>

  <!-- 初回登録フォーム（複数演奏者対応） -->
  <div id="regBox" class="card" style="display:none;">
    <h3>初回登録</h3>
    <label>入力者氏名</label>
    <input id="inputName" type="text" placeholder="例）山田太郎" />

    <div style="display:flex; align-items:center; justify-content:space-between; margin-top:10px;">
      <h4 style="margin:0;">演奏者一覧</h4>
      <div class="toolbar">
        <button id="addPerfBtn" class="ghost" type="button">＋ 演奏者を追加</button>
      </div>
    </div>
    <div id="perfList" class="hint" style="margin-top:8px;">
      <!-- 動的に行を追加 -->
    </div>

    <button id="regSubmitBulk" class="primary" style="margin-top:12px;">登録する</button>
    <div class="hint" style="margin-top:6px;">
      ※ 各行の「演奏者フラグ」は、その人が実際に出演するメンバーなら「はい(Y)」。保護者等は「いいえ(N)」にしてください。
    </div>
  </div>

  <!-- 出欠入力（複数人） -->
  <div id="attBox" class="card" style="display:none;">
    <h3>出欠入力</h3>
    <div id="eventSummary" class="hint" style="margin-bottom:8px;"></div>

    <div id="multiForm"></div>

    <label style="margin-top:10px;">全体コメント（任意）</label>
    <textarea id="commentAll" rows="3" placeholder="連絡事項があれば入力してください（各人に同じコメントを付けます）"></textarea>

    <button id="submitBulkBtn" class="primary" style="margin-top:12px;">まとめて送信</button>
  </div>

  <script>
    const LIFF_ID = "2008020568-2jVl00Rn";
    const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbxVsV3PR0sCxZwy9IGZ3-Kxsv89q2_-KFBYdnDXzdJ9kQ2naKCxFonDoLmRvbmgPJtk_g/exec";

    let gLineId = "";
    let busy = false;
    let activeEvent = null;
    let cachedMembers = [];

    const WEEKS = ["日","月","火","水","木","金","土"];
    const pad2 = n => String(n).padStart(2, "0");

    function setBusy(on, text="処理中…") {
      busy = on;
      const loading = document.getElementById("loading");
      document.getElementById("loadingText").textContent = text;
      loading.style.display = on ? "flex" : "none";
      const btns = ["beginBtn","regSubmitBulk","pingBtn","submitBulkBtn","addPerfBtn"]
        .map(id=>document.getElementById(id))
        .filter(Boolean);
      btns.forEach(b=>{
        if (on) {
          if (!b.dataset.origText) b.dataset.origText = b.textContent;
          if (b.id==="beginBtn") b.textContent="照会中…";
          else if (b.id==="regSubmitBulk") b.textContent="送信中…";
          else if (b.id==="submitBulkBtn") b.textContent="送信中…";
          else b.textContent="実行中…";
          b.classList.add("disabled"); b.disabled = true;
        } else {
          if (b.dataset.origText) b.textContent = b.dataset.origText;
          b.classList.remove("disabled"); b.disabled = false;
        }
      });
    }

    // ===== 日時表示ユーティリティ =====
    function parseToDate(val) {
      if (!val) return null;
      if (Object.prototype.toString.call(val) === "[object Date]" && !isNaN(val)) return val;
      const d = new Date(val);
      if (!isNaN(d)) return d;
      if (typeof val === "string") {
        const m = val.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
        if (m) return new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
      }
      return null;
    }
    function parseToTime(val) {
      if (!val) return null;
      const d = new Date(val);
      if (!isNaN(d)) return d;
      if (typeof val === "string") {
        const m = val.match(/^(\d{1,2}):(\d{2})$/);
        if (m) {
          const t = new Date();
          t.setHours(Number(m[1]), Number(m[2]), 0, 0);
          return t;
        }
      }
      return null;
    }
    function buildEventDisplay(ev) {
      const d = parseToDate(ev.date);
      const t = parseToTime(ev.time);
      const datePart = d
        ? `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}（${WEEKS[d.getDay()]}）`
        : String(ev.date || "");
      const timePart = t
        ? `${pad2(t.getHours())}:${pad2(t.getMinutes())}`
        : String(ev.time || "");
      const line1 = `日時：${datePart}${timePart ? " " + timePart : ""}`;
      const line2 = `場所：${ev.place || ""}`;
      return { line1, line2 };
    }
    function applyEventDisplay(ev) {
      const { line1, line2 } = buildEventDisplay(ev);
      document.getElementById("eventBox").textContent = `${line1}\n${line2}`;
      const es = document.getElementById("eventSummary");
      if (es) es.textContent = `${line1}\n${line2}`;
    }
    // ===== /日時表示ユーティリティ =====

    // === 初回登録（複数演奏者 UI） ===
    function addPerformerRow(name="", flag="Y") {
      const host = document.getElementById("perfList");
      const row = document.createElement("div");
      row.className = "rowGrid";
      row.innerHTML = `
        <input type="text" class="perfNameInput" placeholder="演奏者氏名" value="${name}">
        <select class="perfFlag">
          <option value="Y"${flag==="Y"?" selected":""}>はい（演奏者）</option>
          <option value="N"${flag==="N"?" selected":""}>いいえ（保護者など）</option>
        </select>
        <div class="rowBtns">
          <button type="button" class="ghost btnDel">− 削除</button>
        </div>
      `;
      row.querySelector(".btnDel").onclick = ()=> {
        host.removeChild(row);
        if (host.children.length === 0) addPerformerRow(); // 行がなくならないように1行補充
      };
      host.appendChild(row);
    }

    // === 出欠（複数行）UI ===
    function renderMultiForm(members){
      const perf = members.filter(m => (m.isPerformer||"").toUpperCase()==="Y");
      const list = perf.length ? perf : members;

      const wrap = document.getElementById("multiForm");
      wrap.innerHTML = "";
      if (list.length === 0) {
        wrap.innerHTML = "<div class='hint'>登録された演奏者が見つかりません。</div>";
        return;
      }

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th class="nameCell">演奏者</th>
          <th class="attCell">出欠</th>
          <th class="pdCell">未定の予定日</th>
        </tr>`;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      list.forEach((m, idx)=>{
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.className = "nameCell";
        tdName.textContent = m.performerName;

        const tdAttend = document.createElement("td");
        tdAttend.className = "attCell";
        tdAttend.innerHTML = `
          <div class="radio3">
            <label><input type="radio" name="att_${idx}" value="参加">参加</label>
            <label><input type="radio" name="att_${idx}" value="不参加">不参加</label>
            <label><input type="radio" name="att_${idx}" value="未定">未定</label>
          </div>`;

        const tdPending = document.createElement("td");
        tdPending.className = "pdCell";
        tdPending.innerHTML = `
          <input type="text" class="pendingDate" id="pd_${idx}" placeholder="YYYY/MM/DD" disabled>
          <div class="hint">未定時のみ入力</div>`;

        // ラジオの変更で未定日入力を制御
        setTimeout(()=>{
          const radios = tdAttend.querySelectorAll(`input[name="att_${idx}"]`);
          radios.forEach(r=>{
            r.addEventListener("change", ()=>{
              const input = tdPending.querySelector(`#pd_${idx}`);
              input.disabled = (r.value !== "未定");
              if (r.value !== "未定") input.value = "";
            });
          });
        });

        tr.appendChild(tdName);
        tr.appendChild(tdAttend);
        tr.appendChild(tdPending);
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      wrap.appendChild(table);
    }

    async function loadActiveEvent(){
      try {
        const r = await fetch(API_ENDPOINT + "?event=1&ts="+Date.now(), { cache:"no-store" });
        const j = await r.json();
        if (j.status==="ok" && j.event){
          activeEvent = j.event;
          applyEventDisplay(j.event);
        } else {
          document.getElementById("eventBox").textContent = "現在、配信中の公演はありません。";
          activeEvent = null;
        }
      } catch {
        document.getElementById("eventBox").textContent = "公演情報の取得に失敗しました。";
      }
    }

    async function init() {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login(); return; }
      document.getElementById("msg").textContent = "LIFF初期化完了。ボタンを押してください。";

      // 初回登録の演奏者リストを最低1行用意
      addPerformerRow("","Y");

      loadActiveEvent();
    }

    // 接続テスト
    document.getElementById("pingBtn").onclick = async ()=>{
      if (busy) return; setBusy(true,"接続テスト中…");
      try{
        const t = await fetch(API_ENDPOINT + "?ping=1&ts="+Date.now(), { cache:"no-store" }).then(r=>r.text());
        alert("接続テスト応答: " + t);
      }catch(e){ alert("接続失敗: " + e); }
      finally{ setBusy(false); }
    };

    // 出欠開始（whoami）
    document.getElementById("beginBtn").onclick = async ()=>{
      if (busy) return; setBusy(true,"会員照会中…");
      try{
        const decoded = liff.getDecodedIDToken();
        if (!decoded || !decoded.sub) { alert("LINEログイン情報が取得できませんでした"); return; }
        gLineId = decoded.sub;

        const res = await fetch(`${API_ENDPOINT}?whoami=1&id=${encodeURIComponent(gLineId)}&ts=${Date.now()}`, { cache:"no-store" });
        const json = await res.json();

        if (json.status === "ok") {
          cachedMembers = json.members || [];
          renderMultiForm(cachedMembers);
          document.getElementById("regBox").style.display = "none";
          document.getElementById("attBox").style.display = "block";
          document.getElementById("msg").textContent = "登録済みです。家族分まとめて選び、まとめて送信してください。";
          if (activeEvent) applyEventDisplay(activeEvent);
        } else if (json.status === "new") {
          document.getElementById("regBox").style.display = "block";
          document.getElementById("attBox").style.display = "none";
          document.getElementById("msg").textContent = "初回登録が必要です。入力者氏名と演奏者を追加してください。";
        } else {
          alert("応答エラー: " + JSON.stringify(json));
        }
      }catch(e){
        alert("whoamiエラー: " + e);
      } finally { setBusy(false); }
    };

    // 初回登録：演奏者行の追加
    document.getElementById("addPerfBtn").onclick = ()=>{
      if (busy) return;
      addPerformerRow("","Y");
    };

    // 初回登録：まとめて送信
    document.getElementById("regSubmitBulk").onclick = async ()=>{
      if (busy) return; setBusy(true,"送信中…");
      try{
        const inputName = document.getElementById("inputName").value.trim();
        if (!gLineId) { alert("LINE IDが未取得です。上のボタンから開始してください。"); return; }
        if (!inputName) { alert("入力者氏名を入力してください"); return; }

        const list = [];
        const host = document.getElementById("perfList");
        const rows = host.querySelectorAll(".rowGrid");
        rows.forEach(row=>{
          const name = row.querySelector(".perfNameInput").value.trim();
          const flag = row.querySelector(".perfFlag").value.trim();
          if (name && (flag==="Y" || flag==="N")) {
            list.push({ performerName: name, isPerformer: flag });
          }
        });
        if (list.length === 0) { alert("演奏者を1名以上入力してください"); return; }

        const url = `${API_ENDPOINT}?registerBulk=1&lineId=${encodeURIComponent(gLineId)}&inputName=${encodeURIComponent(inputName)}&list=${encodeURIComponent(JSON.stringify(list))}&ts=${Date.now()}`;
        const json = await fetch(url, { method:"GET", cache:"no-store" }).then(r=>r.json());

        if (json.status === "ok") {
          alert(`登録しました（${json.inserted ?? list.length}件）。出欠入力へ進みます。`);
          cachedMembers = json.members || [];
          renderMultiForm(cachedMembers);
          document.getElementById("regBox").style.display = "none";
          document.getElementById("attBox").style.display = "block";
          document.getElementById("msg").textContent = "登録完了。家族分まとめて選び、まとめて送信してください。";
          if (activeEvent) applyEventDisplay(activeEvent);
        } else {
          alert("登録失敗: " + (json.message || JSON.stringify(json)));
        }
      }catch(e){ alert("登録エラー: " + e); }
      finally { setBusy(false); }
    };

    // まとめて送信（Attendance）
    document.getElementById("submitBulkBtn").onclick = async ()=>{
      if (busy) return; setBusy(true,"送信中…");
      try{
        if (!activeEvent) { alert("配信中の公演がありません"); return; }
        if (!gLineId) { alert("LINE IDが未取得です"); return; }
        const commentAll = document.getElementById("commentAll").value.trim();

        const perf = cachedMembers.filter(m => (m.isPerformer||"").toUpperCase()==="Y");
        const list = perf.length ? perf : cachedMembers;

        const bulk = [];
        list.forEach((m, idx)=>{
          const radios = document.querySelectorAll(`input[name="att_${idx}"]`);
          let val = "";
          radios.forEach(r=>{ if (r.checked) val = r.value; });
          if (!val) return; // 未選択は送らない（柔らかい仕様）
          const pd = document.getElementById(`pd_${idx}`);
          bulk.push({
            performerName: m.performerName,
            attend: val,
            pendingDate: (val==="未定") ? (pd.value.trim()||"") : "",
            comment: commentAll
          });
        });

        if (bulk.length === 0) { alert("出欠が選択されていません"); return; }

        const url = `${API_ENDPOINT}?submitBulk=1&eventId=${encodeURIComponent(activeEvent.eventId)}&lineId=${encodeURIComponent(gLineId)}&bulk=${encodeURIComponent(JSON.stringify(bulk))}&ts=${Date.now()}`;
        const json = await fetch(url, { method:"GET", cache:"no-store" }).then(r=>r.json());

        if (json.status === "ok") {
          alert(`送信しました（${json.inserted}件）。ありがとうございます！`);
          try { liff.closeWindow(); } catch(_){}
        } else {
          alert("送信失敗: " + (json.message || JSON.stringify(json)));
        }
      }catch(e){ alert("送信エラー: " + e); }
      finally { setBusy(false); }
    };

    init();
  </script>
</body>
</html>
