<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>公演 出欠フォーム</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root { --pri:#065fd4; --muted:#666; --border:#e5e5e5; --bg:#fafafa; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; background:#fff; color:#222; }
    header { padding:14px 16px; border-bottom:1px solid var(--border); position:sticky; top:0; background:#fff; z-index:10; }
    header h1 { font-size:18px; margin:0; }
    main { padding:16px; }
    .muted { color:var(--muted); }
    .card { border:1px solid var(--border); border-radius:12px; padding:12px; background:#fff; }
    .stack { display:flex; flex-direction:column; gap:12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn { padding:10px 14px; border-radius:10px; border:none; background:var(--pri); color:#fff; font-size:16px; cursor:pointer; }
    .btn.ghost { background:#f3f4f6; color:#111; border:1px solid var(--border); }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .section-title { font-weight:600; margin:8px 0; }
    .event { padding:10px; border-radius:10px; border:1px solid var(--border); background:#fcfcfc; }
    .event .title { font-weight:600; margin-bottom:2px; }
    .hr { height:1px; background:var(--border); margin:8px 0; }
    .name { font-weight:600; }
    .att-row { display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px dashed var(--border); border-radius:10px; background:#fff; }
    select, input[type="text"], input[type="date"] {
      padding:8px 10px; border-radius:8px; border:1px solid var(--border); font-size:14px;
    }
    input::placeholder { color:#aaa; }
    /* 初期は非表示。JSで display を明示的に 'inline-block' に変えて表示させる */
    .pending-wrap { display:none; }
    .del { background:#fee; border:1px solid #fbb; color:#a11; }
    .add { background:#eef9ff; border:1px solid #bfe6ff; color:#035; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; }
    .warn { color:#a11; font-weight:600; }
    .ok { color:#0a7; font-weight:600; }
    .overlay { position:fixed; inset:0; background:rgba(255,255,255,.8); display:none; align-items:center; justify-content:center; z-index:999; backdrop-filter: blur(2px); }
    .spinner { width:28px; height:28px; border:3px solid #ddd; border-top-color: var(--pri); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .nav { margin:12px 0; }
  </style>
</head>
<body>
<header>
  <h1>公演 出欠フォーム</h1>
</header>
<main>
  <!-- Top -->
  <section id="viewTop" class="stack">
    <div id="hello" class="muted"></div>

    <div class="card">
      <div class="section-title">現在配信中の公演</div>
      <div id="eventsArea">読み込み中...</div>
    </div>

    <div class="toolbar">
      <button id="btnStart" class="btn">出欠入力をはじめる</button>
      <button id="btnManageNames" class="btn ghost">氏名登録・編集</button>
      <button id="btnPing" class="btn ghost">接続テスト</button>
    </div>

    <div id="topInfo" class="muted"></div>
  </section>

  <!-- 初回登録 -->
  <section id="viewInit" class="stack" style="display:none;">
    <div class="section-title">初回登録（入力者と演奏者）</div>

    <div class="card stack">
      <div class="row"><span style="width:7em;">入力者氏名</span>
        <input id="inputName" type="text" placeholder="例：藤塚千尋" style="flex:1;"/>
      </div>
      <div class="hr"></div>
      <div class="section-title">演奏者（複数可）</div>
      <div id="perfList" class="stack"></div>
      <div>
        <button id="btnAddPerf" class="btn add">＋ 演奏者を追加</button>
      </div>
      <div class="row nav">
        <button id="btnInitBack" class="btn ghost">← トップへ戻る</button>
        <button id="btnInitSubmit" class="btn">登録する</button>
      </div>
      <div id="initMsg" class="muted"></div>
    </div>
  </section>

  <!-- 出欠入力 -->
  <section id="viewAttend" class="stack" style="display:none;">
    <div class="section-title">出欠入力</div>
    <div id="attendArea" class="stack"></div>
    <div class="row nav">
      <button id="btnAttendBack" class="btn ghost">← トップへ戻る</button>
      <button id="btnAttendSubmitAll" class="btn">まとめて送信</button>
    </div>
    <div id="attendMsg" class="muted"></div>
  </section>
</main>

<!-- Loading overlay -->
<div id="overlay" class="overlay"><div class="spinner"></div></div>

<script>
/* ====== 設定 ====== */
const LIFF_ID = "2008020568-2jVl00Rn";             // 例: 200xxx-xxxxxx
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbydMPG_HVgX5dRh7uVQ26_I8a_KCsOE_2AxecICmvKlqcbj3nPayBhYD-xsJJ5Xb7MoOA/exec";          // 例: https://script.google.com/macros/s/XXXX/exec

/* ====== 状態 ====== */
let state = {
  lineId: "",
  displayName: "",
  who: "new",        // "ok" or "new"
  members: [],       // [{lineId,inputName,performerName}]
  events: [],        // [{eventId,date,time,place}]
  attendCache: {}    // eventId -> rows
};

/* ====== 共通UI ====== */
const $ = sel => document.querySelector(sel);
function show(id){ $(id).style.display=""; }
function hide(id){ $(id).style.display="none"; }
function overlay(on){ $("#overlay").style.display = on? "flex":"none"; }
function fmtDow(d){ return "日月火水木金土"[d.getDay()]; }
function fmtYmdDow(s){
  const d = new Date(s);
  if (isNaN(d)) return String(s||"");
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
  return `${y}/${m}/${dd}（${fmtDow(d)}）`;
}
function fmtHm(s){
  const d = new Date(s);
  if (isNaN(d)) {
    const m = String(s||"").match(/^(\d{1,2}):(\d{2})/);
    if (m) return `${m[1].padStart(2,"0")}:${m[2]}`;
    return String(s||"");
  }
  return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
}

/* ====== API ====== */
async function apiPing(){ return fetchJson("?ping=1"); }
async function apiEvents(){ return fetchJson("?events=1"); }
async function apiWhoAmI(lineId){ return fetchJson(`?whoami=1&id=${encodeURIComponent(lineId)}`); }
async function apiRegisterBulk(lineId, inputName, list){
  const qs = new URLSearchParams({ registerBulk:"1", lineId, inputName, list: JSON.stringify(list) });
  return fetchJson("?"+qs.toString());
}
async function apiGetAttendance(eventId, lineId){
  const qs = new URLSearchParams({ getAttendance:"1", eventId, lineId });
  return fetchJson("?"+qs.toString());
}
async function apiSubmitBulk(eventId, lineId, items){
  const qs = new URLSearchParams({ submitBulk:"1", eventId, lineId, bulk: JSON.stringify(items) });
  return fetchJson("?"+qs.toString());
}
async function fetchJson(query){
  const r = await fetch(API_ENDPOINT + query, { cache:"no-store" });
  return r.json();
}

/* ====== LIFF init ====== */
async function init(){
  overlay(true);
  try{
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login(); return; }

    const idt = liff.getDecodedIDToken();
    state.lineId = idt?.sub || "";
    state.displayName = idt?.name || "";

    $("#hello").textContent = state.displayName ? `こんにちは、${state.displayName} さん` : "";

    // イベント読み込み
    $("#eventsArea").textContent = "読み込み中...";
    const ev = await apiEvents();
    if (ev.status === "ok") { state.events = ev.events || []; }
    renderEventsTop();

    // whoami
    const w = await apiWhoAmI(state.lineId);
    if (w.status === "ok") {
      state.who = "ok";
      state.members = w.members || [];
      $("#topInfo").innerHTML = `<span class="ok">会員登録済みです。</span>`;
      $("#btnStart").textContent = "出欠入力をはじめる";
    } else {
      state.who = "new";
      state.members = [];
      $("#topInfo").innerHTML = `<span class="warn">まだ会員登録がありません。初回登録をお願いします。</span>`;
      $("#btnStart").textContent = "初回登録へ";
    }

    // ボタン
    $("#btnPing").onclick = onPing;
    $("#btnStart").onclick = onStart;
    $("#btnManageNames").onclick = onManageNames;

    // 初回登録画面のボタン
    $("#btnAddPerf").onclick = () => addPerfRow("");
    $("#btnInitBack").onclick = goTop;
    $("#btnInitSubmit").onclick = onSubmitInit;

    // 出欠画面のボタン
    $("#btnAttendBack").onclick = goTop;
    $("#btnAttendSubmitAll").onclick = onSubmitAll;

  } catch(e){
    alert("初期化に失敗しました: " + (e.message || e));
  } finally {
    overlay(false);
  }
}

/* ====== Top 画面 ====== */
function renderEventsTop(){
  const el = $("#eventsArea");
  const list = state.events || [];
  if (list.length === 0) { el.innerHTML = `<div>現在配信中の公演はありません</div>`; return; }
  el.innerHTML = list.map(ev=>{
    const ymd = fmtYmdDow(ev.date);
    const hm  = fmtHm(ev.time);
    return `
      <div class="event">
        <div class="title">${ymd} ${hm}</div>
        <div>場所：${ev.place||""}</div>
      </div>
    `;
  }).join("");
}
function goTop(){
  hide("#viewInit"); hide("#viewAttend"); show("#viewTop");
}

/* ====== 初回登録 ====== */
function onStart(){
  if (state.who === "new") {
    $("#initMsg").textContent = "";
    $("#inputName").value = "";
    $("#perfList").innerHTML = "";
    addPerfRow(""); // 最低1行
    hide("#viewTop"); show("#viewInit");
  } else {
    openAttend();
  }
}
function onManageNames(){
  $("#initMsg").textContent = "";
  $("#inputName").value = (state.members[0]?.inputName || "");
  $("#perfList").innerHTML = "";
  const perfs = state.members.map(m=>m.performerName);
  if (perfs.length === 0) addPerfRow("");
  else perfs.forEach(n=> addPerfRow(n));
  hide("#viewTop"); show("#viewInit");
}
function addPerfRow(value){
  const div = document.createElement("div");
  div.className = "row";
  div.innerHTML = `
    <input type="text" class="perf-name" style="flex:1;" placeholder="例：藤塚太郎" value="${escapeHtml(value||"")}"/>
    <button type="button" class="btn del">削除</button>
  `;
  div.querySelector(".del").onclick = () => div.remove();
  $("#perfList").appendChild(div);
}
function escapeHtml(s){return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));}

async function onSubmitInit(){
  const inputName = $("#inputName").value.trim();
  const perfInputs = Array.from(document.querySelectorAll("#perfList .perf-name"));
  const perfs = perfInputs.map(i=>i.value.trim()).filter(Boolean);

  if (!inputName) { alert("入力者氏名を入力してください"); return; }
  if (perfs.length === 0) { alert("演奏者を1名以上入力してください"); return; }

  $("#btnInitSubmit").disabled = true; overlay(true);
  try{
    const res = await apiRegisterBulk(state.lineId, inputName, perfs);
    if (res.status !== "ok") throw new Error(res.message || "登録失敗");
    state.who = "ok";
    state.members = res.members || [];
    alert("登録しました");
    goTop();
  } catch(e){
    alert("登録に失敗しました: " + (e.message || e));
  } finally {
    $("#btnInitSubmit").disabled = false; overlay(false);
  }
}

/* ====== 出欠入力 ====== */
async function openAttend(){
  $("#attendMsg").textContent = "";
  $("#attendArea").innerHTML = `<div class="muted">読み込み中...</div>`;
  hide("#viewTop"); show("#viewAttend");
  overlay(true);
  try{
    state.attendCache = {};
    for (const ev of state.events) {
      const r = await apiGetAttendance(ev.eventId, state.lineId);
      state.attendCache[ev.eventId] = (r.status==="ok" ? (r.rows||[]) : []);
    }
    renderAttendForm();
  } catch(e){
    $("#attendArea").innerHTML = `<div class="warn">出欠情報の取得に失敗しました</div>`;
  } finally {
    overlay(false);
  }
}

function renderAttendForm(){
  const perfs = state.members.map(m=>m.performerName);
  if (!perfs.length) {
    $("#attendArea").innerHTML = `
      <div class="card">
        <div class="warn">演奏者が登録されていません。先に「氏名登録・編集」から登録してください。</div>
      </div>`;
    return;
  }
  const html = state.events.map(ev=>{
    const ymd = fmtYmdDow(ev.date); const hm = fmtHm(ev.time);
    const prev = state.attendCache[ev.eventId] || [];
    const map = {}; for (const r of prev) map[r.performerName] = r;

    const rows = perfs.map(name=>{
      const prevRow = map[name] || {};
      const selVal  = prevRow.attend || "";
      const pdVal   = prevRow.pendingDate || "";
      const comVal  = prevRow.comment || "";
      return `
        <div class="att-row" data-event="${ev.eventId}" data-name="${escapeHtml(name)}">
          <div class="name" style="min-width:7em;">${escapeHtml(name)}</div>
          <select class="attend-select">
            <option value="">選択してください</option>
            <option value="参加" ${selVal==="参加"?"selected":""}>参加</option>
            <option value="不参加" ${selVal==="不参加"?"selected":""}>不参加</option>
            <option value="未定" ${selVal==="未定"?"selected":""}>未定</option>
          </select>
          <span class="pending-wrap">
            予定日：<input type="date" class="pending-date" value="${pdVal?pdVal.replace(/\//g,"-"):""}"/>
          </span>
          <input type="text" class="comment-input" style="flex:1;" placeholder="コメント（任意）" value="${escapeHtml(comVal)}"/>
        </div>
      `;
    }).join("");

    return `
      <div class="card stack">
        <div class="event">
          <div class="title">${ymd} ${hm}</div>
          <div>場所：${ev.place||""}</div>
        </div>
        ${rows}
      </div>
    `;
  }).join("");

  $("#attendArea").innerHTML = html;
  bindAttendSelectHandlers(); // ← ここでバインド＆初期反映
}

function bindAttendSelectHandlers(){
  const rows = document.querySelectorAll('.att-row');
  rows.forEach(row=>{
    const sel = row.querySelector('.attend-select');
    const wrap = row.querySelector('.pending-wrap');
    if (!sel || !wrap) return;

    const toggle = ()=> {
      const v = (sel.value || "").trim();
      // 重要：CSSの display:none を上書きするため、明示的に設定する
      wrap.style.display = (v === '未定') ? 'inline-block' : 'none';
    };

    // 初期表示
    toggle();

    // 変更時（ブラウザ差吸収のため change と input 両方）
    sel.addEventListener('change', toggle);
    sel.addEventListener('input',  toggle);
  });
}

// 送信前バリデーション：未定なら予定日必須
function validateBeforeSubmit(){
  for (const row of document.querySelectorAll('.att-row')) {
    const name = row.dataset.name || row.querySelector('.name')?.textContent?.trim() || '';
    const sel  = row.querySelector('.attend-select');
    const date = row.querySelector('.pending-date');
    if (!sel) continue;
    if ((sel.value || "").trim() === '未定') {
      if (!date || !date.value) {
        alert(`${name} さんは「未定」のため予定日を入力してください。`);
        date?.focus();
        row.scrollIntoView({behavior:'smooth', block:'center'});
        return false;
      }
    }
  }
  return true;
}

function collectBulkForEvent(eventId){
  const rows = document.querySelectorAll(`.att-row[data-event="${CSS.escape(eventId)}"]`);
  const items = [];
  rows.forEach(row=>{
    const name = row.dataset.name || row.querySelector('.name')?.textContent?.trim() || '';
    const sel  = row.querySelector('.attend-select');
    const date = row.querySelector('.pending-date');
    const com  = row.querySelector('.comment-input');

    const attend = (sel?.value || "").trim();
    let pendingDate = '';
    if (attend === '未定' && date && date.value) {
      pendingDate = date.value.replace(/-/g, '/');
    }
    const comment = com?.value?.trim() || '';

    if (name && attend) items.push({ performerName:name, attend, pendingDate, comment });
  });
  return items;
}

async function onSubmitAll(){
  if (!validateBeforeSubmit()) return;

  $("#btnAttendSubmitAll").disabled = true; overlay(true);
  try{
    for (const ev of state.events) {
      const items = collectBulkForEvent(ev.eventId);
      if (items.length === 0) continue;
      const res = await apiSubmitBulk(ev.eventId, state.lineId, items);
      if (res.status !== "ok") throw new Error(res.message || "送信失敗");
    }
    alert("送信しました");
    goTop();
  } catch(e){
    alert("送信中にエラー: " + (e.message || e));
  } finally {
    $("#btnAttendSubmitAll").disabled = false; overlay(false);
  }
}

/* ====== テスト/補助 ====== */
async function onPing(){
  const r = await apiPing();
  alert("接続テスト: " + (r.status || "no status"));
}

/* ====== run ====== */
init();
</script>
</body>
</html>
