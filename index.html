<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>公演 出欠フォーム</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{
      --c-primary:#0b74de; --c-bg:#fafafa; --c-border:#e5e5e5;
      --c-text:#222; --c-muted:#666; --c-ok:#0a7; --c-err:#c33;
    }
    body{ font-family: system-ui, -apple-system, Segoe UI, sans-serif; margin:0; background:var(--c-bg); color:var(--c-text);}
    header{ padding:14px 16px; font-size:18px; font-weight:700; background:#fff; border-bottom:1px solid var(--c-border);}
    main{ padding:14px 16px; }
    .card{ background:#fff; border:1px solid var(--c-border); border-radius:12px; padding:12px; margin:10px 0; }
    .muted{ color:var(--c-muted); font-size:13px; }
    .row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    button{ appearance:none; border:none; border-radius:10px; padding:10px 14px; background:var(--c-primary); color:#fff; font-size:16px; }
    button.ghost{ background:#f4f4f4; color:#222; border:1px solid var(--c-border); }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .ok{ color:var(--c-ok); }
    .err{ color:var(--c-err); }
    .sectionTitle{ font-weight:700; margin:8px 0; }

    /* view 切り替え */
    [data-view]{ display:none; }
    [data-view].show{ display:block; }

    /* スピナー */
    .spinner{ width:18px; height:18px; border:2px solid #ddd; border-top-color:var(--c-primary); border-radius:50%; animation:spin 1s linear infinite; display:inline-block; vertical-align:middle; }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    label{ display:block; font-size:14px; margin:6px 0 4px; }
    select, input[type="date"], input[type="text"], textarea{
      width:100%; border:1px solid var(--c-border); border-radius:8px; padding:8px; font-size:15px; background:#fff;
    }
    .small{ font-size:12px; color:var(--c-muted); }
    .line{ height:1px; background:var(--c-border); margin:10px 0; }
    .warn{ background:#fff7d6; border:1px solid #f3d27a; padding:10px; border-radius:10px; color:#7a5b00; }

    .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#f5f5f5; border:1px solid var(--c-border); }
    .right{ text-align:right; }
  </style>
</head>
<body>
<header>公演 出欠フォーム</header>
<main>

  <!-- 友だち未追加アラート（任意表示） -->
  <div id="friendAlert" class="card warn" style="display:none;">
    このLIFFのBotが「友だち追加」されていません。通知を受け取るには公式アカウントを友だち追加してください。
  </div>

  <!-- ====== HOME VIEW ====== -->
  <section id="view-home" data-view class="show">
    <div id="hello" class="muted"></div>

    <div class="card">
      <div class="sectionTitle">現在配信中の公演</div>
      <div id="eventsBox" class="muted">読み込み中… <span class="spinner"></span></div>
    </div>

    <div class="card">
      <div class="sectionTitle">あなたの登録状況</div>
      <div id="answersBox" class="muted">会員情報照会中… <span class="spinner"></span></div>
    </div>

    <div class="row" style="margin-top:6px;">
      <button id="btnOpenForm">出欠を入力 / 変更する</button>
      <button id="btnReload" class="ghost">再読み込み</button>
    </div>
    <div id="homeLog" class="muted" style="margin-top:8px;"></div>
  </section>

  <!-- ====== FORM VIEW ====== -->
  <section id="view-form" data-view>
    <div class="row" style="justify-content:space-between;">
      <div class="sectionTitle">出欠入力フォーム</div>
      <button id="btnBack" class="ghost">トップに戻る</button>
    </div>

    <!-- 公演表示（まとめて） -->
    <div id="formEventsBox" class="card muted">公演読み込み中… <span class="spinner"></span></div>

    <!-- メンバー×公演の入力欄 -->
    <div id="formFields"></div>

    <div class="line"></div>
    <div class="row right">
      <button id="btnSubmit">送信する</button>
    </div>
    <div id="formLog" class="muted" style="margin-top:8px;"></div>
  </section>

</main>

<script>
/* ===== 設定（置換） ===== */
const LIFF_ID = "2008020568-2jVl00Rn";
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbw8yD16abH2IBz5-WbbwxoIehEozkUUCpN7HbjYm75pEdQemIdzR2QQPapk7m6xEVGxUg/exec";

/* ===== 状態 ===== */
let state = {
  lineId: "",        // LIFFのIDトークンから取得（aud=LIFFのLoginチャネル）
  name:   "",
  members: [],       // [{lineId,inputName,performerName},...]
  events:  [],       // [{eventId,date,time,place},...  ※配信フラグ=Y]
  answers: {},       // { eventId: [{performerName,attend,pendingDate,comment,answeredAt}], ... }
  submitting: false
};

/* ===== ユーティリティ ===== */
const $ = sel => document.querySelector(sel);
function show(viewId){
  document.querySelectorAll("[data-view]").forEach(v => v.classList.remove("show"));
  $(viewId).classList.add("show");
}
function logHome(t){ $("#homeLog").textContent = t||""; }
function logForm(t){ $("#formLog").textContent = t||""; }

function formatYmdDow(s){
  const d = new Date(s);
  if (isNaN(d)) return String(s||"");
  const dow = "日月火水木金土"[d.getDay()];
  return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")}（${dow}）`;
}
function formatHm(s){
  const d = new Date(s);
  if (!isNaN(d)) return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
  // 文字列のとき先頭5桁 HH:MM を拾う
  const m = String(s||"").match(/^(\d{1,2}:\d{2})/);
  return m ? m[1] : String(s||"");
}
function toYmdForInput(ymd){ // "yyyy/MM/dd" → "yyyy-MM-dd"
  const m = String(ymd||"").match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
  if (!m) return "";
  return `${m[1]}-${String(m[2]).padStart(2,"0")}-${String(m[3]).padStart(2,"0")}`;
}
function fromInputToYmd(v){ // "yyyy-MM-dd" → "yyyy/MM/dd"
  const m = String(v||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);
  return m ? `${m[1]}/${m[2]}/${m[3]}` : "";
}

/* ===== API ===== */
async function api(path){ const r = await fetch(API_ENDPOINT + path); return r.json(); }

/* ===== 初期化 ===== */
async function init(){
  try{
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()){ liff.login(); return; }

    // 友だち状態（任意）：Linked OA 必須
    if (liff.getFriendship){
      try{
        const fr = await liff.getFriendship();
        if (fr && fr.friendFlag === false) { $("#friendAlert").style.display = ""; }
      }catch(_){}
    }

    const idt = liff.getDecodedIDToken(); // scope: openid
    state.lineId = idt ? idt.sub : "";
    state.name   = idt && idt.name ? idt.name : "";
    $("#hello").textContent = state.name ? `こんにちは、${state.name} さん` : "";

    $("#eventsBox").innerHTML = `読み込み中… <span class="spinner"></span>`;
    $("#answersBox").innerHTML = `会員情報照会中… <span class="spinner"></span>`;

    // イベント一覧
    const ev = await api("?events=1");
    state.events = (ev.status==="ok" && Array.isArray(ev.events)) ? ev.events : [];

    // 会員確認
    const w = await api(`?whoami=1&id=${encodeURIComponent(state.lineId)}`);
    if (w.status === "ok"){ state.members = w.members || []; }
    else { state.members = []; }

    // 回答読み込み（公演×自分）
    state.answers = {};
    for (const e of state.events){
      const a = await api(`?getAttendance=1&eventId=${encodeURIComponent(e.eventId)}&lineId=${encodeURIComponent(state.lineId)}`);
      state.answers[e.eventId] = (a.status==="ok" ? (a.rows||[]) : []);
    }

    renderHome();

    // ボタン
    $("#btnReload").onclick = async ()=>{
      logHome("再読み込み中…"); await init(); logHome("");
    };
    $("#btnOpenForm").onclick = onOpenForm;
    $("#btnBack").onclick = ()=>{ show("#view-home"); };

    $("#btnSubmit").onclick = onSubmit;

  }catch(err){
    $("#eventsBox").innerHTML = `<span class="err">初期化に失敗しました: ${err.message||err}</span>`;
  }
}

function renderHome(){
  // イベント表示
  if (!state.events.length){
    $("#eventsBox").innerHTML = `<span>現在配信中の公演はありません</span>`;
  }else{
    $("#eventsBox").innerHTML = state.events.map(e=>{
      const line1 = `日時：${formatYmdDow(e.date)} ${formatHm(e.time)}`;
      const line2 = `場所：${e.place||""}`;
      return `<div class="card" style="margin:8px 0">
        <div>${line1}</div>
        <div>${line2}</div>
      </div>`;
    }).join("");
  }

  // 登録状況
  if (!state.members.length){
    $("#answersBox").innerHTML = `
      <div>まだ「初回登録」が済んでいません。</div>
      <div class="small">出欠の前に、入力者名と演奏者（家族分も可）の登録をしてください。</div>`;
  }else{
    let html = "";
    for (const e of state.events){
      const ans = state.answers[e.eventId] || [];
      if (!ans.length){
        html += `<div class="card"><div class="muted">【${formatYmdDow(e.date)} ${formatHm(e.time)} @${e.place}】</div><div>まだ回答がありません</div></div>`;
      }else{
        html += `<div class="card"><div class="muted">【${formatYmdDow(e.date)} ${formatHm(e.time)} @${e.place}】</div>`;
        ans.forEach(r=>{
          const att = r.attend || "";
          const extra = (att==="未定" && r.pendingDate) ? `（予定日:${r.pendingDate}）` : "";
          html += `<div class="row" style="justify-content:space-between;">
            <span class="pill">${r.performerName}</span>
            <span>${att}${extra}</span>
          </div>`;
        });
        html += `</div>`;
      }
    }
    if (!html) html = `<div class="muted">配信中の公演がありません</div>`;
    $("#answersBox").innerHTML = html;
  }
}

/* ===== フォームを開く ===== */
function onOpenForm(){
  // 初回登録がない場合はガイド（ここは既存の「初回登録フォーム」遷移にくっつけてもOK）
  if (!state.members.length){
    alert("まずは初回登録（演奏者の追加）をお願いします。登録後に出欠入力ができます。");
    return;
  }
  show("#view-form");
  buildFormView();
}

function buildFormView(){
  // 公演の見出し
  if (!state.events.length){
    $("#formEventsBox").innerHTML = `<span>現在配信中の公演はありません</span>`;
  }else{
    $("#formEventsBox").innerHTML = state.events.map(e=>{
      return `<div class="card">
        <div>日時：${formatYmdDow(e.date)} ${formatHm(e.time)}</div>
        <div>場所：${e.place||""}</div>
      </div>`;
    }).join("");
  }

  // 入力欄（イベント×メンバー）
  const box = $("#formFields");
  box.innerHTML = "";
  for (const e of state.events){
    const current = state.answers[e.eventId] || [];
    // 既存回答を {name -> row} に
    const map = {}; current.forEach(r => map[r.performerName] = r);

    // このユーザーの演奏者一覧
    const performers = Array.from(new Set(state.members.map(m => m.performerName))).filter(Boolean);

    // イベントごとにカード
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<div class="sectionTitle">【${formatYmdDow(e.date)} ${formatHm(e.time)}】</div>`;
    performers.forEach((name, idx)=>{
      const row = map[name] || {};
      const attend = row.attend || "";
      const pendingYmd = row.pendingDate ? toYmdForInput(row.pendingDate) : "";

      const idBase = `e${e.eventId}_i${idx}`;
      const html = `
        <div style="border-top:1px dashed var(--c-border); margin:10px 0; padding-top:10px;">
          <div class="pill" style="margin-bottom:6px;">${name}</div>
          <label for="${idBase}_att">出欠</label>
          <select id="${idBase}_att" data-event="${e.eventId}" data-name="${name}">
            <option value="">（選択してください）</option>
            <option value="参加" ${attend==="参加"?"selected":""}>参加</option>
            <option value="欠席" ${attend==="欠席"?"selected":""}>欠席</option>
            <option value="未定" ${attend==="未定"?"selected":""}>未定</option>
          </select>

          <div class="row">
            <div style="flex:1; min-width:180px;">
              <label for="${idBase}_date">未定の予定日（未定を選んだときのみ）</label>
              <input type="date" id="${idBase}_date" value="${pendingYmd}">
            </div>
            <div style="flex:2; min-width:220px;">
              <label for="${idBase}_com">コメント（任意・100文字まで）</label>
              <input type="text" id="${idBase}_com" value="${row.comment||""}" maxlength="100" placeholder="例：家族の都合で検討中 など">
            </div>
          </div>
          <div class="small muted">※「未定」選択時は予定日を入れてください</div>
        </div>
      `;
      card.insertAdjacentHTML("beforeend", html);
    });
    box.appendChild(card);
  }
}

/* ===== 送信 ===== */
async function onSubmit(){
  if (state.submitting) return;
  state.submitting = true;
  const btn = $("#btnSubmit");
  btn.disabled = true;
  btn.textContent = "送信中…";
  logForm("");

  try{
    const payloads = []; // event×name ごとに {eventId, performerName, attend, pendingDate, comment}
    const seen = new Set();

    for (const e of state.events){
      const performers = Array.from(new Set(state.members.map(m => m.performerName))).filter(Boolean);
      performers.forEach((name, idx)=>{
        const idBase = `e${e.eventId}_i${idx}`;
        const sel = $(`#${CSS.escape(idBase)}_att`);
        if (!sel) return;
        const attend = sel.value;

        const dateEl = $(`#${CSS.escape(idBase)}_date`);
        const comEl  = $(`#${CSS.escape(idBase)}_com`);
        const pendingRaw = dateEl ? dateEl.value : "";
        const pendingYmd = fromInputToYmd(pendingRaw);

        // バリデーション
        if (!attend) return; // 未選択は送らない（前回回答があれば維持）

        if (attend === "未定" && !pendingYmd){
          throw new Error(`「${name}」の未定は予定日が必須です`);
        }

        const key = `${e.eventId}||${name}`;
        if (seen.has(key)) return;
        seen.add(key);

        payloads.push({
          eventId: e.eventId,
          performerName: name,
          attend,
          pendingDate: pendingYmd,
          comment: (comEl && comEl.value) ? comEl.value.trim() : ""
        });
      });
    }

    if (!payloads.length){
      alert("送信する内容がありません（出欠の選択が未入力です）");
      return;
    }

    // イベント単位で submitBulk（上書き）
    const grouped = {};
    for (const p of payloads){
      if (!grouped[p.eventId]) grouped[p.eventId] = [];
      grouped[p.eventId].push({
        performerName: p.performerName,
        attend: p.attend,
        pendingDate: p.pendingDate,
        comment: p.comment
      });
    }

    // 直列送信（イベント数は多くない想定）
    for (const [eventId, list] of Object.entries(grouped)){
      const url = `${API_ENDPOINT}?submitBulk=1&eventId=${encodeURIComponent(eventId)}&lineId=${encodeURIComponent(state.lineId)}&bulk=${encodeURIComponent(JSON.stringify(list))}`;
      const r = await fetch(url);
      const j = await r.json();
      if (j.status !== "ok") throw new Error(`送信失敗（${eventId}）: ${j.message||"unknown"}`);
    }

    // 成功：トップに戻って最新内容の読み直し
    alert("送信しました");
    show("#view-home");
    logHome("更新中…");
    await init();
    logHome("");

  }catch(err){
    logForm(err.message || String(err));
  }finally{
    state.submitting = false;
    btn.disabled = false;
    btn.textContent = "送信する";
  }
}

init();
</script>
</body>
</html>
