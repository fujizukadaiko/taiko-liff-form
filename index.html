<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>公演 出欠フォーム</title>

  <!-- Google Fonts（本文=ゴシック / 見出し=明朝） -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&family=Noto+Serif+JP:wght@500;600;700&family=Shippori+Mincho:wght@500;700&display=swap"
    rel="stylesheet"
  />
  <!-- Tailwind（preflight無効） -->
  <script>
    window.tailwind = window.tailwind || {};
    tailwind.config = {
      corePlugins: { preflight: false },
      theme: {
        extend: {
          colors: { primary: '#7f6aa5' },
          boxShadow: { card: '0 2px 10px rgba(0,0,0,0.04)' }
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

  <!-- ===== Base CSS ===== -->
  <style>
    :root{
      --c-bg:#f7f5fa; --c-panel:#fff; --c-border:#e8e2f0;
      --c-text:#202022; --c-muted:#6b6b6b;
      --c-primary:#7f6aa5; --c-primary-2:#6d5a93; --c-accent:#a678b0;
      --c-acc1:#d2e5b1; --c-acc2:#9ce78f; --c-acc2-dark:#6aa96a;
      --c-ok:#0a7; --c-err:#c33;
    }
    body{
      margin:0; color:var(--c-text);
      font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,"Hiragino Sans","Yu Gothic","Meiryo",sans-serif;
      letter-spacing:.02em;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(127,106,165,.05), transparent 40%),
        radial-gradient(900px 500px  at 80% 60%, rgba(127,106,165,.04), transparent 35%),
        var(--c-bg);
    }
    h1,h2,h3{
      font-family: "Shippori Mincho", "Noto Serif JP", "Yu Mincho", "Hiragino Mincho ProN", "MS PMincho", serif;
      letter-spacing: 0.03em;
    }
    .sectionTitle{
      font-family: "Noto Sans JP","Hiragino Sans","Yu Gothic","Meiryo",sans-serif;
      font-weight: 700;
      letter-spacing: 0.02em;
    }
    .siteTitle{
      font-family: "Shippori Mincho","Noto Serif JP","Yu Mincho","Hiragino Mincho ProN","MS PMincho",serif !important;
      font-weight: 600; letter-spacing: 0.03em;
    }

    header{
      padding:14px 16px; font-size:18px;
      background:#fff; border-bottom:1px solid var(--c-border);
      display:flex; justify-content:space-between; align-items:center;
    }
    main{ padding:14px 16px; }
    .ver{ font-size:12px; color:#888; font-weight:500; }

    .card{ background:#fff; border:1px solid var(--c-border); border-radius:12px; padding:12px; margin:10px 0; }
    .muted{ color:var(--c-muted); font-size:13px; }
    .row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .row-space{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .right{ text-align:right; }
    .badge{ display:inline-block; font-size:12px; padding:2px 6px; background:var(--c-accent); color:#fff; border-radius:999px; margin-left:8px; }
    .small{ font-size:12px; color:var(--c-muted); }

    [data-view]{ display:none; }
    [data-view].show{ display:block; }

    .spinner{ width:18px; height:18px; border:2px solid #ddd; border-top-color:var(--c-primary); border-radius:50%; animation:spin 1s linear infinite; display:inline-block; vertical-align:middle; }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    label{ display:block; font-size:14px; margin:6px 0 4px; }
    input[type="text"], input[type="date"], input[type="time"], select, textarea{
      width:100%; border:1px solid var(--c-border); border-radius:8px; padding:8px; font-size:15px; background:#fff;
    }
    .listEmpty{ color:#888; font-size:14px; }

    .pill{ display:inline-flex; align-items:center; gap:6px; padding:5px 8px; border-radius:999px; background:#f5f5f5; border:1px solid var(--c-border); }
    .pill.sm{ font-size:11px; padding:2px 6px; }

    .stat-ok{ background:#e8f8f3; border:1px solid #cdeee4; color:#0a7; }
    .stat-ng{ background:#fdeaea; border:1px solid #f6cccc; color:#c33; }
    .stat-pd{ background:#fff7d6; border:1px solid #f3d27a; color:#7a5b00; }
    .stat-na{ background:#f5f5f5; border:1px solid var(--c-border); color:#666; }

    .adminGrid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:700px){ .adminGrid{ grid-template-columns:1fr; } }
    .hint{ font-size:12px; color:#777; }

    .tag{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--c-border); background:#f7f7f7; color:#444; }
    .tag.open{ background:#e8f8f3; border-color:#cdeee4; color:#0a7; }
    .tag.closed{ background:#fdeaea; border-color:#f6cccc; color:#c33; }

    header.is-sticky{ position:sticky; top:0; backdrop-filter:blur(6px); background:rgba(255,255,255,.9); z-index:50; }

    .warnBox{ background:#fff7d6; border:1px solid #f3d27a; padding:10px; border-radius:10px; color:#7a5b00; }

    a.btn, button.btn{
      display:inline-flex; align-items:center; justify-content:center;
      min-height:40px; padding:10px 14px; border-radius:12px;
      border:1px solid var(--c-border); background:#fff; color:var(--c-text);
      text-decoration:none; font-size:15px; font-weight:600; letter-spacing:.01em; line-height:1;
      box-shadow:0 2px 8px rgba(0,0,0,.06);
      transition:transform .08s ease, filter .12s ease, box-shadow .12s ease;
      cursor:pointer;
    }
    .btn-primary{
      color:#fff !important;
      border-color:color-mix(in srgb, var(--c-primary-2), #000 6%) !important;
      background-image:linear-gradient(to bottom right, var(--c-primary), var(--c-primary-2)) !important;
      background-color:var(--c-primary) !important;
    }
    .btn-outline{ background:#fff !important; color:var(--c-primary-2) !important; border-color:var(--c-primary-2) !important; }
    .btn-sm{ padding:8px 12px; min-height:36px; font-size:14px; border-radius:10px; }
    .btn-lg{ padding:12px 16px; min-height:44px; font-size:16px; border-radius:14px; }
    .btnRow{ display:flex; flex-wrap:wrap; gap:8px; align-items:stretch; margin:8px 0; }
    .btnRow .btn{ flex:1 1 100%; }
    @media (min-width:600px){
      .btnRow{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px; }
      .btnRow .btn{ width:100%; }
    }

    /* ===== 出欠フォーム（アコーディオン） ===== */
    .fEvent{ border:1px solid var(--c-border); border-radius:12px; background:#fff; margin:10px 0; }
    .fHead{ padding:10px 12px; cursor:pointer; }
    .fHead:hover{ background:#faf8ff; }
    .fBody{ display:none; padding:0 12px 12px; }
    .fEvent.open .fBody{ display:block; }
    .fTitleRow{ display:flex; align-items:baseline; gap:6px; }
    .fTitleRow .t-date{ white-space:nowrap; }
    .fTitleRow .t-place{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; min-width:0; flex:1 1 auto; }
    .fStatusRow{ margin-top:6px; display:flex; flex-wrap:wrap; gap:6px; }
    .fSub{ margin-top:4px; font-size:12px; color:var(--c-muted); }
    .badge-unsaved{
      display:inline-flex; align-items:center; justify-content:center;
      padding:2px 8px; height:22px; border-radius:999px;
      font-size:11px; font-weight:600;
      color:#b45309; border:1.5px solid #f59e0b; background:#fff8e6; white-space:nowrap;
    }
    /* ===== 出欠フォーム 見た目調整 ===== */
    /* ① 日付・時間・@場所 を太字に */
    .fTitleRow .t-date,
    .fTitleRow .t-place{
      font-weight: 700;
    }
    
    /* ② ガイド文（枠なし・背景なし・文字のみ） */
    #view-form #formEventsBox.guidePlain{
      background: transparent;
      border: 0;
      padding: 0;
      margin: 4px 0 8px;
    }
    
    /* ③ アコーディオン：選択中の色を少し濃い紫に */
    .fHead{ transition: background-color .12s ease; }
    .fHead:hover{ background: #f5efff; }
    .fEvent.open .fHead{ background: #efe7ff; } /* ←濃いめに */
    
    /* ④ 名前の丸い枠を廃止してシンプルに */
    .nameLabel{
      font-weight: 600;
      color: #444;
      /* 枠・背景なし */
      padding: 0;
      border: 0;
      background: transparent;
    }
    
    /* ⑤ 名前と小さめプルダウンを同一行に配置 */
    .row-att{
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .attSel{
      min-width: 120px;
      width: auto;
      height: 34px;
      font-size: 14px;
      padding: 6px 10px;
    }
    
    /* ⑥ セレクトを“ボタン風”（紫枠・白背景・紫文字）に */
    .selectBtn{
      border: 1.5px solid var(--c-primary-2) !important;
      background: #fff !important;
      color: var(--c-primary-2) !important;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(127,106,165,0.14);
    }
    .selectBtn:focus{
      outline: none;
      box-shadow: 0 0 0 3px rgba(127,106,165,.18);
    }
    /* ===== ガイドの赤強調 ===== */
    .em-red{
      color: var(--c-err);
      font-weight: 700;
    }
    
    /* ===== 送信ボタン：送信中は薄い紫＆操作不可 ===== */
    .btn-primary[disabled],
    .btn-primary:disabled{
      background: #ede7ff !important;          /* 薄い紫 */
      border-color: #d6ccff !important;
      color: var(--c-primary-2) !important;
      cursor: not-allowed !important;
      pointer-events: none !important;          /* タップ無効（多重送信防止） */
      box-shadow: none !important;
      filter: saturate(.85);
    }
    /* すべてのボタンの disabled 視覚 */
    button[disabled],
    .btn[disabled],
    button:disabled,
    .btn:disabled{
      opacity: .55;
      pointer-events: none;
      cursor: not-allowed;
      filter: saturate(.6);
    }
    /* =========================================================
   Schedules用：プルダウンを少し低め（出欠フォームと統一）
   ※ 既存の .selectBtn を上書きします（全ページ共通OK）
   ========================================================= */
    .selectBtn{
      height: 36px;         /* 高さをコンパクトに */
      min-height: 36px;
      line-height: 34px;    /* テキスト縦位置のバランス調整 */
      padding: 0 12px;      /* 左右はそのまま */
      font-size: 14px;      /* 少しだけ控えめ */
    }
    
    /* iOS / Safari 対応（矢印のズレを抑制：必要なら） */
    .selectBtn::-ms-expand { display: none; }
    .selectBtn {
      -webkit-appearance: none;
      appearance: none;
    }

/* =========================================================
   ゴーストボタン（#btnFetchSchedules など）を紫ボーダーに統一
   既存 .btn, .btn-sm を活かして「色味」だけを合わせます
   ========================================================= */
    .btn.btn-ghost{
      background: #fff !important;
      color: var(--c-primary-2) !important;
      border: 1px solid color-mix(in srgb, var(--c-primary-2), #000 10%) !important;
      box-shadow: 0 1px 4px rgba(127,106,165, 0.08); /* ごく薄い影 */
      transition: background-color .12s ease, border-color .12s ease, color .12s ease, box-shadow .12s ease;
    }
    .btn.btn-ghost:hover{
      background: color-mix(in srgb, var(--c-primary), #fff 90%) !important; /* わずかに紫が乗る */
      border-color: var(--c-primary) !important;
      color: var(--c-primary-2) !important;
      box-shadow: 0 2px 8px rgba(127,106,165, 0.12);
    }
    .btn.btn-ghost:focus-visible{
      outline: 2px solid color-mix(in srgb, var(--c-primary), #000 0%) !important;
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--c-primary), #fff 80%) !important;
    }
    
    /* 送信中などの無効化見た目（全ボタン共通・再掲OK） */
    button[disabled],
    .btn[disabled]{
      opacity: .55;
      pointer-events: none;
      cursor: not-allowed;
      filter: saturate(.6);
    }
    /* ================================
   今後の予定：レイアウトと見た目
   ================================ */
    
    /* 2列グリッド：プルダウンを横並び、下段にボタン */
    .schedControls{
      display: grid;
      grid-template-columns: auto auto;
      gap: 10px 14px;
      align-items: end;
      justify-content: start; /* 横幅を内容サイズに合わせる */
    }
    .schedControls .field{
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .schedControls .span2{
      grid-column: 1 / -1; /* 2列ぶち抜きで下段にボタン */
    }
    
    /* プルダウンを短め幅に（内容量に応じて調整可） */
    .schedSel{
      width: 160px;          /* コンパクト幅（ご希望に応じて 140〜200pxで微調整可） */
      max-width: 100%;
    }
    
    /* モバイルで列落ちしても綺麗に見せる */
    @media (max-width: 420px){
      .schedControls{
        grid-template-columns: 1fr 1fr; /* 2列のままでもOK。1列にしたければ 1fr に */
      }
      .schedSel{
        width: 100%; /* 極端に狭い端末では全幅にして文字切れを防止 */
      }
    }
    
    /* 文字が見切れる対策：選択肢垂直位置のクリップを緩和 */
    .selectBtn{
      height: 36px;
      min-height: 36px;
      line-height: normal;  /* ← 重要：iOSで文字が切れないよう固定line-heightを解除 */
      padding: 6px 12px;    /* 縦の余白で視認性を確保 */
      font-size: 14px;
      -webkit-appearance: none;
      appearance: none;
    }
    /* ================================
   今後の予定：2行のラベル｜プルダウン配置
   ================================ */
    /* ラベル｜セレクト の2列グリッド。要素は [label, select, label, select, span2...] の順 */
    .schedControls{
      display: grid;
      grid-template-columns: auto max-content; /* 左=ラベル、右=プルダウン */
      gap: 10px 14px;
      align-items: center;
      justify-content: start;
    }
    
    /* ボタンは2列ぶち抜きで下段へ */
    .schedControls .span2{
      grid-column: 1 / -1;
    }
    
    /* ラベル側のスタイル（任意） */
    .scLabel{
      font-size: 14px;
      color: var(--c-text);
      white-space: nowrap;
    }
    
    /* プルダウンを短め幅に（前回より“半分”寄りのサイズ） */
    .schedSel.short{
      width: 120px;                  /* 目安：前回160px → 120px。さらに短くしたければ 96〜110pxなどに */
      max-width: 100%;
    }
    
    /* 端末幅が狭い時の保険：文字が見切れないように */
    @media (max-width: 420px){
      .schedSel.short{
        width: clamp(100px, 40vw, 128px); /* 端末に応じて少し伸縮 */
      }
    }
    
    /* iOS 文字欠け対策（selectの縦詰まりを避ける） */
    .selectBtn{
      height: 36px;
      min-height: 36px;
      line-height: normal;
      padding: 6px 12px;
      font-size: 14px;
      -webkit-appearance: none;
      appearance: none;
    }
    /* 氏名編集(登録)ページの微調整 */
    .regAddRow { 
      margin-top: 12px;               /* 上と詰まらないように余白を追加 */
    }
    #regNote {
      margin: 6px 0 8px;               /* タイトル直下の注意書きの行間 */
      font-size: 12px;
      color: var(--c-muted);
    }
    /* ===== 演奏者行（ラベルは1行、下段で入力と削除を2列に並べる） ===== */
    .perfRow{
      display: grid;
      grid-template-columns: 1fr auto;  /* 入力 1fr | 削除 auto */
      grid-template-rows: auto auto;    /* 1段目: ラベル / 2段目: 入力＋削除 */
      column-gap: 12px;
      row-gap: 6px;
      margin: 10px 0;
      align-items: center;
    }
    
    .perfRow .perfLabel{                 /* ラベルは2カラムぶち抜き */
      grid-column: 1 / -1;
      font-size: 12px;
      color: var(--c-muted);
    }
    
    .perfRow .regPerf{                   /* 入力欄 */
      grid-column: 1 / 2;
      width: 100%;
      height: 44px;                      /* 入力の高さを固定 */
    }
    
    .perfRow .btn-remove{                /* 削除ボタンを入力の高さに合わせる */
      grid-column: 2 / 3;
      min-height: 44px;
      height: 44px;
      padding: 0 14px;
      border-radius: 12px;
      align-self: end;                   /* 下段のベースラインに揃える */
    }
    
    /* 画面が狭いときの左右パディング微調整（任意） */
    @media (max-width: 420px){
      .perfRow{ column-gap: 10px; }
      .perfRow .btn-remove{ padding: 0 12px; }
    }
    /* 無効（disabled）の見た目を統一：集合場所・出欠対象・締切日・配信フラグなど */
    .selectBtn:disabled,
    input[type="date"]:disabled,
    input[type="time"]:disabled,
    input[type="text"]:disabled {
      color: #888 !important;
      background: #f7f5ff !important;         /* ごく薄い紫 */
      border-color: #e6e0f0 !important;
      box-shadow: none !important;
      cursor: not-allowed !important;
    }
  </style>

  <!-- Tailwind の上乗せ -->
  <script type="text/tailwindcss">
    @layer components {
      header { @apply border-b border-[color:var(--c-border)] px-4 py-3 flex items-center justify-between; }
      .card { @apply rounded-xl border bg-[color:var(--c-panel)] p-4 shadow-card border-[color:var(--c-border)]; }
      .sectionTitle { @apply font-bold text-[17px] text-[color:var(--c-text)]; }
      .sectionTitle::after{ content:""; display:block; height:3px; width:72px; margin-top:6px; border-radius:999px;
                            background:linear-gradient(90deg, var(--c-primary) 0%, #c9b8e6 100%); }
      .line { @apply h-px my-3 bg-[color:var(--c-border)]; }
      input[type="text"], input[type="date"], input[type="time"], select, textarea {
        @apply rounded-lg border px-3 py-2 bg-white text-[15px] border-[color:var(--c-border)]
               focus:outline-none focus:ring-2 focus:ring-[color:var(--c-primary)]/25;
      }
      .pill { @apply inline-flex items-center gap-1.5 rounded-full border px-2 py-0.5 text-xs bg-slate-50 border-[color:var(--c-border)] text-slate-700; }
      .pill.sm { @apply text-[11px] px-2 py-0.5; }
      .badge { @apply ml-2 inline-block rounded-full px-2 py-0.5 text-xs text-white; @apply bg-[color:var(--c-accent)]; }
      .tag { @apply inline-block rounded-full px-2 py-0.5 text-xs border bg-slate-50 border-[color:var(--c-border)] text-slate-600; }
      .tag.open   { @apply bg-emerald-50 border-emerald-200 text-emerald-600; }
      .tag.closed { @apply bg-rose-50    border-rose-200    text-rose-600; }
      .stat-ok { @apply bg-emerald-50 border border-emerald-200 text-emerald-700; }
      .stat-ng { @apply bg-rose-50    border border-rose-200    text-rose-700; }
      .stat-pd { @apply bg-amber-50   border border-amber-200   text-amber-700; }
      .stat-na { @apply bg-slate-50   border border-slate-200   text-slate-500; }
      .spinner { border-top-color: rgb(79 70 229); }
    }
  </script>
  <!-- ===== Custom Overrides（最後に評価されるCSS） ===== -->
  <style id="custom-overrides">
    :root{
      /* プルダウンの横幅（必要に応じて微調整） */
      --attSel-width: 180px;
    }

    /* 名前 + セレクトを同じ行に。右側のセレクト幅を固定 */
    .row-att{
      display: grid;
      grid-template-columns: 1fr var(--attSel-width);
      gap: 8px;
      align-items: center;
    }

    /* ボタン風プルダウンの幅を統一（プレースホルダと選択後で幅が変わらないように） */
    .selectBtn{
      width: var(--attSel-width);
      min-width: var(--attSel-width);
      box-sizing: border-box;
      white-space: nowrap;
      border: 1.5px solid var(--c-primary-2);
      color: var(--c-primary-2);
      background: #fff;
      border-radius: 10px;
      padding: 6px 10px;
      font-weight: 600;
    }

    /* プレースホルダ行（value=""）の色 */
    .selectBtn option[value=""]{
      color: #9aa;
    }

    /* すべてのボタンの disabled 視覚（前にご提示のものもここにまとめてOK） */
    button[disabled],
    .btn[disabled]{
      opacity: .55;
      pointer-events: none;
      cursor: not-allowed;
      filter: saturate(.6);
    }
    /* ---- 軽い削除ボタン（見た目を他ボタンと差別化） ---- */
    .btn-remove{
      background:#fff !important;
      color:#222 !important;                         /* 黒系文字 */
      border:1px solid #dcd2ef !important;           /* ごく薄い紫の枠 */
      box-shadow:
        0 2px 10px rgba(127,106,165,0.10),           /* 薄い紫のソフトシャドウ */
        0 1px 0 rgba(0,0,0,0.02) inset;
      transition: transform .08s ease, filter .12s ease, box-shadow .12s ease;
    }
    .btn-remove:hover{
      filter: brightness(0.98);
      box-shadow:
        0 3px 12px rgba(127,106,165,0.16),
        0 1px 0 rgba(0,0,0,0.03) inset;
    }
    .btn-remove:active{
      transform: translateY(1px);
    }
    .btn-remove:focus-visible{
      outline: none;
      box-shadow:
        0 0 0 3px rgba(127,106,165,0.12),            /* フォーカス時に薄いリング */
        0 2px 10px rgba(127,106,165,0.10);
    }
    /* 無効時の視覚（全体ルールに準拠） */
    .btn-remove[disabled]{
      opacity: .55;
      pointer-events: none;
      cursor: not-allowed;
      filter: saturate(.6);
    }
    /* === disabledテキスト入力の見た目をselectと統一（iOS/Safari対応） === */
    input[type="text"]:disabled,
    input[type="date"]:disabled,
    input[type="time"]:disabled,
    textarea:disabled {
      color: #888 !important;                     /* テキスト色 */
      -webkit-text-fill-color: #888 !important;   /* iOS/Safariで薄くなるのを防ぐ */
      opacity: 1 !important;                      /* iOSの透明度低下を打ち消す */
      background: #f7f5ff !important;             /* 既存ルールと統一 */
      border-color: #e6e0f0 !important;
    }
    
    /* placeholderも濃さを統一する */
    input[type="text"]:disabled::placeholder,
    input[type="date"]:disabled::placeholder,
    input[type="time"]:disabled::placeholder,
    textarea:disabled::placeholder {
      color: #888 !important;
      opacity: 1 !important;
    }
    
    /* Safari旧挙動の保険 */
    input[type="text"]:disabled::-webkit-input-placeholder,
    input[type="date"]:disabled::-webkit-input-placeholder,
    input[type="time"]:disabled::-webkit-input-placeholder,
    textarea:disabled::-webkit-input-placeholder {
      color: #888 !important;
      opacity: 1 !important;
    }
    /* 上部アコーディオンのヘッダーを常時うす紫、open時は少し濃く */
    #adminListAcc .fHead{
      background:#f5efff !important;
      border-radius:10px;
    }
    #adminListAcc.open .fHead{
      background:#efe7ff !important;
    }
    /* アコーディオン内の編集ボタンを小さめ＆薄めトーンに */
    #adminListAcc .btn-edit{
      min-height: 32px;
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 9px;
      background:#fff !important;
      color: color-mix(in srgb, var(--c-primary-2), #000 0%) !important; /* 文字は既存と同系色 */
      border: 1px solid color-mix(in srgb, var(--c-primary-2), #000 12%) !important; /* 枠をワントーン薄く */
      box-shadow: 0 1px 3px rgba(127,106,165,0.08);
    }
    #adminListAcc .btn-edit:hover{
      background:#f8f6ff !important;
      border-color: color-mix(in srgb, var(--c-primary-2), #000 20%) !important;
    }
    /* 管理フォームのみ：注釈の文字をさらに小さく（10px） */
    #view-admin .hint{
      font-size: 10px !important;
      line-height: 1.55;
    }
  </style>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>
  <header class="is-sticky">
    <div class="siteTitle">出欠入力と予定確認</div>
    <div class="ver" id="ver"></div>
  </header>

  <main>
    <!-- 友だち未追加アラート -->
    <div id="friendAlert" class="card warnBox" style="display:none;">
      このLIFFのBotが「友だち追加」されていません。通知を受け取るには公式アカウントを友だち追加してください。
    </div>

    <!-- ===== HOME ===== -->
    <section id="view-home" data-view class="show">
      <div id="hello" class="muted"></div>

      <!-- 管理メニュー（管理者のみ表示） -->
      <div id="adminMenu" class="card" style="display:none;">
        <div class="sectionTitle">管理用</div>
        <div class="row" style="gap:8px;">
          <button id="btnAdminMenuSchedules" class="btn btn-outline btn-sm" data-view-target="view-admin">予定登録/編集</button>
          <button id="btnAdminMenuReport"    class="btn btn-outline btn-sm" data-view-target="view-admin-report">出欠結果一覧</button>
        </div>
        <div class="small muted" style="margin-top:6px;">※ 管理者のみ表示されます</div>
      </div>

      <!-- ★ トップ操作ボタン -->
      <div class="btnRow" aria-label="主操作">
        <button id="btnPrimary"   class="btn btn-primary btn-lg" data-view-target="view-form">出欠を入力 / 変更する</button>
        <button id="btnSchedules" class="btn btn-outline btn-lg" data-view-target="view-schedules">今後の予定</button>
        <button id="btnEditNames" class="btn btn-outline btn-lg" data-view-target="view-register" style="display:none;">登録氏名編集</button>
      </div>

      <!-- 互換性維持のためのダミー -->
      <button id="btnReload" type="button" style="display:none;"></button>

      <!-- 回答受付中の公演（密リスト＋バッジ） -->
      <div class="card">
        <div class="row-space">
          <div class="sectionTitle">回答受付中の公演</div>
          <label class="pill sm" style="margin-left:auto;">
            <input type="checkbox" id="homeOnlyNA" checked>
            未定/未回答のみ表示
          </label>
        </div>
        <div id="eventsBox"><div class="muted">読み込み中… <span class="spinner"></span></div></div>
      </div>

      <!-- あなたの登録状況（トップでは非表示） -->
      <div class="card" style="display:none;">
        <div class="sectionTitle">あなたの登録状況</div>
        <div id="answersBox" class="muted">会員情報照会中… <span class="spinner"></span></div>
      </div>

      <div id="homeLog" class="muted" style="margin-top:8px;"></div>
    </section>
    <!-- HOME end -->

    <!-- ===== フォーム（出欠） ===== -->
    <section id="view-form" data-view>
      <div class="row-space">
        <div class="sectionTitle">出欠入力フォーム</div>
        <button id="btnBackFromForm" class="btn btn-ghost btn-sm" data-view-target="view-home">トップに戻る</button>
      </div>

      <div id="formEventsBox" class="muted guidePlain">公演読み込み中… <span class="spinner"></span></div>
      <div id="formFields"></div>

      <div class="line"></div>
      <div class="row right">
        <button id="btnSubmit" class="btn btn-primary" disabled>まとめて送信</button>
      </div>
      <div id="formLog" class="muted" style="margin-top:8px;"></div>
    </section>

    <!-- ===== 初回登録/氏名編集 ===== -->
    <section id="view-register" data-view>
      <div class="row-space">
        <div class="sectionTitle" id="regTitle">初回登録（入力者 & 演奏者）</div>
        <button id="btnBackFromReg" class="btn btn-ghost btn-sm" data-view-target="view-home">トップに戻る</button>
      </div>

      <div class="card">
        <label for="regInputName">入力者氏名（あなたの名前）</label>
        <input type="text" id="regInputName" placeholder="例：山田 太郎"/>

        <div class="line"></div>
        <div class="line"></div>

        <!-- タイトル + 追加ボタン（余白をとるため regAddRow を付与） -->
        <div class="row-space regAddRow">
          <div class="sectionTitle" style="margin:0;">演奏者（家族も追加可）</div>
          <button id="btnAddPerf" class="btn btn-ghost btn-sm" type="button">＋ 演奏者を追加</button>
        </div>
        
        <!-- ※注意書き：タイトル直下へ移動 -->
        <div id="regNote" class="small muted">
          ※ あなた自身が演奏する場合は、演奏者としてあなたの名前も追加してください。
        </div>
        
        <!-- 演奏者入力リスト -->
        <div id="perfList"></div>
      </div>

      <div class="row right">
        <button id="btnRegister" class="btn btn-primary">登録する</button>
      </div>
      <div id="regLog" class="muted" style="margin-top:8px;"></div>
    </section>

    <!-- ===== 今後の予定 ===== -->
    <section id="view-schedules" data-view>
      <div class="row-space">
        <div class="sectionTitle">今後の予定</div>
        <div class="row" style="gap:8px;">
          <button id="btnBackFromSchedules" class="btn btn-ghost btn-sm" data-view-target="view-home">トップに戻る</button>
        </div>
      </div>

     <div class="card">
      <div class="schedControls">
        <!-- 1行目：表示期間（日数） | プルダウン -->
        <label for="selDays" class="scLabel">表示期間（日数）</label>
        <select id="selDays" class="selectBtn schedSel short">
          <option value="30">30日</option>
          <option value="60" selected>60日</option>
          <option value="90">90日</option>
        </select>
    
        <!-- 2行目：種別フィルタ | プルダウン -->
        <label for="selKind" class="scLabel">種別フィルタ</label>
        <select id="selKind" class="selectBtn schedSel short">
          <option value="">（すべて）</option>
          <option value="発表">発表</option>
          <option value="練習">練習</option>
          <option value="その他">その他</option>
        </select>
    
        <!-- 下段：再取得ボタン（2列ぶち抜き） -->
        <div class="span2">
          <button id="btnFetchSchedules" class="btn btn-ghost btn-sm">再取得</button>
        </div>
      </div>
    
      <div id="schedulesBox" class="muted" style="margin-top:8px;">読み込み待機中</div>
    </div>    
    </section>

    <!-- ===== 予定登録（管理者） ===== -->
    <section id="view-admin" data-view>
      <div class="row-space">
        <div class="sectionTitle">予定登録（管理者）</div>
        <button id="btnAdminBack" class="btn btn-ghost btn-sm" data-view-target="view-home">トップに戻る</button>
      </div>
      <!-- ★ 上段のアコーディオン：現在登録中のイベント一覧 -->
      <div class="card fEvent" id="adminListAcc">
        <div class="fHead" style="display:flex; align-items:center; justify-content:space-between;">
          <div class="sectionTitle" style="margin:0;">現在登録中のイベント一覧</div>
          <span class="small muted">タップで開閉</span>
        </div>
        <div class="fBody">
           <div class="row" style="gap:12px; align-items:flex-end; margin:6px 0;">
            <div>
              <label>一覧の表示期間（日数）</label>
              <select id="ad_days" class="selectBtn">
                <option value="30">30日</option>
                <option value="60" selected>60日</option>
                <option value="90">90日</option>
              </select>
            </div>
            <div style="margin-left:auto;">
              <button id="btnAdminFetch" class="btn btn-ghost btn-sm">一覧を取得</button>
            </div>
          </div>
          <div id="adminListBoxTop" class="muted">読み込み待機中</div>
        </div>
      </div>
      <div class="card">
        <div class="row-space">
          <div class="sectionTitle" id="adminFormTitle">新規登録</div>
          <div class="small muted"><span id="adminEditingId" style="display:none;"></span></div>
        </div>

        <div class="adminGrid">
          <div><label>タイトル *</label><input id="ad_title" type="text" placeholder="例：秋祭り演奏会"></div>
         <!-- 種別 *： "(選択)" を削除し、プレースホルダに。クラス selectBtn を付与 -->
        <div>
          <label>種別 *</label>
          <select id="ad_type" class="selectBtn" required>
            <option value="" disabled hidden selected>（選択）</option>
            <option value="発表">発表</option>
            <option value="練習">練習</option>
            <option value="その他">その他</option>
          </select>
        </div>
          <div><label>日付 *</label><input id="ad_ymd" type="date"></div>
          <div><label>時間（開始）</label><input id="ad_hm" type="time" placeholder="HH:mm"></div>
          <div><label>場所</label><input id="ad_place" type="text" placeholder="例：藤塚小体育館"></div>
          <div><label>集合時間（発表・その他のみ）</label><input id="ad_meetAt" type="time" placeholder="HH:mm"></div>
          <div><label>集合場所</label><input id="ad_meetPlace" type="text" placeholder="例：藤塚小学校"></div>
          <div>
            <label>出欠対象（発表のみ）</label>
            <select id="ad_attendTarget" class="selectBtn">
              <option value="Y">Y</option>
              <option value="N" selected>N</option>
            </select>
          </div>
          <div><label>締切日</label><input id="ad_deadline" type="date"></div>
          <div>
            <label>公開</label>
            <select id="ad_publish" class="selectBtn">
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>
          <div>
            <label>ステータス</label>
            <select id="ad_status" class="selectBtn">
              <option value="active" selected>active</option>
              <option value="archived">archived</option>
            </select>
          </div>
          <div>
            <label>配信フラグ（必須：発表のみ）</label>
            <select id="ad_flag" class="selectBtn"><!-- 動的に差し替え --></select>
          </div>
        </div>

        <div class="hint" style="margin-top:6px;">
          * 必須。IDは自動採番です。<br>
          種別が「練習」の場合は集合時間/集合場所/締切日/配信フラグ無効化。<br>
          種別が「発表」以外では「出欠対象」は自動で N 固定になります。<br>
          「発表」の配信フラグは <b>新規登録時は Y/N のみ</b>、<b>編集時は Y/S/D/N</b> が選択可能です。
        </div>

        <div class="row right" style="margin-top:10px;">
          <button id="btnAdminReset"  class="btn btn-ghost btn-sm" type="button">新規モードに戻す</button>
          <button id="btnAdminSubmit" class="btn btn-primary">新規登録</button>
        </div>
        <div id="adminFormLog" class="muted" style="margin-top:8px;"></div>
      </div>
    </section>

    <!-- ===== 出欠結果一覧（管理者） ===== -->
    <section id="view-admin-report" data-view>
      <div class="row-space">
        <div class="sectionTitle">出欠結果一覧（管理者）</div>
        <div class="row" style="gap:8px;">
          <button id="btnReportBack"   class="btn btn-ghost btn-sm" data-view-target="view-home">トップに戻る</button>
          <button id="btnReportReload" class="btn btn-ghost btn-sm">再取得</button>
        </div>
      </div>

      <div class="card">
        <div class="row" style="gap:12px;">
          <div style="min-width:260px; flex:1;">
            <label for="repEvent">公演を選択</label>
            <select id="repEvent"><option value="">（選択してください）</option></select>
          </div>
          <div>
            <label for="repAttend">出欠フィルタ</label>
            <select id="repAttend">
              <option value="">（すべて）</option>
              <option value="参加">参加</option>
              <option value="欠席">欠席</option>
              <option value="未定">未定</option>
            </select>
          </div>
        </div>
        <div class="small muted" style="margin-top:6px;">
          ※ 対象は「公開=Yes」かつ配信フラグが Y/S/D の予定のみ
        </div>
      </div>

      <div id="repBox" class="muted">公演を選択してください</div>
    </section>
  </main>

  <!-- ===== 共通：SPA切替 ===== -->
  <script>
    function showView(id){
      document.querySelectorAll('[data-view]').forEach(v => {
        v.classList.toggle('show', v.id === id);
      });
      window.scrollTo({ top: 0, behavior: 'auto' });
    }
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('[data-view-target]').forEach(el => {
        el.addEventListener('click', (ev) => {
          ev.preventDefault();
          const target = el.getAttribute('data-view-target');
          if (target) showView(target);
        });
      });
      document.getElementById('btnReload')?.addEventListener('click', () => location.reload());
    });
  </script>

  <!-- ===== HomeEventsUI v6 ===== -->
  <script>
  (function(){
    if (window.HomeEventsUI && window.HomeEventsUI.__v === 6) return;
  
    /* 状態 */
    const S = {
      events: [],          // [{id, ymd, hm, place, deadline, isNew}]
      ansMap: {},          // { eventId: [{name, answer}] }
      names : [],          // ★ 登録演奏者（期待人数の基準）["猪股 千尋","こうしくん",...]
      onlyNA: true         // 「未回答のみ」= 未回答/一部未回答/未定あり を表示
    };
  
    /* 参照 */
    const E = {
      box : () => document.getElementById('eventsBox'),
      ckN : () => document.getElementById('homeOnlyNA'),
    };
  
    /* ---- 表示系 CSS（上乗せ） ---- */
    const css = document.createElement('style');
    css.textContent = `
      .evList { margin-top: 6px; }
    
      .eventRow{
        display:block;
        border:1px solid var(--c-border);
        border-radius:12px;
        background:#fff;
        padding:10px 12px;
        margin:8px 0;
      }
      .eventMeta{ min-width:0; }
    
      /* 1行目：左=出欠バッジ / 右=NEW */
      .eventHead{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:8px;
        margin-bottom:6px;
      }
    
      /* 2行目：日付 時刻 @ 場所（B案） */
      .eventTitle{ display:flex; align-items:baseline; gap:4px; font-weight:700; font-size:15px; line-height:1.45; }
      .eventTitle .title-date{ white-space:nowrap; flex:0 0 auto; }
      .eventTitle .title-place{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; min-width:0; flex:1 1 auto; }
    
      /* 3行目：締切 */
      .eventSub{ font-size:12px; color:var(--c-muted); margin-top:2px; }
      .deadline{ color:#666; }
      .deadline-soon{ color:#c33; font-weight:600; }
    
      /* NEWバッジ：ボタンのアウトライン風 */
      .badge-new{
        display:inline-flex;
        align-items:center;
        justify-content:center;
        padding:2px 8px;
        height:22px;                 /* pill.sm と同じ背丈感 */
        border-radius:999px;
        font-size:11px;
        font-weight:600;
        color: var(--c-primary-2);
        border:1.5px solid var(--c-primary-2);
        background:#fff;
        white-space:nowrap;
      }
      
      /* 詳細（家族別チップ） */
      .eventDetail{ display:none; padding:6px 6px 0 6px; }
      .eventRow.open + .eventDetail { display:block; }
    `;
    document.head.appendChild(css);
  
    /* ---- Util ---- */
    function parseYmd(s){
      if (!s) return null;
      const m = String(s).match(/(\d{4})[\/\-](\d{2})[\/\-](\d{2})/);
      if (!m) return null;
      const d = new Date(+m[1], +m[2]-1, +m[3]); d.setHours(0,0,0,0);
      return isNaN(d) ? null : d;
    }
  
    function deadlineClass(deadlineStr){
      const d = parseYmd(deadlineStr);
      if (!d) return '';
      const today = new Date(); today.setHours(0,0,0,0);
      const diff = Math.floor((d - today)/86400000);
      // 3日前（diff <= 3）以降は赤。超過（負）もこのクラスで赤
      return (diff <= 3) ? 'deadline-soon' : '';
    }
  
    function ansClass(v){
      if (!v || v === '未回答') return 'stat-na';
      if (v === '未定')        return 'stat-pd';
      if (v === '参加')        return 'stat-ok';
      if (v === '欠席')        return 'stat-ng';
      return 'stat-na';
    }
  
    /* ====== バッジ判定（要件準拠） ======
       ① 回答済み       : names 全員が「参加」or「欠席」
       ② 未回答         : names 全員が回答登録なし（＝回答0件）
       ③ 一部未回答     : 参加/欠席の回答はあるが、未登録者がいる（未定の人がいれば④に上書き）
       ④ 未定あり       : 1人でも「未定」がいれば最優先で未定あり（他の人の状態は不問）
    ====================================== */
    function summarizeForNames(answerList){
      const namesCnt = S.names.length;
      const list = Array.isArray(answerList) ? answerList : [];
  
      let hasPending = false;
      let decidedCnt = 0; // 参加/欠席の人数
  
      for (const a of list){
        const v = (a?.answer || '').trim();
        if (v === '未定') { hasPending = true; }
        if (v === '参加' || v === '欠席') decidedCnt++;
      }
  
      // ④ 未定あり（最優先）
      if (hasPending) return { label:'未定あり', cls:'stat-pd', key:'pending' };
  
      // names が未登録なら未回答扱い（フォーム未作成の意味合い）
      if (namesCnt === 0) return { label:'未回答', cls:'stat-na', key:'na' };
  
      // ② 未回答（誰も参加/欠席を選んでいない）
      if (decidedCnt === 0) return { label:'未回答', cls:'stat-na', key:'na' };
  
      // ① 全員が参加/欠席なら回答済
      if (decidedCnt >= namesCnt) return { label:'回答済', cls:'stat-ok', key:'done' };
  
      // ③ 上記いずれでもなく、参加/欠席はあるが欠けがある
      return { label:'一部未回答', cls:'stat-pd', key:'partial' };
    }
  
    function rowHtml(ev, sum){
      const dateStr  = ev.ymd || ev.date || '';
      const hm       = ev.hm || '';
      const place    = ev.place || ev.venue || '';
      const newBadge = (ev.isNew || ev.is_new) ? '<span class="badge-new">NEW</span>' : '';
      const dl       = ev.deadline || ev.limit || ev.deadlineYmd || '';
      const dlCls    = `deadline ${deadlineClass(dl)}`;
      const atMark   = place ? ' @' : '';
    
      return `
        <div class="eventRow" data-evt="${ev.id}">
          <div class="eventMeta">
    
            <!-- 1行目：左=出欠 / 右=NEW -->
            <div class="eventHead">
              <span class="pill sm ${sum.cls}">${sum.label}</span>
              ${newBadge}
            </div>
    
            <!-- 2行目：B案（場所のみ省略可能） -->
            <div class="eventTitle" title="${dateStr}${hm ? ` ${hm}` : ''}${atMark} ${place}">
              <span class="title-date">${dateStr}${hm ? ` <small>${hm}</small>` : ''}${atMark}</span>
              <span class="title-place">${place}</span>
            </div>
    
            <!-- 3行目：締切 -->
            <div class="eventSub">締切：<span class="${dlCls}">${dl || '—'}</span></div>
          </div>
        </div>
        <div class="eventDetail" data-detail="${ev.id}"></div>
      `;
    }
  
    function render(){
      const box = E.box();
      if (!box) return;
  
      // 昇順ソート（日付不明は末尾）
      const list = (S.events || []).slice().sort((a,b) => {
        const da = parseYmd(a.ymd || a.date) || new Date(8640000000000000);
        const db = parseYmd(b.ymd || b.date) || new Date(8640000000000000);
        return da - db;
      });
  
      const rows = [];
      for (const ev of list){
        const sum = summarizeForNames(S.ansMap[ev.id]);
        // 未回答のみ= 未回答/一部未回答/未定あり を通す
        if (S.onlyNA && !(sum.key === 'na' || sum.key === 'partial' || sum.key === 'pending')) continue;
        rows.push(rowHtml(ev, sum));
      }
      box.innerHTML = rows.length ? `<div class="evList">${rows.join('')}</div>`
                                  : '<div class="listEmpty">該当する公演はありません</div>';
  
      // 詳細（家族別チップ）Lazyレンダリング
      box.querySelectorAll('.eventRow').forEach(row => {
        row.addEventListener('click', (e) => {
          // pill（出欠バッジ）や NEW バッジはトグル対象から除外
          if (e.target.closest('.pill, .badge-new')) return;
      
          const id  = row.getAttribute('data-evt');
          const det = box.querySelector(`.eventDetail[data-detail="${id}"]`);
          if (!det) return;
          if (det.dataset.loaded !== '1'){
            const arr = S.ansMap[id] || [];
            det.innerHTML = `
              <div class="row" style="gap:6px; flex-wrap:wrap; padding:4px 2px 0 2px;">
                ${arr.map(m => {
                  const name = m?.name || m?.member || '';
                  const v    = m?.answer || '未回答';
                  return `<span class="pill sm ${ansClass(v)}" title="${v}">${name}</span>`;
                }).join('')}
              </div>`;
            det.dataset.loaded = '1';
          }
          row.classList.toggle('open');
          det.style.display = (det.style.display === 'block') ? 'none' : 'block';
        });
      });
    }
  
    // 「未回答のみ」
    document.addEventListener('DOMContentLoaded', () => {
      const n = E.ckN();
      if (n){
        n.checked = true;
        S.onlyNA  = true;
        n.addEventListener('change', () => { S.onlyNA = !!n.checked; render(); });
      }
    });
  
    /* 公開API */
    const API = {
      __v: 6,
      mount({events = [], myAnswersMap = {}, performers = []} = {}){
        S.events = Array.isArray(events) ? events : [];
        S.ansMap = myAnswersMap || {};
        S.names  = Array.isArray(performers) ? performers : [];
        const n = E.ckN(); if (n) S.onlyNA = !!n.checked;
        render();
      },
      setEvents(e){ S.events = e || []; render(); },
      setAnswers(a){ S.ansMap = a || {}; render(); },
      setPerformers(arr){ S.names = Array.isArray(arr) ? arr : []; render(); },
      render
    };
    window.HomeEventsUI = API;
    window.renderEventsDense = API.mount; // 互換
  
    /* ====== 自動ブート ======
       1) __HOME_EVENTS__/__HOME_ANSWERS__/__HOME_MEMBERS__ があれば mount
       2) 'home:data' カスタムイベント待機
       3) 300ms × 5秒ポーリング
    ===================================== */
    function tryMountFromGlobals(){
      const ev = window.__HOME_EVENTS__;
      const mp = window.__HOME_ANSWERS__;
      const nm = window.__HOME_MEMBERS__ || [];
      if (Array.isArray(ev) && mp && typeof mp === 'object'){
        API.mount({ events: ev, myAnswersMap: mp, performers: nm });
        return true;
      }
      return false;
    }
    window.addEventListener('home:data', (e)=>{
      const d = e.detail || {};
      API.mount({
        events: d.events || [],
        myAnswersMap: d.myAnswersMap || {},
        performers: d.performers || []
      });
    });
    if (!tryMountFromGlobals()){
      let waited = 0;
      const iv = setInterval(()=>{
        if (tryMountFromGlobals()) { clearInterval(iv); }
        else if ((waited += 300) > 5000) { clearInterval(iv); }
      }, 300);
    }
  
    /* ===== ブリッジ関数（既存ロジックから渡すだけ） =====
       window.renderHomeFromRaw(openList, myFamilyAnswers, membersArray?)
       - openList: state.events そのまま
       - myFamilyAnswers: [{eventId, name, answer}] の配列
       - membersArray: state.members そのまま or 省略可（window.state.members から拾う）
    -------------------------------------------------------- */
    window.renderHomeFromRaw = function(openList, myFamilyAnswers, membersArray){
      try {
        const events = (openList || []).map(x => ({
          id      : x.id ?? x.eventId ?? x.eid ?? '',
          ymd     : x.ymd ?? x.date ?? '',
          hm      : x.hm ?? x.time ?? '',
          place   : x.place ?? x.venue ?? x.location ?? '',
          deadline: x.deadline ?? x.limit ?? x.deadlineYmd ?? '',
          isNew   : (x.isNew === true) || (x.is_new === 'Y') || (x.new === true)
        }));
  
        const map = {};
        for (const a of (myFamilyAnswers || [])){
          const eid = a.eventId ?? a.id ?? a.eid ?? '';
          if (!eid) continue;
          if (!map[eid]) map[eid] = [];
          map[eid].push({
            name  : a.name ?? a.member ?? '',
            answer: (a.answer ?? '').trim() || '未回答'
          });
        }
  
        // 登録演奏者（期待人数の基準）
        const members = membersArray || (window.state && Array.isArray(window.state.members) ? window.state.members : []);
        const performers = Array.from(new Set(members.map(m => m.performerName).filter(Boolean)));
  
        window.__HOME_EVENTS__   = events;
        window.__HOME_ANSWERS__  = map;
        window.__HOME_MEMBERS__  = performers;
        window.renderEventsDense({ events, myAnswersMap: map, performers });
      } catch (err){
        console.error('renderHomeFromRaw failed:', err);
      }
    };
  })();
  </script>
<script>
/* ===== 設定 ===== */
const FRONT_VERSION = "Front v2.7.7";
const LIFF_ID = "2008020568-2jVl00Rn";         // ←差し替え
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbyD3Geb_NdR_OQfYof2uEz5LzkzVXNetV8-uoWlouSy_PlD6iATSau8InV_L0N1voMnwg/exec";     // ←差し替え

/* ===== 状態 ===== */
let state = {
  lineId: "",
  name: "",
  isAdmin: false,
  members: [],       // [{lineId,inputName,performerName}]
  events:  [],       // [{eventId,date,time,place,deadline,initialAt,isNew}]
  answers: {},       // { eventId: [...] }
  schedules: [],     // 今後の予定
  report:   [],      // 管理レポート（attendanceReport）
  submitting: false  
};

let registerMode = "create"; // "create" | "edit"
let adminMode = "create";    // "create" | "edit"（予定登録フォーム）
let adminEditingId = "";     // 編集対象ID
let adminItemsMap = {};      // 管理一覧の行データを保持するマップ（編集ボタンから参照）

/* ===== ドラフト（一時保存） ===== */
/* 保存スコープは lineId 単位。localStorage に永続化します */
let draft = { byEvent: {} }; // { [eventId]: { members: { [name]: "参加|欠席|未定|"" }, comment: "" } }

function draftStorageKey(){
  return `attDraft:${state.lineId || 'guest'}`;
}
function draftLoad(){
  try {
    const raw = localStorage.getItem(draftStorageKey());
    draft = raw ? JSON.parse(raw) : { byEvent:{} };
  } catch(_){
    draft = { byEvent:{} };
  }
}
function draftSave(){
  try { localStorage.setItem(draftStorageKey(), JSON.stringify(draft)); } catch(_){}
}
function draftClear(){
  draft = { byEvent:{} };
  draftSave();
}
function draftEnsure(evId){
  if (!draft.byEvent[evId]) {
    draft.byEvent[evId] = { members:{}, comment:"", commentTouched:false };
  } else {
    // 旧データからのマイグレーション（プロパティが無い場合に補完）
    if (!('commentTouched' in draft.byEvent[evId])) {
      draft.byEvent[evId].commentTouched = false;
    }
  }
  return draft.byEvent[evId];
}
function draftSetAttend(evId, name, attend){
  const d = draftEnsure(String(evId));
  if (attend) d.members[name] = attend; else delete d.members[name];
  draftSave();
}
function draftSetComment(evId, comment){
  const d = draftEnsure(String(evId));
  d.comment = comment || "";
  d.commentTouched = true;   // ★ コメントを触った（削除含む）ことを記録
  draftSave();
}
function draftGetAttend(evId, name){
  const d = draft.byEvent[String(evId)];
  return d && d.members ? (d.members[name] || "") : "";
}
function draftGetComment(evId){
  const d = draft.byEvent[String(evId)];
  return d ? (d.comment || "") : "";
}
function draftBuildPayloads(){
  // まとめて送信用に {eventId, performerName, attend, _eventComment(先頭のみ/触った時だけ)} を組み立て
  const result = [];
  for (const [eventId, block] of Object.entries(draft.byEvent || {})){
    const names = Object.keys(block.members || {});
    const touched = !!block.commentTouched;      // ★ 触ったかどうか
    if (names.length === 0 && !touched) continue; // 何も変更がないイベントは送らない

    const com = block.comment || "";
    names.forEach((name, idx)=>{
      const payload = {
        eventId,
        performerName: name,
        attend: block.members[name] || ""
      };
      // ★ コメントは「触った時だけ」先頭レコードに添付
      if (touched && idx === 0) {
        payload._eventComment = com;
      }
      result.push(payload);
    });
  }
  return result;
}

/* ===== 送信用補助（未保存バッジ/送信ボタン活性） ===== */
function hasAnyDraft(){
  const b = draft.byEvent || {};
  return Object.values(b).some(block =>
    (Object.keys(block.members || {}).length > 0) ||
    ((block.comment || "").trim() !== "")
  );
}
function markUnsavedBadge(eventId){
  const card = document.querySelector(`.fEvent[data-evt="${eventId}"]`);
  if (!card) return;
  const headRow = card.querySelector(".fTitleRow");
  if (!headRow) return;
  const cur = headRow.querySelector(".badge-unsaved");
  const dblock = draft.byEvent[String(eventId)];
  const need = !!dblock && (Object.keys(dblock.members||{}).length > 0 || (dblock.comment||"").trim() !== "");
  if (need && !cur){
    headRow.insertAdjacentHTML("beforeend", `<span class="badge-unsaved">未保存</span>`);
  }else if (!need && cur){
    cur.remove();
  }
}
function updateSubmitButton(){
  const btn = document.getElementById("btnSubmit");
  if (!btn) return;
  const has = hasAnyDraft();      // 何か1つでも未送信ドラフトがあるか
  btn.disabled = !has;            // ない場合は押せない（空送信防止）
  btn.textContent = "まとめて送信"; // ラベルは常に統一
}

/* ===== ユーティリティ ===== */
const $ = s => document.querySelector(s);
function show(id){ document.querySelectorAll("[data-view]").forEach(v=>v.classList.remove("show")); $(id).classList.add("show"); }
function logHome(t){ $("#homeLog").textContent = t||""; }
function logForm(t){ $("#formLog").textContent = t||""; }
function logReg(t){ $("#regLog").textContent = t||""; }
function logAdmin(t){ $("#adminFormLog").textContent = t||""; }

function z(n){ return String(n).padStart(2,"0"); }
function ymdDow(d){
  if (!(d instanceof Date) || isNaN(d)) return "";
  const yo = "日月火水木金土"[d.getDay()];
  return `${d.getFullYear()}/${z(d.getMonth()+1)}/${z(d.getDate())}（${yo}）`;
}
function hmFromTimeCell(v){
  const s = String(v||"").trim();
  const tryDate = new Date(s);
  if (!isNaN(tryDate)) return `${z(tryDate.getHours())}:${z(tryDate.getMinutes())}`;
  const m = s.match(/^(\d{1,2}):(\d{2})$/); 
  if (m) return `${z(m[1])}:${m[2]}`;
  return "";
}
// 厳密に日付文字列をパース
function parseYmdStrict(s){
  const m = String(s||"").match(/^(\d{4})[\/\-](\d{2})[\/\-](\d{2})$/);
  if (!m) {
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }
  const y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]);
  const dt = new Date(y, mo-1, d);
  return isNaN(dt) ? null : dt;
}
function esc(s){ return encodeURIComponent(String(s||"")); }
function toYmdSlashFromDateInput(v){ // "yyyy-mm-dd" -> "yyyy/MM/dd"
  if (!v) return "";
  const m = v.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  return m ? `${m[1]}/${m[2]}/${m[3]}` : "";
}
function toDateInputFromYmdSlash(v){ // "yyyy/MM/dd" -> "yyyy-mm-dd"
  const m = String(v||"").match(/^(\d{4})\/(\d{2})\/(\d{2})$/);
  return m ? `${m[1]}-${m[2]}-${m[3]}` : "";
}

/* Google Calendar 追加URL */
const DFLT_MIN = { "発表":90, "練習":150, "その他":60 };
function toDatesParam(ymdStr, hmStr, kind){
  const m = String(ymdStr||"").match(/^(\d{4})\/(\d{2})\/(\d{2})$/);
  if (!m) return "";
  const H = hmStr ? Number(hmStr.split(":")[0]) : 0;
  const M = hmStr ? Number(hmStr.split(":")[1]) : 0;
  const st = new Date(Number(m[1]), Number(m[2])-1, Number(m[3]), H, M, 0);
  const mins = DFLT_MIN[kind] || 60;
  const ed = new Date(st.getTime() + mins*60000);
  const fmt = (d)=>`${d.getFullYear()}${z(d.getMonth()+1)}${z(d.getDate())}T${z(d.getHours())}${z(d.getMinutes())}00`;
  return `${fmt(st)}/${fmt(ed)}`;
}
function makeGoogleCalUrl(title, ymd, hm, place, kind, memo){
  const base = "https://calendar.google.com/calendar/render?action=TEMPLATE";
  const dates = toDatesParam(ymd, hm, kind);
  const params = [
    `text=${esc(title)}`,
    dates ? `dates=${dates}` : "",
    place ? `location=${esc(place)}` : "",
    memo  ? `details=${esc(memo)}` : "",
    `ctz=${esc("Asia/Tokyo")}`
  ].filter(Boolean).join("&");
  return `${base}&${params}`;
}

/* ===== API ===== */
async function api(path){ const r = await fetch(API_ENDPOINT + path); return r.json(); }

/* ===== 初期化 ===== */
async function init(){
  try{
    $("#ver").textContent = FRONT_VERSION;

    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()){ liff.login(); return; }

    if (liff.getFriendship){
      try{
        const fr = await liff.getFriendship();
        if (fr && fr.friendFlag===false) $("#friendAlert").style.display="";
      }catch(_){}
    }

    const idt = liff.getDecodedIDToken();
    state.lineId = idt ? idt.sub : "";
    state.name   = idt && idt.name ? idt.name : "";
    $("#hello").textContent = state.name ? `こんにちは、${state.name} さん` : "";

    /* ★ lineIdが確定したら、ドラフトを復元 */
    draftLoad();

    bindHandlers();
    resetRegisterForm();

    // Admin 判定
    try{
      const j = await api(`?isAdmin=1&id=${esc(state.lineId)}`);
      state.isAdmin = (j.status==="ok" && !!j.isAdmin);
      // 管理カードの表示切替
      $("#adminMenu").style.display = state.isAdmin ? "" : "none";
    }catch(_){ state.isAdmin = false; $("#adminMenu").style.display="none"; }

    await refreshData();
  }catch(err){
    $("#eventsBox").innerHTML = `<span class="err">初期化に失敗しました: ${err.message||err}</span>`;
  }
}

/* ===== クリックバインド ===== */
function bindHandlers(){
  $("#btnReload").onclick      = async ()=>{ logHome("再読み込み中…"); await refreshData(); logHome(""); };
  $("#btnPrimary").onclick     = onPrimary;
  $("#btnEditNames").onclick   = onEditNames;
  $("#btnBackFromForm").onclick = () => {
    if (state.submitting) return;       // 送信中は遷移させない
    show("#view-home");
  };
  $("#btnBackFromReg").onclick = ()=> show("#view-home");
  $("#btnSubmit").onclick      = onSubmit;

  $("#btnAddPerf").onclick     = ()=> addPerformerField("");
  $("#btnRegister").onclick    = onRegister;

  $("#btnSchedules").onclick   = ()=>{ show("#view-schedules"); renderSchedules(true); };
  $("#btnBackFromSchedules").onclick = ()=> show("#view-home");
  $("#btnFetchSchedules").onclick    = ()=> renderSchedules(false);
  // レポート
  $("#btnReportBack").onclick = ()=> show("#view-home");
  $("#btnReportReload").onclick = ()=> reportReload();
  $("#repEvent").addEventListener("change", renderReport);
  $("#repAttend").addEventListener("change", renderReport);
  
  // 管理メニュー（HOME）
  $("#btnAdminMenuSchedules").onclick = ()=>{
    if (!state.isAdmin){ alert("管理者のみアクセス可能です"); return; }
    show("#view-admin");
    enterAdminCreateMode();
    adminListFetch();
  };
  $("#btnAdminMenuReport").onclick = ()=>{
    if (!state.isAdmin){ alert("管理者のみアクセス可能です"); return; }
    show("#view-admin-report");
    reportReload();
  };

  // 管理画面
  $("#btnAdminBack").onclick = ()=> show("#view-home");
  document.getElementById('btnAdminReload')
    ?.addEventListener('click', ()=> adminListFetch());
  $("#btnAdminFetch").onclick = ()=> adminListFetch();
  $("#btnAdminSubmit").onclick = ()=> adminSubmit();
  $("#btnAdminReset").onclick = ()=> enterAdminCreateMode();
  $("#ad_type").addEventListener("change", adminTypeChangeAdapt);
  
  // アコーディオン開閉（出欠フォームのスタイルを流用）
  const acc = document.getElementById('adminListAcc');
  acc?.querySelector('.fHead')?.addEventListener('click', ()=>{
    acc.classList.toggle('open');
  });
}

/* ===== データ読み直し（確定版） ===== */
async function refreshData(){
  $("#eventsBox").innerHTML  = `読み込み中… <span class="spinner"></span>`;
  $("#answersBox").innerHTML = `会員情報照会中… <span class="spinner"></span>`;
  $("#btnPrimary").textContent = "読み込み中..."; $("#btnPrimary").disabled = true;
  $("#btnEditNames").style.display = "none";

  // 1) イベント
  const ev = await api("?events=1");
  state.events = (ev.status==="ok" && Array.isArray(ev.events)) ? ev.events : [];

  // 2) 会員
  const w = await api(`?whoami=1&id=${esc(state.lineId)}`);
  state.members = (w.status==="ok" ? (w.members||[]) : []);

  // 3) 回答
  state.answers = {};
  if (state.events.length > 0){
    const ids = state.events.map(e=>e.eventId);
    const r = await api(`?getAttendanceAll=1&lineId=${esc(state.lineId)}&eventIds=${esc(JSON.stringify(ids))}`);
    if (r.status === "ok" && r.map) state.answers = r.map;
  }

  // 4) HomeEventsUI に“直接”渡す
  try{
    const events = (state.events || []).map(x => ({
      id      : String(x.eventId ?? x.id ?? ''),
      ymd     : ymdDow(parseYmdStrict(x.date)) || String(x.date || x.ymd || ''),
      hm      : hmFromTimeCell(x.time ?? x.hm ?? ''),
      place   : x.place ?? x.venue ?? x.location ?? '',
      deadline: String(x.deadline ?? x.limit ?? x.deadlineYmd ?? ''),
      isNew   : (x.isNew === true) || (x.is_new === 'Y') || (x.new === true)
    }));

    const myAnswersMap = {};
    for (const [eid, list] of Object.entries(state.answers || {})){
      myAnswersMap[String(eid)] = (list || []).map(r => ({
        name  : r.performerName,
        answer: (r.attend || '').trim() || '未回答'
      }));
    }

    const performers = Array.from(new Set(
      (state.members || []).map(m => m.performerName).filter(Boolean)
    ));

    if (window.HomeEventsUI){
      window.HomeEventsUI.mount({ events, myAnswersMap, performers });
    }else{
      console.warn('HomeEventsUI is not loaded yet');
    }
  }catch(e){
    console.error('HomeEventsUI.mount failed', e);
  }

  // 従来の下段 UI
  renderHome();

  // ボタンの復帰
  const hasMembers = state.members.length > 0;
  $("#btnPrimary").textContent = hasMembers ? "出欠を入力 / 変更する" : "初回登録に進む";
  $("#btnPrimary").disabled = false;
  $("#btnEditNames").style.display = hasMembers ? "" : "none";
}

/* ===== HOME描画 ===== */
function renderHome(){
  const hasMembers = state.members.length > 0;
  $("#btnPrimary").textContent = hasMembers ? "出欠を入力 / 変更する" : "初回登録に進む";
  $("#btnPrimary").disabled = false;
  $("#btnEditNames").style.display = hasMembers ? "" : "none";

  // トップでは answersBox 非表示仕様のまま（必要なら表示可能）
  const perfs = Array.from(new Set(state.members.map(m => m.performerName))).filter(Boolean);
  if (!hasMembers){
    $("#answersBox").innerHTML = `
      <div>まだ「初回登録」が済んでいません。</div>
      <div class="small">出欠の前に、入力者名と演奏者（家族分も可）の登録をしてください。</div>`;
    return;
  }
  if (state.events.length === 0){
    $("#answersBox").innerHTML = `<div class="muted">配信中の公演がありません</div>`;
    return;
  }
  // （ここは非表示カードなので最小限のままにしています）
  $("#answersBox").innerHTML = "";
}

/* ===== メインボタン ===== */
function onPrimary(){
  if (state.members.length === 0){
    registerMode = "create";
    resetRegisterForm();
    $("#regTitle").textContent = "初回登録（入力者 & 演奏者）";
    $("#btnRegister").textContent = "登録する";
    show("#view-register");
  } else {
    buildFormView();
    show("#view-form");
  }
}
function onEditNames(){
  registerMode = "edit";
  buildRegisterFormFromMembers();
  $("#regTitle").textContent = "氏名編集（入力者 & 演奏者）";
  $("#btnRegister").textContent = "保存";
  show("#view-register");
}

/* ===== 出欠フォーム（アコーディオン＋ドラフト） ===== */
// ▼ セレクト（参加/欠席/未定 + 初回のみplaceholder）を生成するユーティリティ
function renderAttendSelectHTML(evId, name, current){
  // current === "" のときだけ placeholder を表示（メニューには出さない）
  const placeholderOpt = (current === "")
    ? `<option value="" disabled hidden selected>（選択してください）</option>` : "";

  return `
    <select class="attSel selectBtn" data-event="${evId}" data-name="${name}">
      ${placeholderOpt}
      <option value="参加" ${current==="参加"?"selected":""}>参加</option>
      <option value="欠席" ${current==="欠席"?"selected":""}>欠席</option>
      <option value="未定" ${current==="未定"?"selected":""}>未定</option>
    </select>
  `;
}
/* ===== 出欠フォーム（アコーディオン＋ドラフト） ===== */
function buildFormView(){
  const boxHeader = $("#formEventsBox");
  const box = $("#formFields");
  box.innerHTML = "";
  boxHeader.innerHTML = `
    <span class="muted">
      イベントをタップして出欠を入力後、
      <span class="em-red">送信ボタンを押してください。</span>
    </span>`;

  if (!state.events.length){
    box.innerHTML = `<div class="muted">現在配信中の公演はありません</div>`;
    updateSubmitButton();
    return;
  }

  const performers = Array.from(new Set(state.members.map(m => m.performerName))).filter(Boolean);

  state.events.forEach(e=>{
    const ansList = state.answers[e.eventId] || [];
    const ansMap = {}; ansList.forEach(r => ansMap[r.performerName] = r);

    // 表示用
    const d = parseYmdStrict(e.date);
    const dateDisp = ymdDow(d);
    const timeDisp = hmFromTimeCell(e.time);
    const place = e.place || "";

    // 未保存有無
    const dblock = draft.byEvent[String(e.eventId)];
    const hasUnsaved = !!dblock && (
      Object.keys(dblock.members || {}).length > 0 ||
      (dblock.comment||"").trim() !== ""
    );

    // 1) ヘッダー
    const head = document.createElement("div");
    head.className = "fHead";
    head.innerHTML = `
      <div class="fTitle">
        <div class="fTitleRow" title="${dateDisp} ${timeDisp} @ ${place}">
          <span class="t-date">${dateDisp} <small>${timeDisp||""}</small> @</span>
          <span class="t-place">${place||""}</span>
          ${hasUnsaved ? `<span class="badge-unsaved">未保存</span>` : ``}
        </div>
      </div>
      <div class="fStatusRow">
        ${performers.map(name=>{
          const a = ansMap[name];
          let cls="stat-na", label="未回答";
          const v = draftGetAttend(e.eventId, name) || (a?.attend || "");
          if (v==="参加") cls="stat-ok", label="参加";
          else if (v==="欠席") cls="stat-ng", label="欠席";
          else if (v==="未定") cls="stat-pd", label="未定";
          return `<span class="pill sm ${cls}">${name}:${label}</span>`;
        }).join(" ")}
      </div>
      <div class="fSub">${e.deadline ? `締切：${e.deadline}` : "締切：—"}</div>
    `;

    // 2) ボディ（編集フォーム）
    const body = document.createElement("div");
    body.className = "fBody";
    body.innerHTML = `
      ${performers.map((name)=>{
        const current = draftGetAttend(e.eventId, name) || (ansMap[name]?.attend || "");
        return `
          <div class="row-att" style="border-top:1px dashed var(--c-border); padding-top:8px; margin-top:8px;">
            <span class="nameLabel">${name}</span>
            ${renderAttendSelectHTML(e.eventId, name, current)}
          </div>
        `;
      }).join("")}
      <div class="line"></div>
      <label>コメント（任意・100文字まで）</label>
      <input type="text" maxlength="100" class="evComment" data-event="${e.eventId}"
             value="${ draftGetComment(e.eventId) ||
                     (ansList.find(x => (x.comment||"").trim())?.comment || "")}">
    `;

    // 3) カード化 & イベント
    const card = document.createElement("div");
    card.className = "fEvent";
    card.setAttribute("data-evt", e.eventId);
    card.appendChild(head);
    card.appendChild(body);

    head.addEventListener("click", ()=>{
      card.classList.toggle("open");
    });

    box.appendChild(card);
  });

  // 入力監視（デリゲート）
  box.addEventListener("change", (ev)=>{
    const sel = ev.target.closest("select.attSel");
    if (!sel) return;
    const eid = sel.dataset.event;
    const name = sel.dataset.name;
    const val = sel.value;
    if (val === "") {
      // placeholder（未選択）＝ドラフトから除外（既存は保持）
      draftSetAttend(eid, name, "");
    } else {
      draftSetAttend(eid, name, val);
    }
    markUnsavedBadge(eid);
    updateSubmitButton();
  });

  box.addEventListener("input", (ev)=>{
    const c = ev.target.closest("input.evComment");
    if (!c) return;
    const eid = c.dataset.event;
    draftSetComment(eid, c.value);
    markUnsavedBadge(eid);
    updateSubmitButton();
  });

  updateSubmitButton();
}

/* ===== 出欠送信（ドラフト一括送信） ===== */
async function onSubmit(){
  if (state.submitting) return;
  state.submitting = true;
  const btn = $("#btnSubmit");
  const backBtn = $("#btnBackFromForm");
  btn.disabled = true; btn.textContent = "送信中…"; logForm("");
  if (backBtn) backBtn.disabled = true;

  const navGuard = (e) => {
    if (state.submitting) {
      e.preventDefault();
      e.returnValue = "";
    }
  };
  window.addEventListener("beforeunload", navGuard);

  try{
    const payloads = draftBuildPayloads();
    if (!payloads.length){ alert("送信する内容がありません（出欠の選択が未入力です）"); return; }

    // イベントIDでグループ化（＋コメント触ったかどうかを記録）
    const grouped = {};
    const eventCommentMap = {};          // eventId -> コメント文字列
    const touchedEventSet = new Set();   // コメントを触った eventId

    for (const p of payloads) {
      if (!grouped[p.eventId]) grouped[p.eventId] = [];
      grouped[p.eventId].push({ performerName: p.performerName, attend: p.attend });

      if (Object.prototype.hasOwnProperty.call(p, '_eventComment')) {
        // ★ コメントを「触った」イベントだけ拾う
        eventCommentMap[p.eventId] = (p._eventComment || "");
        touchedEventSet.add(p.eventId);
      }
    }

    // イベント単位で送信（merge=1 を付ける）
    for (const [eventId, list] of Object.entries(grouped)) {
      const eCom   = String(eventCommentMap[eventId] || "");
      const touched = touchedEventSet.has(eventId); // ★ 触った場合のみ comment キーを付与

      const bulk = list.map((it, idx) => {
        const row = { performerName: it.performerName, attend: it.attend };
        if (touched && idx === 0) row.comment = eCom;  // ★ 触っていれば先頭だけ comment キーを付与
        return row;
      });

      const url = `${API_ENDPOINT}?submitBulk=1`
                + `&eventId=${esc(eventId)}`
                + `&lineId=${esc(state.lineId)}`
                + `&merge=1`                        // ★ マージ更新を有効化
                + `&bulk=${esc(JSON.stringify(bulk))}`;

      const r = await fetch(url);
      const j = await r.json();
      if (j.status !== "ok") throw new Error(`送信失敗（${eventId}）: ${j.message||"unknown"}`);
    }

    alert("送信しました");
    draftClear(); // ★ 送信成功で下書きを破棄
    show("#view-home");
    logHome("更新中…");
    await refreshData();
    logHome("");

  }catch(err){
    logForm(err.message || String(err));
  }finally{
    state.submitting = false;
    btn.disabled = false; updateSubmitButton();
    if (backBtn) backBtn.disabled = false;
    window.removeEventListener("beforeunload", navGuard);
  }
}

/* ===== 初回登録 ===== */
function resetRegisterForm(){
  $("#regInputName").value = state.name || "";
  $("#perfList").innerHTML = "";
  addPerformerField("");
}
function buildRegisterFormFromMembers(){
  const inputName = (state.members[0]?.inputName || state.name || "");
  $("#regInputName").value = inputName;
  $("#perfList").innerHTML = "";
  const names = Array.from(new Set(state.members.map(m=>m.performerName))).filter(Boolean);
  if (names.length === 0) {
    addPerformerField("");
  } else {
    names.forEach(n=> addPerformerField(n));
  }
}
function addPerformerField(value=""){
  const id = "perf_" + Math.random().toString(36).slice(2);
  const row = document.createElement("div");

  // ここを perfRow（Grid レイアウト）に変更
  row.className = "perfRow";

  row.innerHTML = `
    <label for="${id}" class="perfLabel">演奏者名</label>
    <input type="text" id="${id}" class="regPerf" value="${value||""}" placeholder="例：藤塚 太郎">
    <button type="button" class="btn btn-remove btn-sm"
            onclick="this.closest('.perfRow').remove()"
            aria-label="この演奏者を削除">削除</button>
  `;
  document.getElementById("perfList").appendChild(row);
}
async function onRegister(){
  try{
    logReg("");
    const inputName = $("#regInputName").value.trim();
    if (!inputName) throw new Error("入力者氏名を入力してください");

    const names = Array.from(document.querySelectorAll(".regPerf"))
      .map(el => (el.value||"").trim())
      .filter(Boolean);

    const uniq = Array.from(new Set(names));
    if (uniq.length === 0) throw new Error("演奏者を1名以上入力してください");

    $("#btnRegister").disabled = true; $("#btnRegister").textContent = (registerMode==="edit" ? "保存中…" : "登録中…");

    let url = "";
    if (registerMode === "edit") {
      url = `${API_ENDPOINT}?replaceMembers=1&lineId=${esc(state.lineId)}&inputName=${esc(inputName)}&list=${esc(JSON.stringify(uniq))}&purge=0`;
    } else {
      url = `${API_ENDPOINT}?registerBulk=1&lineId=${esc(state.lineId)}&inputName=${esc(inputName)}&list=${esc(JSON.stringify(uniq))}`;
    }

    const r = await fetch(url); const j = await r.json();
    if (j.status !== "ok") throw new Error(j.message || "登録に失敗しました");

    alert(registerMode==="edit" ? "氏名を保存しました" : "初回登録が完了しました");
    show("#view-home");
    logHome("更新中…");
    await refreshData();
    logHome("");

  }catch(err){
    logReg(err.message || String(err));
  }finally{
    $("#btnRegister").disabled = false; $("#btnRegister").textContent = (registerMode==="edit" ? "保存" : "登録する");
  }
}

/* ===== 今後の予定（Schedules） ===== */
async function renderSchedules(initial=false){
  const box = $("#schedulesBox");
  box.innerHTML = `読み込み中… <span class="spinner"></span>`;

  try{
    const days = Number($("#selDays").value || 60);
    const kind = $("#selKind").value || "";

    const url = kind
      ? `?schedules=1&days=${esc(days)}&kind=${esc(kind)}`
      : `?schedules=1&days=${esc(days)}`;

    const r = await api(url);
    if (r.status !== "ok" || !Array.isArray(r.schedules)) {
      box.innerHTML = `<span class="err">取得に失敗しました</span>`;
      return;
    }
    state.schedules = r.schedules;

    if (!state.schedules.length){
      box.innerHTML = `<div class="listEmpty">該当する予定はありません</div>`;
      return;
    }
     // 先頭の案内文は非表示（出力しない）
    // const feedUrl = `${API_ENDPOINT}?icsFeed=1`;
    // let html = `<div class="small muted" style="margin-bottom:8px;">
    //   ・各予定から「Googleカレンダー」/「iOS(ICS)」に追加できます。購読（自動反映）は下のリンクから登録してください。
    // </div>`;
    let html = "";
    
    html += state.schedules.map(it=>{
      return `<div class="card">
        <div><b>${it.date} ${it.time||""}</b> @ ${it.place||""}</div>
        <div class="small muted">${it.kind||""} ${it.title||""}</div>
        ${it.memo?`<div class="small">${it.memo}</div>`:""}
      </div>`;
    }).join("");

   // html += `
   //   <div class="card" style="margin-top:12px;">
   //     <div class="sectionTitle" style="margin:0 0 8px;">購読（自動反映）</div>
   //     <div class="small muted">以下のURLをカレンダーアプリの「カレンダーを購読」等の項目に貼り付けてください。</div>
   //     <div class="row" style="margin-top:6px; gap:8px; flex-wrap:wrap;">
   //       <input type="text" id="icsFeedUrl" value="${feedUrl}" style="flex:1; min-width:240px;" readonly>
   //       <button class="ghost" onclick="copyIcsFeed()">コピー</button>
   //       <button class="ghost" onclick="window.open('${feedUrl}','_blank')">開く</button>
   //     </div>
   //     <div class="small muted" style="margin-top:6px;">
   //       ※ Googleカレンダーに購読を追加する場合は、Googleカレンダーの「他のカレンダー」→「URL で追加」から登録してください。
   //     </div>
   //   </div>
   // `;

    box.innerHTML = html;

  }catch(err){
    box.innerHTML = `<span class="err">エラー: ${err.message||err}</span>`;
  }
}
function copyIcsFeed(){
  const ipt = $("#icsFeedUrl");
  ipt.select();
  document.execCommand("copy");
  alert("購読URLをコピーしました");
}

/* ===== 予定登録（管理者） ===== */
// 種別変更に応じて UI を制御（練習=集合場所/配信フラグ/締切日も無効化）
function adminTypeChangeAdapt(){
  const t = $("#ad_type").value;
  const meetAt     = $("#ad_meetAt");
  const meetPlace  = $("#ad_meetPlace");
  const attend     = $("#ad_attendTarget");
  const deadline   = $("#ad_deadline");
  const flagSel    = $("#ad_flag");
  const hm         = $("#ad_hm");
  const place      = $("#ad_place");

  // ユーザーが手で触ったら「自動入力フラグ」を解除
  hm?.addEventListener('input',   ()=> hm.dataset.autofilled   = "0", { once:true });
  place?.addEventListener('input',()=> place.dataset.autofilled= "0", { once:true });

  if (t === "練習"){
    // 無効化（色はCSSで統一）
    $("#ad_meetAt").value    = "";  meetAt.disabled    = true;
    $("#ad_meetPlace").value = "";  meetPlace.disabled = true;
    attend.value = "N";             attend.disabled    = true;
    $("#ad_deadline").value  = "";  deadline.disabled  = true;
    updateFlagOptions({ type:t, forceN:true, disable:true });

    // ★ デフォルト自動入力（未入力のときだけ）
    if (hm && !hm.value){
      hm.value = "17:15";
      hm.dataset.autofilled = "1";
    }
    if (place && !place.value){
      place.value = "藤塚小学校体育館";
      place.dataset.autofilled = "1";
    }

  } else if (t === "発表"){
    meetAt.disabled    = false;
    meetPlace.disabled = false;
    attend.disabled    = false;
    deadline.disabled  = false;
    updateFlagOptions({ type:t, forceN:false, disable:false });

    // ★ 練習以外に戻したとき：自動入力だった分だけクリア
    if (hm?.dataset.autofilled === "1"){ hm.value = ""; }
    if (place?.dataset.autofilled === "1"){ place.value = ""; }
    if (hm) hm.dataset.autofilled = "0";
    if (place) place.dataset.autofilled = "0";

  } else { // その他
    meetAt.disabled    = false;
    meetPlace.disabled = false;
    attend.value       = "N";
    attend.disabled    = true;
    deadline.disabled  = false;
    updateFlagOptions({ type:t, forceN:true, disable:true });

    // ★ 同上：自動入力だった分だけクリア
    if (hm?.dataset.autofilled === "1"){ hm.value = ""; }
    if (place?.dataset.autofilled === "1"){ place.value = ""; }
    if (hm) hm.dataset.autofilled = "0";
    if (place) place.dataset.autofilled = "0";
  }
}
// 配信フラグ選択肢の差し替え（新規=Y/Nのみ、編集=Y/S/D/N）/ 非発表はN固定
function updateFlagOptions({ type, forceN=false, disable=false }){
  const sel = $("#ad_flag");
  const cur = sel.value || "N";
  sel.innerHTML = ""; // いったん空に

  const opt = (v, label)=> {
    const o = document.createElement("option");
    o.value = v; o.textContent = label;
    sel.appendChild(o);
  };

  if (type === "発表" && !forceN){
    if (adminMode === "create"){
      opt("N","N");
      opt("Y","Y（初回配信対象）");
    }else{
      opt("N","N");
      opt("Y","Y（初回配信対象）");
      opt("S","S（初回配信済）");
      opt("D","D（締切超過/締切停止）");
    }
  }else{
    opt("N","N");
  }

  const allowed = Array.from(sel.options).map(o=>o.value);
  sel.value = allowed.includes(cur) ? cur : "N";
  sel.disabled = !!disable;
}

function enterAdminCreateMode(){
  adminMode = "create";
  adminEditingId = "";
  $("#adminFormTitle").textContent = "新規登録";
  $("#adminEditingId").style.display = "none";
  $("#btnAdminSubmit").textContent = "新規登録";
  $("#ad_title").value = "";
  $("#ad_type").value = "";
  $("#ad_ymd").value = "";
  $("#ad_hm").value = "";
  $("#ad_place").value = "";
  $("#ad_meetAt").value = "";
  $("#ad_meetPlace").value = "藤塚小学校";
  $("#ad_attendTarget").value = "N";
  $("#ad_deadline").value = "";
  $("#ad_publish").value = "Yes";
  $("#ad_status").value = "active";
  $("#ad_flag").innerHTML = `<option value="N" selected>N</option><option value="Y">Y（初回配信対象）</option>`;
  $("#ad_flag").value = "N";
  adminTypeChangeAdapt();
  logAdmin("");
}
function fillAdminFormFromItem(it){
  adminMode = "edit";
  adminEditingId = it.id || "";
  $("#adminFormTitle").textContent = `編集：${adminEditingId}`;
  $("#adminEditingId").style.display = "";
  $("#adminEditingId").textContent = `ID: ${adminEditingId}`;
  $("#btnAdminSubmit").textContent = "保存";

  $("#ad_title").value = it.title || "";
  $("#ad_type").value  = it.type || "";
  $("#ad_ymd").value   = toDateInputFromYmdSlash(it.ymd || "");
  $("#ad_hm").value    = it.hm || "";
  $("#ad_place").value = it.place || "";
  $("#ad_meetAt").value = it.meetAt || "";
  $("#ad_meetPlace").value = it.meetPlace || "";
  $("#ad_attendTarget").value = (it.attendTarget||"N");
  $("#ad_deadline").value = toDateInputFromYmdSlash(it.deadline || "");
  $("#ad_publish").value = it.publish || "Yes";
  $("#ad_status").value  = it.status  || "active";

  adminTypeChangeAdapt();
  $("#ad_flag").value = it.flag || "N";
  if (![...$("#ad_flag").options].map(o=>o.value).includes($("#ad_flag").value)){
    $("#ad_flag").value = "N";
  }
  logAdmin("");
}
async function adminSubmit(){
  try{
    if (!state.isAdmin){ alert("管理者のみ利用できます"); return; }
    logAdmin("");

    const type  = $("#ad_type").value.trim();
    const title = $("#ad_title").value.trim();
    const ymdIn = $("#ad_ymd").value.trim();   // yyyy-mm-dd
    const hm    = $("#ad_hm").value.trim();
    const place = $("#ad_place").value.trim();
    const meetAt= $("#ad_meetAt").value.trim();
    const meetPl= $("#ad_meetPlace").value.trim();
    const attT  = $("#ad_attendTarget").value.trim().toUpperCase();
    const dlIn  = $("#ad_deadline").value.trim();
    const pub   = $("#ad_publish").value.trim();
    const st    = $("#ad_status").value.trim();
    const flag  = $("#ad_flag").value.trim();

    if (!title || !type || !ymdIn){ throw new Error("タイトル/種別/公演日は必須です"); }

    if (type === "発表"){
      const allowed = (adminMode==="create") ? ["Y","N"] : ["Y","S","D","N"];
      if (!flag || !allowed.includes(flag)){
        throw new Error(adminMode==="create"
          ? "配信フラグは Y または N を選択してください（発表/新規）"
          : "配信フラグは Y/S/D/N から選択してください（発表/編集）"
        );
      }
    }

    let meetAtSend = meetAt, meetPlSend = meetPl, attSend = attT, dlSend = dlIn;
    if (type==="練習"){
      meetAtSend = ""; meetPlSend = ""; attSend = "N"; dlSend = "";
    }
    if (type!=="発表"){ attSend = "N"; }

    const ymd = toYmdSlashFromDateInput(ymdIn);
    const dl  = dlSend ? toYmdSlashFromDateInput(dlSend) : "";

    $("#btnAdminSubmit").disabled = true;
    $("#btnAdminSubmit").textContent = (adminMode==="edit" ? "保存中…" : "登録中…");

    let res;
    if (adminMode === "create"){
      const url = `?adminUpsertSchedule=1&lineId=${esc(state.lineId)}`
        + `&type=${esc(type)}&title=${esc(title)}&ymd=${esc(ymd)}`
        + (hm?`&hm=${esc(hm)}`:"")
        + (place?`&place=${esc(place)}`:"")
        + (meetAtSend?`&meetAt=${esc(meetAtSend)}`:"")
        + (meetPlSend?`&meetPlace=${esc(meetPlSend)}`:"")
        + `&attendTarget=${esc(attSend)}`
        + (dl?`&deadline=${esc(dl)}`:"")
        + `&publish=${esc(pub)}&status=${esc(st)}&flag=${esc(flag)}`;
      res = await api(url);
      if (res.status!=="ok") throw new Error(res.message||"登録に失敗しました");
      alert(`登録しました（ID: ${res.id || "(不明)"}）`);
      enterAdminCreateMode();
      await adminListFetch();

    } else {
      if (!adminEditingId){ throw new Error("編集対象IDが不正です"); }
      const url = `?adminUpsertSchedule=1&lineId=${esc(state.lineId)}&id=${esc(adminEditingId)}`
        + `&type=${esc(type)}&title=${esc(title)}&ymd=${esc(ymd)}`
        + (hm?`&hm=${esc(hm)}`:"")
        + (place?`&place=${esc(place)}`:"")
        + (meetAtSend?`&meetAt=${esc(meetAtSend)}`:"")
        + (meetPlSend?`&meetPlace=${esc(meetPlSend)}`:"")
        + `&attendTarget=${esc(attSend)}`
        + (dl?`&deadline=${esc(dl)}`:"")
        + `&publish=${esc(pub)}&status=${esc(st)}&flag=${esc(flag)}`;
      res = await api(url);
      if (res.status!=="ok") throw new Error(res.message||"保存に失敗しました");
      alert("保存しました");
      await adminListFetch();
    }
  }catch(err){
    logAdmin(err.message || String(err));
  }finally{
    $("#btnAdminSubmit").disabled = false;
    $("#btnAdminSubmit").textContent = (adminMode==="edit" ? "保存" : "新規登録");
  }
}
async function adminListFetch(){
  try{
    const top = document.getElementById('adminListBoxTop');
    // ⑥で下部一覧を削除しているため、#adminListBox は存在しない想定
    if (top) top.innerHTML = `読み込み中… <span class="spinner"></span>`;

    const days = Number($("#ad_days").value || 60);
    const r = await api(`?adminListSchedules=1&lineId=${esc(state.lineId)}&days=${esc(days)}`);
    if (r.status !== "ok" || !Array.isArray(r.items)){
      if (top) top.innerHTML = `<span class="err">取得に失敗しました</span>`;
      return;
    }
    if (r.items.length === 0){
      if (top) top.innerHTML = `<div class="listEmpty">該当する予定はありません</div>`;
      return;
    }

    // ★ マップを初期化して、ID→オブジェクト を保存
    adminItemsMap = {};

    const html = r.items.map(raw=>{
      const it = {
        id: raw.id || "",
        type: raw.type || "",
        title: raw.title || "",
        ymd: raw.ymd || "",
        hm: raw.hm || "",
        place: raw.place || "",
        meetAt: raw.meetAt || "",
        meetPlace: raw.meetPlace || "",
        attendTarget: raw.attendTarget || "N",
        deadline: raw.deadline || "",
        publish: raw.publish || "No",
        status: raw.status || "archived",
        flag: raw.flag || "N"
      };
      // マップへ退避（ボタンからはIDのみ参照）
      adminItemsMap[String(it.id)] = it;

      return `<div class="card">
        <div><b>${it.ymd}${it.hm?` ${it.hm}`:""}</b> @ ${it.place||""}</div>
        <div class="small">${it.type||""}：${it.title||""}</div>
        <div class="small muted">出欠対象:${it.attendTarget||"N"} / 期限:${it.deadline||"(なし)"} / 公開:${it.publish||"No"} / 状態:${it.status||"archived"} / 配信:${it.flag||"N"}</div>
        <div class="row" style="margin-top:8px; justify-content:flex-end;">
          <button class="btn btn-ghost btn-edit" type="button" data-id="${String(it.id)}">編集</button>
        </div>
      </div>`;
    }).join("");

    if (top) top.innerHTML = html;

    // ★ 編集ボタンのイベントを安全にバインド（JSONは埋め込まない）
    document.querySelectorAll('#adminListAcc .btn-edit').forEach(btn=>{
      btn.addEventListener('click', (ev)=>{
        ev.preventDefault();
        ev.stopPropagation(); // アコーディオン開閉への伝播を止める
        const id = btn.getAttribute('data-id') || "";
        const obj = adminItemsMap[id];
        if (!obj){ console.warn('admin item not found for id:', id); return; }
        adminEdit(obj); // ここでフォームに反映＆アコーディオン閉じ
      });
    });

  }catch(err){
    const msg = `<span class="err">エラー：${err.message||err}</span>`;
    const topEl = document.getElementById('adminListBoxTop');
    if (topEl) topEl.innerHTML = msg;
  }
}
function adminEdit(obj){
  // （アコーディオンを閉じる）
  document.getElementById('adminListAcc')?.classList.remove('open');
  fillAdminFormFromItem(obj);
  window.scrollTo({ top:0, behavior:"smooth" });
}

/* ===== 出欠結果一覧（管理者） ===== */
async function reportReload(){
  $("#repBox").innerHTML = `読み込み中… <span class="spinner"></span>`;
  try{
    const r = await api(`?attendanceReport=1&lineId=${esc(state.lineId)}`);
    if (r.status!=="ok" || !Array.isArray(r.list)){
      $("#repBox").innerHTML = `<span class="err">取得に失敗しました</span>`;
      return;
    }
    state.report = r.list; // [{id, ymd, time, title, place, flag, accepting, rows:[...]}]

    // 公演セレクトを構築
    const sel = $("#repEvent");
    sel.innerHTML = `<option value="">（選択してください）</option>`;
    const items = [...state.report].sort((a,b)=> 
      (String(a.ymd||"").localeCompare(b.ymd||"") || String(a.time||"").localeCompare(b.time||"") || String(a.title||"").localeCompare(b.title||""))
    );
    for (const e of items){
      const label = `${e.ymd || ""}${e.time ? " " + e.time : ""}  ${e.title || ""}`;
      const opt = document.createElement("option");
      opt.value = e.id;
      opt.textContent = label;
      sel.appendChild(opt);
    }

    $("#repBox").innerHTML = `公演を選択してください`;

  }catch(err){
    $("#repBox").innerHTML = `<span class="err">エラー：${err.message||err}</span>`;
  }
}
function renderReport(){
  const box = $("#repBox");
  if (!state.report || state.report.length===0){
    box.innerHTML = `<div class="listEmpty">データがありません。再取得してください。</div>`;
    return;
  }

  const selId = $("#repEvent").value; // 公演ID
  const fAtt  = $("#repAttend").value; // 出欠フィルタ

  if (!selId){
    box.innerHTML = `公演を選択してください`;
    return;
  }

  const ev = state.report.find(x => String(x.id) === String(selId));
  if (!ev){
    box.innerHTML = `<div class="listEmpty">選択した公演が見つかりません</div>`;
    return;
  }

  let rows = Array.isArray(ev.rows) ? ev.rows : [];
  if (fAtt) rows = rows.filter(r => (r.attend||"") === fAtt);

  if (rows.length === 0){
    box.innerHTML = `<div class="listEmpty">該当データがありません</div>`;
    return;
  }

  rows.sort((a,b)=> (String(a.name||"").localeCompare(String(b.name||"")) || String(a.answeredAt||"").localeCompare(String(b.answeredAt||""))));

  const dateDisp = `${ev.ymd || ""}${ev.time ? " " + ev.time : ""}`;
  const header = `
    <div class="card">
      <div class="row-space">
        <div><b>${dateDisp}</b> @ ${ev.place||""}</div>
        <div><span class="tag ${ev.accepting==="open"?"open":"closed"}">${ev.accepting==="open"?"受付中":"受付終了"}</span></div>
      </div>
      <div class="small muted">${ev.title||""} <span class="small muted">（ID: ${ev.id}）</span></div>
    </div>
  `;

  const body = rows.map(r=>{
    return `<div class="card">
      <div class="row" style="justify-content:space-between;">
        <div><span class="pill">${r.name||""}</span></div>
        <div><span class="pill sm ${
          r.attend==="参加" ? "stat-ok" : r.attend==="欠席" ? "stat-ng" : r.attend==="未定" ? "stat-pd" : "stat-na"
        }">${r.attend||"未回答"}</span></div>
      </div>
      ${r.comment?`<div class="small" style="margin-top:4px;">コメント：${r.comment}</div>`:""}
      ${r.answeredAt?`<div class="small muted" style="margin-top:4px;">回答：${r.answeredAt}</div>`:""}
    </div>`;
  }).join("");

  box.innerHTML = header + body;
}

/* ===== 起動 ===== */
init();
</script>
</body>
</html>
