<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>公演 出欠フォーム</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{
      --c-primary:#0b74de; --c-bg:#fafafa; --c-border:#e5e5e5;
      --c-text:#222; --c-muted:#666; --c-ok:#0a7; --c-err:#c33;
      --c-accent:#ff6b6b;
    }
    body{ font-family: system-ui, -apple-system, Segoe UI, sans-serif; margin:0; background:var(--c-bg); color:var(--c-text);}
    header{ padding:14px 16px; font-size:18px; font-weight:700; background:#fff; border-bottom:1px solid var(--c-border); display:flex; justify-content:space-between; align-items:center;}
    main{ padding:14px 16px; }
    .ver{ font-size:12px; color:#888; font-weight:500; }
    .card{ background:#fff; border:1px solid var(--c-border); border-radius:12px; padding:12px; margin:10px 0; }
    .muted{ color:var(--c-muted); font-size:13px; }
    .row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .row-space{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    button{ appearance:none; border:none; border-radius:10px; padding:10px 14px; background:var(--c-primary); color:#fff; font-size:16px; }
    button.ghost{ background:#f4f4f4; color:#222; border:1px solid var(--c-border); }
    button.warn{ background:#ffb703; color:#222; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .ok{ color:var(--c-ok); }
    .err{ color:var(--c-err); }
    .sectionTitle{ font-weight:700; margin:8px 0; }
    .line{ height:1px; background:var(--c-border); margin:10px 0; }
    .warnBox{ background:#fff7d6; border:1px solid #f3d27a; padding:10px; border-radius:10px; color:#7a5b00; }
    .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#f5f5f5; border:1px solid var(--c-border); }
    .right{ text-align:right; }
    .badge{ display:inline-block; font-size:12px; padding:2px 6px; background:var(--c-accent); color:#fff; border-radius:999px; margin-left:8px; }
    .small{ font-size:12px; color:var(--c-muted); }

    [data-view]{ display:none; }
    [data-view].show{ display:block; }

    .spinner{ width:18px; height:18px; border:2px solid #ddd; border-top-color:var(--c-primary); border-radius:50%; animation:spin 1s linear infinite; display:inline-block; vertical-align:middle; }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    label{ display:block; font-size:14px; margin:6px 0 4px; }
    input[type="text"], input[type="date"], select, textarea{
      width:100%; border:1px solid var(--c-border); border-radius:8px; padding:8px; font-size:15px; background:#fff;
    }
    .listEmpty{ color:#888; font-size:14px; }

    /* NEW バッジ（既に入っていれば不要） */
    .badge{
      display:inline-block;
      margin-left:6px;
      padding:2px 6px;
      font-size:12px;
      color:#fff;
      background:#e53935;
      border-radius:999px;
      vertical-align:middle;
    }
    
    /* 小さめのピルと状態色 */
    .pill.sm { font-size:12px; padding:2px 8px; }
    .stat-ok  { background:#e8f8f3; border:1px solid #cdeee4; color:#0a7; }   /* 参加 */
    .stat-ng  { background:#fdeaea; border:1px solid #f6cccc; color:#c33; }   /* 欠席 */
    .stat-pd  { background:#fff7d6; border:1px solid #f3d27a; color:#7a5b00;} /* 未定 */
    .stat-na  { background:#f5f5f5; border:1px solid var(--c-border); color:#666;} /* 未回答 */

    .evHeader{ display:flex; align-items:center; gap:8px; font-weight:700; }
    .evMeta{ font-size:12px; color:#666; }
    .nameRow{ display:flex; align-items:center; gap:8px; margin:6px 0; }
    .name{ min-width:6em; font-weight:600; }
    .radios{ display:flex; gap:6px; flex-wrap:wrap; }
    .radios label{ display:inline-flex; align-items:center; gap:4px; margin:0; }
    .commentInput{ margin-left:calc(6em + 8px); }

    .icsRow{ display:flex; flex-wrap:wrap; gap:6px; }

    .skeleton{ background:linear-gradient(90deg, #f0f0f0 25%, #fafafa 37%, #f0f0f0 63%); animation: shimmer 1.4s infinite; border-radius:8px; height:14px; }
    @keyframes shimmer{ 0%{ background-position: -300px 0 } 100%{ background-position: 300px 0 } }
  </style>
</head>
<body>
<header>
  <div>公演 出欠フォーム</div>
  <div class="ver" id="ver"></div>
</header>
<main>

  <!-- 友だち未追加アラート（LIFF.getFriendship対応端末のみ） -->
  <div id="friendAlert" class="card warnBox" style="display:none;">
    このLIFFのBotが「友だち追加」されていません。通知を受け取るには公式アカウントを友だち追加してください。
  </div>

  <!-- ===== HOME ===== -->
  <section id="view-home" data-view class="show">
    <div id="hello" class="muted"></div>

    <div class="card">
      <div class="sectionTitle">現在配信中の公演</div>
      <div id="eventsBox" class="muted">読み込み中… <span class="spinner"></span></div>
    </div>

    <div class="card">
      <div class="sectionTitle">あなたの登録状況</div>
      <div id="answersBox" class="muted">会員情報照会中… <span class="spinner"></span></div>
    </div>

    <div class="row" style="margin-top:6px;">
      <button id="btnPrimary">読み込み中...</button>
      <button id="btnEditNames" class="ghost" style="display:none;">氏名を編集する</button>
      <button id="btnSchedules" class="ghost">今後の予定を見る</button>
      <button id="btnReload" class="ghost">再読み込み</button>
    </div>
    <div id="homeLog" class="muted" style="margin-top:8px;"></div>
  </section>

  <!-- ===== フォーム（出欠） ===== -->
  <section id="view-form" data-view>
    <div class="row-space">
      <div class="sectionTitle">出欠入力フォーム</div>
      <button id="btnBackFromForm" class="ghost">トップに戻る</button>
    </div>

    <div id="formEventsBox" class="card muted">公演読み込み中… <span class="spinner"></span></div>
    <div id="formFields"></div>

    <div class="line"></div>
    <div class="row right">
      <button id="btnSubmit">送信する</button>
    </div>
    <div id="formLog" class="muted" style="margin-top:8px;"></div>
  </section>

  <!-- ===== 初回登録/氏名編集 ===== -->
  <section id="view-register" data-view>
    <div class="row-space">
      <div class="sectionTitle" id="regTitle">初回登録（入力者 & 演奏者）</div>
      <button id="btnBackFromReg" class="ghost">トップに戻る</button>
    </div>

    <div class="card">
      <label for="regInputName">入力者氏名（あなたの名前）</label>
      <input type="text" id="regInputName" placeholder="例：山田 太郎"/>

      <div class="line"></div>
      <div class="row-space">
        <div class="sectionTitle" style="margin:0;">演奏者（家族も追加可）</div>
        <button id="btnAddPerf" class="ghost" type="button">＋ 演奏者を追加</button>
      </div>
      <div id="perfList"></div>
      <div class="small muted">※ あなた自身が演奏する場合は、演奏者としてあなたの名前も追加してください。</div>
    </div>

    <div class="row right">
      <button id="btnRegister">登録する</button>
    </div>
    <div id="regLog" class="muted" style="margin-top:8px;"></div>
  </section>

  <!-- ===== 今後の予定 ===== -->
  <section id="view-schedules" data-view>
    <div class="row-space">
      <div class="sectionTitle">今後の予定</div>
      <button id="btnBackFromSchedules" class="ghost">トップに戻る</button>
    </div>

    <div class="card">
      <div class="row" style="gap:12px;">
        <div>
          <label for="selDays">表示期間（日数）</label>
          <select id="selDays">
            <option value="30">30日</option>
            <option value="60" selected>60日</option>
            <option value="90">90日</option>
          </select>
        </div>
        <div>
          <label for="selKind">種別フィルタ</label>
          <select id="selKind">
            <option value="">（すべて）</option>
            <option value="発表">発表</option>
            <option value="練習">練習</option>
            <option value="その他">その他</option>
          </select>
        </div>
        <div style="align-self:flex-end;">
          <button id="btnFetchSchedules" class="ghost">再取得</button>
        </div>
      </div>
      <div id="schedulesBox" class="muted" style="margin-top:8px;">読み込み待機中</div>
    </div>

    <div class="small muted">
      ※ 予定はシート「Schedules（公開=Yes, ステータス=active）」から表示されます。<br>
      ※ 過去日と期間外の予定は自動的に表示から除外されます。
    </div>
  </section>

</main>

<script>
/* =========================
 * フロント設定（必ず差し替え）
 * ========================= */
const CONFIG = {
  LIFF_ID:  "2008020568-2jVl00Rn",            // ← 置き換え：LINE Developers の LIFF ID
  API_BASE: "https://script.google.com/macros/s/AKfycbzm9KdLyMmmhq789ygV9QuIl36Zmc3Ob4PzWEJJhrUOLHyi52jG6RchVx1FlFpfXsS1vg/exec" // ← 置き換え：GAS WebApp URL（/exec）
};

// バージョン
const FRONT_VERSION = "Front v0.8.2";

/* =========================
 * ユーティリティ
 * ========================= */
const qs = (sel, p=document) => p.querySelector(sel);
const qsa = (sel, p=document) => Array.from(p.querySelectorAll(sel));
function showView(id){
  qsa("[data-view]").forEach(x=>x.classList.remove("show"));
  qs(id).classList.add("show");
}
function logMsg(el, msg){ el.textContent = msg; }
function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
function isIOS(){
  const ua = navigator.userAgent.toLowerCase();
  return /iphone|ipad|ipod/.test(ua);
}
function toWebcal(url){
  try{
    if(!url) return "";
    return url.replace(/^https?:\/\//i, "webcal://");
  }catch(_){return url;}
}

/* =========================
 * LIFF & 状態
 * ========================= */
const State = {
  profile: null,         // { userId, displayName, pictureUrl }
  lineId: "",            // userId
  isFriend: null,        // true/false/null
  members: [],           // whoami結果 / Members参照
  events: [],            // events=1
  attendanceMap: {},     // getAttendanceAll map
};

async function initLiff(){
  await liff.init({ liffId: CONFIG.LIFF_ID });
  if (!liff.isLoggedIn()) liff.login();
  const prof = await liff.getProfile();
  State.profile = prof;
  State.lineId = prof?.userId || "";
  // 友だち状態（非対応環境は例外になる可能性）
  try{
    const f = await liff.getFriendship();
    State.isFriend = !!(f && f.friendFlag);
  }catch(_){
    State.isFriend = null;
  }
}

/* =========================
 * API 呼び出し
 * ========================= */
async function apiGet(params){
  const url = new URL(CONFIG.API_BASE);
  Object.entries(params||{}).forEach(([k,v]) => url.searchParams.set(k, v));
  const res = await fetch(url.toString(), { method:"GET", cache:"no-store" });
  if (!res.ok) throw new Error("HTTP " + res.status);
  const ct = res.headers.get("content-type") || "";
  if (ct.includes("application/json")) return await res.json();
  return await res.text();
}

/* =========================
 * 画面：HOME
 * ========================= */
async function renderHome(){
  qs("#ver").textContent = FRONT_VERSION;
  // 友だちアラート
  const friendBox = qs("#friendAlert");
  if (State.isFriend === false) friendBox.style.display = "";
  else friendBox.style.display = "none";

  const hello = qs("#hello");
  hello.textContent = `こんにちは、${State.profile?.displayName || "ユーザー"} さん`;

  const eventsBox = qs("#eventsBox");
  const answersBox = qs("#answersBox");
  const primary = qs("#btnPrimary");
  const editNames = qs("#btnEditNames");
  const homeLog = qs("#homeLog");

  eventsBox.innerHTML = `読み込み中… <span class="spinner"></span>`;
  answersBox.innerHTML = `会員情報照会中… <span class="spinner"></span>`;
  primary.disabled = true;
  primary.textContent = "読み込み中…";
  editNames.style.display = "none";
  homeLog.textContent = "";

  try{
    const [who, evs] = await Promise.all([
      apiGet({ whoami:"1", id: State.lineId }),
      apiGet({ events:"1" }),
    ]);
    if (who.status==="ok"){
      State.members = who.members || [];
      answersBox.innerHTML = renderMembersBox(State.members);
      primary.textContent = "出欠を入力する";
      primary.disabled = false;
      editNames.style.display = "";
    } else if (who.status==="new"){
      State.members = [];
      answersBox.innerHTML = `<div class="warnBox">まだ登録がありません。初回登録をお願いします。</div>`;
      primary.textContent = "初回登録へ";
      primary.disabled = false;
      editNames.style.display = "none";
    } else {
      answersBox.innerHTML = `<span class="err">会員情報の取得に失敗しました</span>`;
      primary.textContent = "やり直す";
      primary.disabled = false;
    }

    if (evs.status === "ok") {
      State.events = evs.events || [];
      if (!State.events.length){
        eventsBox.innerHTML = `<div class="listEmpty">配信中の公演はありません</div>`;
      } else {
        eventsBox.innerHTML = renderEventsBox(State.events);
      }
    } else {
      eventsBox.innerHTML = `<span class="err">公演一覧の取得に失敗しました</span>`;
    }
  } catch(err){
    console.error(err);
    eventsBox.innerHTML = `<span class="err">エラーが発生しました</span>`;
    answersBox.innerHTML = `<span class="err">エラーが発生しました</span>`;
    primary.textContent = "やり直す";
    primary.disabled = false;
    homeLog.textContent = String(err);
  }
}

function renderMembersBox(members){
  if (!members || !members.length){
    return `<div class="listEmpty">登録なし</div>`;
  }
  const inputName = members[0]?.inputName || "";
  const perfs = members.map(m => `<span class="pill">${escapeHtml(m.performerName)}</span>`).join(" ");
  return `
    <div>入力者：<b>${escapeHtml(inputName)}</b></div>
    <div style="margin-top:6px;">演奏者：${perfs || "（なし）"}</div>
  `;
}
function renderEventsBox(events){
  return events.map(e=>{
    const badgeNew = e.isNew ? `<span class="badge">NEW</span>` : "";
    const dl = e.deadline ? `<div class="small muted">締切：${escapeHtml(e.deadline)}</div>` : "";
    return `
      <div class="card">
        <div class="evHeader">
          <div>${escapeHtml(e.date)} ${escapeHtml(e.time||"")}</div>
          <div>＠ ${escapeHtml(e.place||"")}</div>
          ${badgeNew}
        </div>
        ${dl}
        <div class="small muted">ID: ${escapeHtml(e.eventId)}</div>
      </div>
    `;
  }).join("");
}

/* =========================
 * 画面：フォーム（出欠）
 * ========================= */
async function openForm(){
  showView("#view-form");
  const box = qs("#formEventsBox");
  const fields = qs("#formFields");
  const logEl = qs("#formLog");
  logEl.textContent = "";
  box.innerHTML = `公演読み込み中… <span class="spinner"></span>`;
  fields.innerHTML = "";

  try{
    // イベント取得（HOMEで既に取得済みなら流用）
    if (!State.events || !State.events.length) {
      const evs = await apiGet({ events:"1" });
      if (evs.status === "ok") State.events = evs.events || [];
      else State.events = [];
    }
    // 参加者（Members）取得（HOMEで取得済みを流用）
    const performers = dedupePerformers(State.members);

    if (!State.events.length){
      box.innerHTML = `<div class="listEmpty">配信中の公演はありません</div>`;
      return;
    }
    box.innerHTML = renderEventsBox(State.events);

    // 既存回答をまとめて取得（高速化）
    const ids = State.events.map(e=>e.eventId);
    const att = await apiGet({ getAttendanceAll:"1", lineId:State.lineId, eventIds: JSON.stringify(ids) });
    State.attendanceMap = (att.status==="ok" ? att.map : {}) || {};

    // 入力フィールド描画
    fields.innerHTML = State.events.map(ev => renderEventForm(ev, performers, State.attendanceMap[ev.eventId] || [])).join("");
  } catch(err){
    console.error(err);
    box.innerHTML = `<span class="err">公演読み込みでエラーが発生しました</span>`;
    qs("#formLog").textContent = String(err);
  }
}

function dedupePerformers(members){
  // 同じ演奏者氏名が複数行にまたがる可能性に対応
  const set = new Set();
  members.forEach(m => { if (m.performerName) set.add(m.performerName); });
  return Array.from(set);
}
function findPrevAnswer(prevRows, name){
  return (prevRows || []).find(r => r.performerName === name) || null;
}
function renderEventForm(ev, performers, prevRows){
  return `
    <div class="card" data-event-id="${escapeHtml(ev.eventId)}">
      <div class="evHeader">
        <div>${escapeHtml(ev.date)} ${escapeHtml(ev.time||"")}</div>
        <div>＠ ${escapeHtml(ev.place||"")}</div>
      </div>
      <div class="small muted">ID: ${escapeHtml(ev.eventId)}${ev.deadline?` ／ 締切：${escapeHtml(ev.deadline)}`:""}</div>
      <div class="line"></div>
      ${performers.map(name=>{
        const prev = findPrevAnswer(prevRows, name);
        const val = prev?.attend || "";
        const com = prev?.comment || "";
        const statClass = val==="参加"?"stat-ok":val==="欠席"?"stat-ng":val==="未定"?"stat-pd":"stat-na";
        return `
          <div class="nameRow">
            <div class="name">${escapeHtml(name)}</div>
            <div class="radios">
              ${["参加","欠席","未定"].map(opt=>{
                const checked = (opt===val)?"checked":"";
                return `
                  <label class="pill sm ${opt==="参加"?"stat-ok":opt==="欠席"?"stat-ng":"stat-pd"}">
                    <input type="radio" name="att-${escapeHtml(ev.eventId)}-${escapeHtml(name)}" value="${opt}" ${checked}>
                    <span>${opt}</span>
                  </label>`;
              }).join("")}
              ${!val?`<span class="pill sm stat-na">未回答</span>`:""}
            </div>
          </div>
          <div class="commentInput">
            <label>コメント（任意）</label>
            <textarea rows="2" data-comment="1" data-ev="${escapeHtml(ev.eventId)}" data-name="${escapeHtml(name)}" placeholder="備考など">${escapeHtml(com)}</textarea>
          </div>
        `;
      }).join("")}
    </div>
  `;
}

async function submitForm(){
  const logEl = qs("#formLog");
  logEl.textContent = "";
  const cards = qsa("#formFields .card[data-event-id]");
  if (!cards.length) { logEl.textContent = "送信対象がありません"; return; }

  try{
    // イベント毎に一括送信（submitBulk）
    for (const card of cards){
      const eventId = card.getAttribute("data-event-id");
      const rows = [];

      // このカード内の演奏者行を復元（nameRow）
      const nameRows = qsa(".nameRow", card);
      for (const nr of nameRows) {
        const name = nr.querySelector(".name")?.textContent?.trim() || "";
        if (!name) continue;

        const optSel = nr.querySelector(`input[type="radio"][name="att-${CSS.escape(eventId)}-${CSS.escape(name)}"]:checked`);
        const attend = optSel ? optSel.value : "";
        const ta = qs(`textarea[data-comment="1"][data-ev="${cssAttr(eventId)}"][data-name="${cssAttr(name)}"]`);
        const comment = ta ? ta.value.trim() : "";

        if (!attend) continue;
        rows.push({ performerName:name, attend, comment });
      }

      if (rows.length === 0) continue;

      const res = await apiGet({
        submitBulk: "1",
        eventId,
        lineId: State.lineId,
        bulk: JSON.stringify(rows)
      });
      if (res.status !== "ok"){
        throw new Error(`送信に失敗しました（eventId=${eventId}）`);
      }
    }
    logEl.innerHTML = `<span class="ok">送信しました。</span>`;
  }catch(err){
    console.error(err);
    logEl.innerHTML = `<span class="err">${escapeHtml(String(err))}</span>`;
  }
}
function cssAttr(s){ return String(s||"").replace(/"/g,'\\"'); }

/* =========================
 * 画面：登録（初回/氏名編集）
 * ========================= */
function openRegister(isEdit=false){
  showView("#view-register");
  qs("#regTitle").textContent = isEdit ? "氏名の編集" : "初回登録（入力者 & 演奏者）";
  const perfList = qs("#perfList");
  const regInput = qs("#regInputName");
  qs("#regLog").textContent = "";

  // 初期値：whoami の結果から
  const inputName = State.members?.[0]?.inputName || (State.profile?.displayName || "");
  regInput.value = inputName;

  perfList.innerHTML = "";
  const perfSet = dedupePerformers(State.members);
  if (perfSet.length){
    perfSet.forEach(nm => perfList.appendChild(buildPerfRow(nm)));
  } else {
    perfList.appendChild(buildPerfRow(""));
  }
}
function buildPerfRow(val){
  const div = document.createElement("div");
  div.className = "row";
  div.style.margin = "6px 0";
  div.innerHTML = `
    <input type="text" placeholder="演奏者氏名" value="${escapeHtml(val)}" style="flex:1;"/>
    <button type="button" class="ghost btnDelPerf">削除</button>
  `;
  div.querySelector(".btnDelPerf").addEventListener("click", ()=> div.remove());
  return div;
}
function addPerfRow(){
  qs("#perfList").appendChild(buildPerfRow(""));
}
async function submitRegister(){
  const logEl = qs("#regLog");
  logEl.textContent = "";
  const inputName = qs("#regInputName").value.trim();
  if (!inputName){ logEl.textContent = "入力者氏名を入力してください"; return; }

  const names = qsa("#perfList input[type=text]").map(i=>i.value.trim()).filter(Boolean);
  if (!names.length){ logEl.textContent = "演奏者を1名以上入力してください"; return; }

  try{
    const res = await apiGet({
      replaceMembers: "1",
      lineId: State.lineId,
      inputName,
      list: JSON.stringify(names),
      purge: "1"  // 以前の名前削除 → Attendanceからも削除
    });
    if (res.status !== "ok") throw new Error("登録に失敗しました");
    // 反映
    State.members = res.members || [];
    qs("#regLog").innerHTML = `<span class="ok">登録しました。</span>`;
    await sleep(500);
    await renderHome();
    showView("#view-home");
  }catch(err){
    console.error(err);
    logEl.innerHTML = `<span class="err">${escapeHtml(String(err))}</span>`;
  }
}

/* =========================
 * 画面：今後の予定（ICS）
 * ========================= */
async function openSchedules(){
  showView("#view-schedules");
  qs("#schedulesBox").innerHTML = `読み込み中… <span class="spinner"></span>`;
  await fetchSchedules();
}
async function fetchSchedules(){
  const days = qs("#selDays").value;
  const kind = qs("#selKind").value;
  const box = qs("#schedulesBox");
  try{
    const res = await apiGet({ schedules:"1", days, ...(kind?{kind}:{}) });
    if (res.status !== "ok") throw new Error("取得に失敗");
    const list = res.schedules || [];
    if (!list.length){
      box.innerHTML = `<div class="listEmpty">対象の予定はありません</div>`;
      return;
    }
    box.innerHTML = list.map(it=> renderScheduleRow(it)).join("");

    // ICSフィード購読ボタンを末尾に表示（固定）
    const feedUrl = `${CONFIG.API_BASE}?icsFeed=1`;
    const feedWebcal = toWebcal(feedUrl);
    const osNote = isIOS()
      ? `※ iOSは「購読（webcal）」の方が安定します`
      : `※ Googleカレンダーは「購読（webcal）」のURL推奨`;
    box.innerHTML += `
      <div class="card">
        <div class="sectionTitle">カレンダー購読（フィード）</div>
        <div class="muted small" style="margin-bottom:6px;">
          ${osNote}<br>URLをコピーして「購読」を選ぶと自動更新されます
        </div>
        <div class="icsRow">
          <a class="ghost" target="_blank" href="${escapeHtml(feedUrl)}">購読URL（https）</a>
          <a class="ghost" target="_blank" href="${escapeHtml(feedWebcal)}">購読URL（webcal）</a>
          <button class="ghost" type="button" onclick="copyToClipboard('${escapeJs(feedWebcal)}')">URLコピー</button>
        </div>
      </div>
    `;
  }catch(err){
    console.error(err);
    box.innerHTML = `<span class="err">${escapeHtml(String(err))}</span>`;
  }
}
function renderScheduleRow(it){
  // it: { id, date, time, title, place, kind, memo, ymd, hm }
  const icsUrl = `${CONFIG.API_BASE}?ics=1&id=${encodeURIComponent(it.id)}`;
  const label = `${it.date} ${it.time||""} ＠${it.place||""}`;
  return `
    <div class="card">
      <div class="sectionTitle">${escapeHtml(it.title)} <span class="pill">${escapeHtml(it.kind||"")}</span></div>
      <div class="muted">${escapeHtml(label)}</div>
      ${it.memo?`<div class="small muted">${escapeHtml(it.memo)}</div>`:""}
      <div class="line"></div>
      <div class="icsRow">
        <a class="ghost" target="_blank" href="${escapeHtml(icsUrl)}">この予定をカレンダーに追加（ICS）</a>
      </div>
    </div>
  `;
}
function escapeJs(s){ return String(s||"").replace(/\\/g,"\\\\").replace(/`/g,"\\`").replace(/"/g,'\\"').replace(/'/g,"\\'"); }
async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    alert("コピーしました");
  }catch(_){
    prompt("コピーできない場合は手動でコピーしてください", text);
  }
}

/* =========================
 * イベントハンドラ
 * ========================= */
function wire(){
  qs("#btnPrimary").addEventListener("click", ()=>{
    if (!State.members || !State.members.length){
      openRegister(false);
    } else {
      openForm();
    }
  });
  qs("#btnEditNames").addEventListener("click", ()=> openRegister(true));
  qs("#btnSchedules").addEventListener("click", openSchedules);
  qs("#btnReload").addEventListener("click", renderHome);

  qs("#btnBackFromForm").addEventListener("click", ()=> showView("#view-home"));
  qs("#btnBackFromReg").addEventListener("click", ()=> showView("#view-home"));
  qs("#btnBackFromSchedules").addEventListener("click", ()=> showView("#view-home"));

  qs("#btnAddPerf").addEventListener("click", addPerfRow);
  qs("#btnRegister").addEventListener("click", submitRegister);
  qs("#btnSubmit").addEventListener("click", submitForm);
  qs("#btnFetchSchedules").addEventListener("click", fetchSchedules);
}

/* =========================
 * 起動
 * ========================= */
(async function main(){
  qs("#ver").textContent = FRONT_VERSION;
  try{
    await initLiff();
    wire();
    await renderHome();
  }catch(err){
    console.error(err);
    qs("#homeLog").textContent = String(err);
  }
})();
</script>
</body>
</html>
