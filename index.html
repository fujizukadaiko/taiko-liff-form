<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>公演 出欠フォーム</title>

  <!-- =========================================================
    1) Google Fonts：CSSより前に置く（必須）
       和の雰囲気：本文=ゴシック（Noto Sans JP）
                 見出し/セクション=明朝（Shippori Mincho）
       ※ FOUCを抑えるため preconnect を追加
  ========================================================== -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&family=Shippori+Mincho:wght@500;700&display=swap"
    rel="stylesheet"
  >

  <!-- =========================================================
    2) Tailwind CDN（preflightは無効化）
       ※ tailwind.config は CDN 読み込み「前」に書くのが正解
  ========================================================== -->
  <script>
    window.tailwind = window.tailwind || {};
    tailwind.config = {
      corePlugins: { preflight: false }, // 既存CSSを壊さない
      theme: {
        extend: {
          colors: {
            primary: '#7f6aa5', // 藤の主色（任意でTailwindクラスとしても使える）
          },
          boxShadow: {
            card: '0 2px 10px rgba(0,0,0,0.04)'
          }
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

  <!-- =========================================================
    3) 既存のベースCSS（変数やレイアウトの基本）
       ※ :root は「和風（白藤系）」のパレットを採用
       ※ ここでは Tailwind の @apply は使わない（通常のCSS）
  ========================================================== -->
  <style>
    :root{
      /* 白藤系の基調色 */
      --c-bg:        #f7f5fa;  /* 背景（ごく淡い藤） */
      --c-panel:     #ffffff;  /* カード背景 */
      --c-border:    #e8e2f0;  /* 枠線（藤みのある薄グレー） */

      /* テキストとアクセント */
      --c-text:      #202022;
      --c-muted:     #6b6b6b;
      --c-primary:   #7f6aa5;  /* 主色（藤） */
      --c-primary-2: #6d5a93;  /* 影・強調（濃い藤） */
      --c-accent:    #a678b0;  /* バッジ等の差し色 */

      /* アクセント（若草・若緑） */
      --c-acc1:      #d2e5b1;  /* 明るい若草（淡い） */
      --c-acc2:      #9ce78f;  /* 若緑（本色） */
      --c-acc2-dark: #6aa96a;  /* 濃いめの緑（影やグラデ用） */

      /* 成功/警告/エラー（必要なら和色に寄せ替え可） */
      --c-ok:  #0a7;
      --c-err: #c33;
    }

    /* フォント：本文はゴシック、見出しは明朝 */
    body{
      margin:0;
      background: var(--c-bg);
      color: var(--c-text);
      font-family: "Noto Sans JP", system-ui, -apple-system, Segoe UI, "Hiragino Sans", "Yu Gothic", "Meiryo", sans-serif;
      letter-spacing: 0.02em;
      /* 和紙っぽい淡い背景（任意） */
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(127,106,165,.05), transparent 40%),
        radial-gradient(900px  500px at 80% 60%, rgba(127,106,165,.04), transparent 35%),
        var(--c-bg);
    }
    h1,h2,h3,.sectionTitle{
      font-family: "Shippori Mincho", "Yu Mincho", "Hiragino Mincho ProN", "MS PMincho", serif;
      letter-spacing: 0.03em;
    }

    /* 既存スタイル（必要最小限に整理） */
    header{
      padding:14px 16px; font-size:18px; font-weight:700;
      background:#fff; border-bottom:1px solid var(--c-border);
      display:flex; justify-content:space-between; align-items:center;
    }
    main{ padding:14px 16px; }
    .ver{ font-size:12px; color:#888; font-weight:500; }
    .card{ background:#fff; border:1px solid var(--c-border); border-radius:12px; padding:12px; margin:10px 0; }
    .muted{ color:var(--c-muted); font-size:13px; }
    .row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .row-space{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .right{ text-align:right; }
    .badge{ display:inline-block; font-size:12px; padding:2px 6px; background:var(--c-accent); color:#fff; border-radius:999px; margin-left:8px; }
    .small{ font-size:12px; color:var(--c-muted); }

    [data-view]{ display:none; }
    [data-view].show{ display:block; }

    .spinner{ width:18px; height:18px; border:2px solid #ddd; border-top-color: var(--c-primary); border-radius:50%; animation:spin 1s linear infinite; display:inline-block; vertical-align:middle; }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    label{ display:block; font-size:14px; margin:6px 0 4px; }
    input[type="text"], input[type="date"], input[type="time"], select, textarea{
      width:100%; border:1px solid var(--c-border); border-radius:8px; padding:8px; font-size:15px; background:#fff;
    }
    .listEmpty{ color:#888; font-size:14px; }

    .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#f5f5f5; border:1px solid var(--c-border); }
    .pill.sm { font-size:12px; padding:2px 8px; }

    .stat-ok  { background:#e8f8f3; border:1px solid #cdeee4; color:#0a7; }   /* 参加 */
    .stat-ng  { background:#fdeaea; border:1px solid #f6cccc; color:#c33; }   /* 欠席 */
    .stat-pd  { background:#fff7d6; border:1px solid #f3d27a; color:#7a5b00;} /* 未定 */
    .stat-na  { background:#f5f5f5; border:1px solid var(--c-border); color:#666;} /* 未回答 */

    .adminGrid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:700px){ .adminGrid{ grid-template-columns:1fr; } }
    .hint { font-size:12px; color:#777; }

    .tag { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--c-border); background:#f7f7f7; color:#444; }
    .tag.open   { background:#e8f8f3; border-color:#cdeee4; color:#0a7; }
    .tag.closed { background:#fdeaea; border-color:#f6cccc; color:#c33; }

    /* 入力不可の見た目（既存） */
    input:disabled, select:disabled, textarea:disabled {
      background-color: #f7f7f7 !important;
      color: #999 !important;
      border-color: #eee !important;
      -webkit-text-fill-color: #999;
    }
    #ad_meetPlace:disabled { background-color:#f7f7f7 !important; color:#999 !important; border-color:#eee !important; -webkit-text-fill-color:#999 !important; }
    #ad_meetPlace:disabled::placeholder { color:#bbb !important; }
    #ad_meetPlace:-webkit-autofill:disabled {
      -webkit-text-fill-color: #999 !important;
      -webkit-box-shadow: 0 0 0px 1000px #f7f7f7 inset !important;
      box-shadow: inset 0 0 0px 1000px #f7f7f7 !important;
    }
    input:disabled::placeholder { color: #bbb; }

    /* ヘッダーのスティッキー（※HTML内に直接書いていたものを正しい場所へ移動） */
    header.is-sticky {
      position: sticky;
      top: 0;
      backdrop-filter: blur(6px);
      background: rgba(255,255,255,0.9);
      z-index: 50;
    }

    /* =========================================================
       Button（a と button 共通）
       - a.btn / button.btn に適用
       - 既存の見た目は維持しつつ“ボタン感”を足すだけ
       - 色は白藤×若草×藤のパレットに統一
    ========================================================= */
    a.btn, button.btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;

      min-height: 40px;
      padding: 10px 14px;
      border-radius: 12px;

      border: 1px solid var(--c-border);
      background: #fff;                  /* 既定は白背景 */
      color: var(--c-text);
      text-decoration: none;             /* a の下線を消す */

      font-size: 15px;
      font-weight: 600;
      letter-spacing: .01em;
      line-height: 1;

      box-shadow: 0 2px 8px rgba(0,0,0,.06);
      transition: transform .08s ease, filter .12s ease, box-shadow .12s ease;
      cursor: pointer;
    }
    a.btn:hover, button.btn:hover {
      filter: brightness(1.02);
      transform: translateY(-0.5px);
    }
    a.btn:active, button.btn:active {
      filter: brightness(1.06);
      transform: translateY(0);
    }
    a.btn:focus-visible, button.btn:focus-visible {
      outline: none;
      box-shadow:
        0 2px 8px rgba(0,0,0,.06),
        0 0 0 3px color-mix(in srgb, var(--c-primary), transparent 75%);
    }
    button.btn:disabled,
    a.btn[aria-disabled="true"] {
      opacity: .6;
      cursor: not-allowed;
      pointer-events: none;
    }

    /* バリエーション */
    .btn-primary {
      color: #fff;
      border-color: color-mix(in srgb, var(--c-primary-2), #000 6%);
      background-image: linear-gradient(to bottom right, var(--c-primary), var(--c-primary-2));
    }
    .btn-primary:hover  { filter: brightness(1.06); }
    .btn-primary:active { filter: brightness(1.12); }

    .btn-accent {
      color: #0f1a0f;
      border-color: color-mix(in srgb, var(--c-acc2-dark), #000 10%);
      background-image: linear-gradient(to bottom right, var(--c-acc2), var(--c-acc2-dark));
    }
    .btn-accent:hover  { filter: brightness(1.05); }
    .btn-accent:active { filter: brightness(1.12); }

    .btn-ghost {
      background: #fff;
      color: var(--c-text);
      border-color: var(--c-border);
    }
    .btn-ghost:hover  { background: #f9fafb; }
    .btn-ghost:active { filter: brightness(1.04); }

    .btn-outline {
      background: #fff;
      color: var(--c-primary-2);
      border-color: var(--c-primary-2);
    }
    .btn-outline:hover  { background: #faf7ff; }
    .btn-outline:active { filter: brightness(1.06); }

    /* サイズ */
    .btn-sm { padding: 8px 12px; min-height: 36px; font-size: 14px; border-radius: 10px; }
    .btn-lg { padding: 12px 16px; min-height: 44px; font-size: 16px; border-radius: 14px; }

    /* アイコン付き（先頭アイコンとの間隔） */
    .btn > .icon { display:inline-block; margin-right: .4em; line-height:0; }

    /* 横並びボタン置き場（任意） */
    .btnRow { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:8px 0; }
  </style>

  <!-- =========================================================
    4) Tailwind の @apply で既存クラスを“和風リッチ”に
       ※ 必ず CDN の後に置く
  ========================================================== -->
  <script type="text/tailwindcss">
    @layer components {
      /* ヘッダー：さりげない下線＆余白（ベースCSSに上乗せ） */
      header { @apply border-b border-[color:var(--c-border)] px-4 py-3 flex items-center justify-between; }

      /* カード：淡い影と柔らかいボーダー（和紙の板感） */
      .card { @apply rounded-xl border bg-[color:var(--c-panel)] p-4 shadow-card border-[color:var(--c-border)]; }

      /* セクションタイトル：明朝＋下部に藤のグラデ棒 */
      .sectionTitle { @apply font-bold text-[17px] text-[color:var(--c-text)]; }
      .sectionTitle::after{
        content:""; display:block; height:3px; width:72px; margin-top:6px; border-radius:999px;
        background: linear-gradient(90deg, var(--c-primary) 0%, #c9b8e6 100%);
      }

      /* 区切り線を淡く */
      .line { @apply h-px my-3 bg-[color:var(--c-border)]; }

      /* 入力UI：境界＆フォーカスを藤色に */
      input[type="text"], input[type="date"], input[type="time"], select, textarea {
        @apply rounded-lg border px-3 py-2 bg-white text-[15px]
               border-[color:var(--c-border)]
               focus:outline-none focus:ring-2 focus:ring-[color:var(--c-primary)]/25;
      }

      /* ピル/バッジ/タグを藤寄せに */
      .pill { @apply inline-flex items-center gap-1.5 rounded-full border px-2.5 py-1 text-sm
                     bg-slate-50 border-[color:var(--c-border)] text-slate-700; }
      .pill.sm { @apply text-xs px-2 py-0.5; }
      .badge { @apply ml-2 inline-block rounded-full px-2 py-0.5 text-xs text-white; @apply bg-[color:var(--c-accent)]; }

      .tag { @apply inline-block rounded-full px-2 py-0.5 text-xs border
                   bg-slate-50 border-[color:var(--c-border)] text-slate-600; }
      .tag.open   { @apply bg-emerald-50 border-emerald-200 text-emerald-600; }
      .tag.closed { @apply bg-rose-50    border-rose-200    text-rose-600; }

      /* 出欠ステータスの色味は控えめトーンで */
      .stat-ok { @apply bg-emerald-50 border border-emerald-200 text-emerald-700; }
      .stat-ng { @apply bg-rose-50    border border-rose-200    text-rose-700; }
      .stat-pd { @apply bg-amber-50   border border-amber-200   text-amber-700; }
      .stat-na { @apply bg-slate-50   border border-slate-200   text-slate-500; }

      /* ボタン：はっきり“ボタン感”を出す（button要素のみ。aは .btn を使用） */
      button {
        @apply inline-flex items-center justify-center rounded-xl px-5 py-3 text-[15px] font-semibold text-white shadow-md transition;
        background-image: linear-gradient(to bottom right, var(--c-primary), var(--c-primary-2));
      }
      button:hover { @apply brightness-105; transform: translateY(-0.5px); }
      button:active{ transform: translateY(0); }
      button:disabled { @apply opacity-60 cursor-not-allowed; }

      /* ゴーストボタン：白藤の余白感 */
      button.ghost { @apply text-slate-800 bg-white border border-[color:var(--c-border)] shadow-sm hover:bg-slate-50; }

      /* 警告ボタン（やや和の黄） */
      button.warn  { @apply text-slate-900; background-image: linear-gradient(to bottom right, #ffd36b, #ffb703); }

      /* スピナーの色を藤に寄せる（border-top-colorは個別指定） */
      .spinner { border-top-color: rgb(79 70 229); } /* indigo-600相当 */
    }
  </script>

  <!-- =========================================================
    5) LIFF SDK（ここでもOK／重いようなら </body> 直前へ）
  ========================================================== -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>
  <!-- ヘッダーに「is-sticky」クラスを足すと スティッキー化 -->
  <header class="is-sticky">
    <div>公演 出欠フォーム</div>
    <div class="ver" id="ver"></div>
  </header>

  <main>
    <!-- 以降、あなたの既存HTMLのままでOK -->

  <!-- 友だち未追加アラート -->
  <div id="friendAlert" class="card warnBox" style="display:none;">
    このLIFFのBotが「友だち追加」されていません。通知を受け取るには公式アカウントを友だち追加してください。
  </div>

  <!-- ===== HOME ===== -->
  <section id="view-home" data-view class="show">
    <div id="hello" class="muted"></div>

  <!-- 管理メニュー（管理者のみ表示） -->
  <div id="adminMenu" class="card" style="display:none;">
    <div class="sectionTitle">管理用</div>
    <div class="row" style="gap:8px;">
      <!-- 予定登録/編集（view-admin を開く） -->
      <button id="btnAdminMenuSchedules"
              class="btn btn-accent btn-sm"
              data-view-target="view-admin">
        予定登録/編集
      </button>
  
      <!-- 出欠結果一覧（view-admin-report を開く） -->
      <button id="btnAdminMenuReport"
              class="btn btn-primary btn-sm"
              data-view-target="view-admin-report">
        出欠結果一覧
      </button>
    </div>
    <div class="small muted" style="margin-top:6px;">※ 管理者のみ表示されます</div>
  </div>
  
  <!-- 下部操作列 -->
  <div class="row" style="margin-top:6px; gap:8px; flex-wrap:wrap;">
    <button id="btnPrimary"
            class="btn btn-primary btn-lg btn-block"
            data-view-target="view-form">
      出欠を入力 / 変更する
    </button>
  
    <button id="btnEditNames"
            class="btn btn-ghost btn-lg"
            data-view-target="view-register"
            style="display:none;">
      氏名を編集する
    </button>
  
    <button id="btnSchedules"
            class="btn btn-outline btn-lg"
            data-view-target="view-schedules">
      今後の予定を見る
    </button>
  
    <button id="btnReload" class="btn btn-ghost btn-lg" type="button">
      再読み込み
    </button>
  </div>
  <div id="homeLog" class="muted" style="margin-top:8px;"></div>
    
  <!-- ===== フォーム（出欠） ===== -->
  <section id="view-form" data-view>
    <div class="row-space">
      <div class="sectionTitle">出欠入力フォーム</div>
      <button id="btnBackFromForm" class="ghost">トップに戻る</button>
    </div>

    <div id="formEventsBox" class="card muted">公演読み込み中… <span class="spinner"></span></div>
    <div id="formFields"></div>

    <div class="line"></div>
    <div class="row right">
      <button id="btnSubmit">送信する</button>
    </div>
    <div id="formLog" class="muted" style="margin-top:8px;"></div>
  </section>

  <!-- ===== 初回登録/氏名編集 ===== -->
  <section id="view-register" data-view>
    <div class="row-space">
      <div class="sectionTitle" id="regTitle">初回登録（入力者 & 演奏者）</div>
      <button id="btnBackFromReg" class="ghost">トップに戻る</button>
    </div>

    <div class="card">
      <label for="regInputName">入力者氏名（あなたの名前）</label>
      <input type="text" id="regInputName" placeholder="例：山田 太郎"/>

      <div class="line"></div>
      <div class="row-space">
        <div class="sectionTitle" style="margin:0;">演奏者（家族も追加可）</div>
        <button id="btnAddPerf" class="ghost" type="button">＋ 演奏者を追加</button>
      </div>
      <div id="perfList"></div>
      <div class="small muted">※ あなた自身が演奏する場合は、演奏者としてあなたの名前も追加してください。</div>
    </div>

    <div class="row right">
      <button id="btnRegister">登録する</button>
    </div>
    <div id="regLog" class="muted" style="margin-top:8px;"></div>
  </section>

  <!-- ===== 今後の予定 ===== -->
  <section id="view-schedules" data-view>
    <div class="row-space">
      <div class="sectionTitle">今後の予定</div>
      <div class="row" style="gap:8px;">
        <button id="btnBackFromSchedules" class="ghost">トップに戻る</button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="gap:12px;">
        <div>
          <label for="selDays">表示期間（日数）</label>
          <select id="selDays">
            <option value="30">30日</option>
            <option value="60" selected>60日</option>
            <option value="90">90日</option>
          </select>
        </div>
        <div>
          <label for="selKind">種別フィルタ</label>
          <select id="selKind">
            <option value="">（すべて）</option>
            <option value="発表">発表</option>
            <option value="練習">練習</option>
            <option value="その他">その他</option>
          </select>
        </div>
        <div style="align-self:flex-end;">
          <button id="btnFetchSchedules" class="ghost">再取得</button>
        </div>
      </div>
      <div id="schedulesBox" class="muted" style="margin-top:8px;">読み込み待機中</div>
    </div>

    <div class="small muted">
      ※ 予定はシート「Schedules（公開=Yes, ステータス=active）」から表示されます。<br>
      ※ 過去日と期間外の予定は自動的に表示から除外されます。
    </div>
  </section>

  <!-- ===== 予定登録（管理者） ===== -->
  <section id="view-admin" data-view>
    <div class="row-space">
      <div class="sectionTitle">予定登録（管理者）</div>
      <div class="row" style="gap:8px;">
        <button id="btnAdminBack" class="ghost">トップに戻る</button>
        <button id="btnAdminReload" class="ghost">一覧を再取得</button>
      </div>
    </div>

    <!-- 新規/編集フォーム -->
    <div class="card">
      <div class="row-space">
        <div class="sectionTitle" id="adminFormTitle">新規登録</div>
        <div class="small muted"><span id="adminEditingId" style="display:none;"></span></div>
      </div>

      <div class="adminGrid">
        <div>
          <label>タイトル *</label>
          <input id="ad_title" type="text" placeholder="例：秋祭り演奏会">
        </div>
        <div>
          <label>種別 *</label>
          <select id="ad_type">
            <option value="">（選択）</option>
            <option value="発表">発表</option>
            <option value="練習">練習</option>
            <option value="その他">その他</option>
          </select>
        </div>
        <div>
          <label>日付 *</label>
          <input id="ad_ymd" type="date">
        </div>
        <div>
          <label>時間（開始）</label>
          <input id="ad_hm" type="time" placeholder="HH:mm">
        </div>
        <div>
          <label>場所</label>
          <input id="ad_place" type="text" placeholder="例：藤塚小体育館">
        </div>
        <div>
          <label>集合時間（発表・その他のみ）</label>
          <input id="ad_meetAt" type="time" placeholder="HH:mm">
        </div>
        <div>
          <label>集合場所</label>
          <input id="ad_meetPlace" type="text" placeholder="例：藤塚小学校">
        </div>
        <div>
          <label>出欠対象（発表のみ）</label>
          <select id="ad_attendTarget">
            <option value="Y">Y</option>
            <option value="N" selected>N</option>
          </select>
        </div>
        <div>
          <label>締切日</label>
          <input id="ad_deadline" type="date">
        </div>
        <div>
          <label>公開</label>
          <select id="ad_publish">
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
        </div>
        <div>
          <label>ステータス</label>
          <select id="ad_status">
            <option value="active" selected>active</option>
            <option value="archived">archived</option>
          </select>
        </div>
        <div>
          <label>配信フラグ（必須：発表のみ）</label>
          <select id="ad_flag">
            <!-- 動的に選択肢を差し替えます -->
          </select>
        </div>
      </div>

      <div class="hint" style="margin-top:6px;">
        * 必須。IDは自動採番です。<br>
        種別が「練習」の場合は集合時間/集合場所/締切日/配信フラグは無効化（サーバ側でも保護）。<br>
        種別が「発表」以外では「出欠対象」は自動で N 固定になります。<br>
        「発表」の配信フラグは <b>新規登録時は Y/N のみ</b>、<b>編集時は Y/S/D/N</b> が選択可能です。
      </div>

      <div class="row right" style="margin-top:10px;">
        <button id="btnAdminReset" class="ghost" type="button">新規モードに戻す</button>
        <button id="btnAdminSubmit">新規登録</button>
      </div>
      <div id="adminFormLog" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- 一覧 -->
    <div class="card">
      <div class="row" style="gap:12px;">
        <div>
          <label>一覧の表示期間（日数）</label>
          <select id="ad_days">
            <option value="30">30日</option>
            <option value="60" selected>60日</option>
            <option value="90">90日</option>
          </select>
        </div>
        <div style="align-self:flex-end;">
          <button id="btnAdminFetch" class="ghost">一覧を取得</button>
        </div>
      </div>
      <div id="adminListBox" class="muted" style="margin-top:8px;">読み込み待機中</div>
    </div>
  </section>

  <!-- ===== 出欠結果一覧（管理者） ===== -->
<section id="view-admin-report" data-view>
  <div class="row-space">
    <div class="sectionTitle">出欠結果一覧（管理者）</div>
    <div class="row" style="gap:8px;">
      <button id="btnReportBack" class="ghost">トップに戻る</button>
      <button id="btnReportReload" class="ghost">再取得</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="gap:12px;">
      <div style="min-width:260px; flex:1;">
        <label for="repEvent">公演を選択</label>
        <select id="repEvent">
          <option value="">（選択してください）</option>
          <!-- JSで公演一覧を流し込み -->
        </select>
      </div>
      <div>
        <label for="repAttend">出欠フィルタ</label>
        <select id="repAttend">
          <option value="">（すべて）</option>
          <option value="参加">参加</option>
          <option value="欠席">欠席</option>
          <option value="未定">未定</option>
        </select>
      </div>
    </div>
    <div class="small muted" style="margin-top:6px;">
      ※ 対象は「公開=Yes」かつ配信フラグが Y/S/D の予定のみ
    </div>
  </div>

  <div id="repBox" class="muted">公演を選択してください</div>
</section>

</main>
<script>
  // ===== 共通：ビュー切替（同一ページ内） =====
  function showView(id) {
    const views = document.querySelectorAll('[data-view]');
    views.forEach(v => v.classList.toggle('show', v.id === id));
    window.scrollTo({ top: 0, behavior: 'instant' });
  }

  document.addEventListener('DOMContentLoaded', () => {
    // 1) data-view-target で SPA 切替
    document.querySelectorAll('[data-view-target]').forEach(el => {
      el.addEventListener('click', (ev) => {
        ev.preventDefault();
        const target = el.getAttribute('data-view-target');
        if (target) showView(target);
      });
    });

    // 2) data-href で外部/別ページへ遷移
    document.querySelectorAll('[data-href]').forEach(el => {
      el.addEventListener('click', (ev) => {
        // data-view-target があれば SPA を優先
        if (el.hasAttribute('data-view-target')) return;

        ev.preventDefault();
        const url = el.getAttribute('data-href');
        if (!url) return;

        const openNew = el.hasAttribute('data-newtab');
        // LIFF 内で外部ブラウザを開く（推奨）
        if (openNew && window.liff && typeof liff.openWindow === 'function') {
          liff.openWindow({ url, external: true });
          return;
        }
        // 通常の遷移
        if (openNew) {
          window.open(url, '_blank', 'noopener');
        } else {
          location.href = url;
        }
      });
    });

    // 3) 再読み込み
    document.getElementById('btnReload')?.addEventListener('click', () => {
      location.reload();
    });
  });
</script>
<script>
/* ===== 設定 ===== */
const FRONT_VERSION = "Front v2.3.4";
const LIFF_ID = "2008020568-2jVl00Rn";         // ←差し替え
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbwltiDNPrAIbLU0tommjwHhphICyyqPsHb9FcE_Dv7JUe-EPV1fj3qh3dkXxePyrHZLsQ/exec";     // ←差し替え

/* ===== 状態 ===== */
let state = {
  lineId: "",
  name: "",
  isAdmin: false,
  members: [],       // [{lineId,inputName,performerName}]
  events:  [],       // [{eventId,date,time,place,deadline,initialAt,isNew}]
  answers: {},       // { eventId: [...] }
  schedules: [],     // 今後の予定
  report:   [],      // 管理レポート（attendanceReport）
  submitting: false
};
let registerMode = "create"; // "create" | "edit"
let adminMode = "create";    // "create" | "edit"（予定登録フォーム）
let adminEditingId = "";     // 編集対象ID

/* ===== ユーティリティ ===== */
const $ = s => document.querySelector(s);
function show(id){ document.querySelectorAll("[data-view]").forEach(v=>v.classList.remove("show")); $(id).classList.add("show"); }
function logHome(t){ $("#homeLog").textContent = t||""; }
function logForm(t){ $("#formLog").textContent = t||""; }
function logReg(t){ $("#regLog").textContent = t||""; }
function logAdmin(t){ $("#adminFormLog").textContent = t||""; }

function z(n){ return String(n).padStart(2,"0"); }
function ymdDow(d){
  if (!(d instanceof Date) || isNaN(d)) return "";
  const yo = "日月火水木金土"[d.getDay()];
  return `${d.getFullYear()}/${z(d.getMonth()+1)}/${z(d.getDate())}（${yo}）`;
}
function hmFromTimeCell(v){
  const s = String(v||"").trim();
  const tryDate = new Date(s);
  if (!isNaN(tryDate)) return `${z(tryDate.getHours())}:${z(tryDate.getMinutes())}`;
  const m = s.match(/^(\d{1,2}):(\d{2})$/); 
  if (m) return `${z(m[1])}:${m[2]}`;
  return "";
}
// 厳密に日付文字列をパース
function parseYmdStrict(s){
  const m = String(s||"").match(/^(\d{4})[\/\-](\d{2})[\/\-](\d{2})$/);
  if (!m) {
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }
  const y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]);
  const dt = new Date(y, mo-1, d);
  return isNaN(dt) ? null : dt;
}
function esc(s){ return encodeURIComponent(String(s||"")); }
function toYmdSlashFromDateInput(v){ // "yyyy-mm-dd" -> "yyyy/MM/dd"
  if (!v) return "";
  const m = v.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  return m ? `${m[1]}/${m[2]}/${m[3]}` : "";
}
function toDateInputFromYmdSlash(v){ // "yyyy/MM/dd" -> "yyyy-mm-dd"
  const m = String(v||"").match(/^(\d{4})\/(\d{2})\/(\d{2})$/);
  return m ? `${m[1]}-${m[2]}-${m[3]}` : "";
}

/* Google Calendar 追加URL */
const DFLT_MIN = { "発表":90, "練習":150, "その他":60 };
function toDatesParam(ymdStr, hmStr, kind){
  const m = String(ymdStr||"").match(/^(\d{4})\/(\d{2})\/(\d{2})$/);
  if (!m) return "";
  const H = hmStr ? Number(hmStr.split(":")[0]) : 0;
  const M = hmStr ? Number(hmStr.split(":")[1]) : 0;
  const st = new Date(Number(m[1]), Number(m[2])-1, Number(m[3]), H, M, 0);
  const mins = DFLT_MIN[kind] || 60;
  const ed = new Date(st.getTime() + mins*60000);
  const fmt = (d)=>`${d.getFullYear()}${z(d.getMonth()+1)}${z(d.getDate())}T${z(d.getHours())}${z(d.getMinutes())}00`;
  return `${fmt(st)}/${fmt(ed)}`;
}
function makeGoogleCalUrl(title, ymd, hm, place, kind, memo){
  const base = "https://calendar.google.com/calendar/render?action=TEMPLATE";
  const dates = toDatesParam(ymd, hm, kind);
  const params = [
    `text=${esc(title)}`,
    dates ? `dates=${dates}` : "",
    place ? `location=${esc(place)}` : "",
    memo  ? `details=${esc(memo)}` : "",
    `ctz=${esc("Asia/Tokyo")}`
  ].filter(Boolean).join("&");
  return `${base}&${params}`;
}

/* ===== API ===== */
async function api(path){ const r = await fetch(API_ENDPOINT + path); return r.json(); }

/* ===== 初期化 ===== */
async function init(){
  try{
    $("#ver").textContent = FRONT_VERSION;

    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()){ liff.login(); return; }

    if (liff.getFriendship){
      try{
        const fr = await liff.getFriendship();
        if (fr && fr.friendFlag===false) $("#friendAlert").style.display="";
      }catch(_){}
    }

    const idt = liff.getDecodedIDToken();
    state.lineId = idt ? idt.sub : "";
    state.name   = idt && idt.name ? idt.name : "";
    $("#hello").textContent = state.name ? `こんにちは、${state.name} さん` : "";

    bindHandlers();
    resetRegisterForm();

    // Admin 判定
    try{
      const j = await api(`?isAdmin=1&id=${esc(state.lineId)}`);
      state.isAdmin = (j.status==="ok" && !!j.isAdmin);
      // 管理カードの表示切替
      $("#adminMenu").style.display = state.isAdmin ? "" : "none";
    }catch(_){ state.isAdmin = false; $("#adminMenu").style.display="none"; }

    await refreshData();
  }catch(err){
    $("#eventsBox").innerHTML = `<span class="err">初期化に失敗しました: ${err.message||err}</span>`;
  }
}

/* ===== クリックバインド ===== */
function bindHandlers(){
  $("#btnReload").onclick      = async ()=>{ logHome("再読み込み中…"); await refreshData(); logHome(""); };
  $("#btnPrimary").onclick     = onPrimary;
  $("#btnEditNames").onclick   = onEditNames;
  $("#btnBackFromForm").onclick= ()=> show("#view-home");
  $("#btnBackFromReg").onclick = ()=> show("#view-home");
  $("#btnSubmit").onclick      = onSubmit;

  $("#btnAddPerf").onclick     = ()=> addPerformerField("");
  $("#btnRegister").onclick    = onRegister;

  $("#btnSchedules").onclick   = ()=>{ show("#view-schedules"); renderSchedules(true); };
  $("#btnBackFromSchedules").onclick = ()=> show("#view-home");
  $("#btnFetchSchedules").onclick    = ()=> renderSchedules(false);
  // レポート
  $("#btnReportBack").onclick = ()=> show("#view-home");
  $("#btnReportReload").onclick = ()=> reportReload();
  $("#repEvent").addEventListener("change", renderReport); // 追加：公演選択で描画
  $("#repAttend").addEventListener("change", renderReport);
  
  // 管理メニュー（HOME）
  $("#btnAdminMenuSchedules").onclick = ()=>{
    if (!state.isAdmin){ alert("管理者のみアクセス可能です"); return; }
    show("#view-admin");
    enterAdminCreateMode();
    adminListFetch();
  };
  $("#btnAdminMenuReport").onclick = ()=>{
    if (!state.isAdmin){ alert("管理者のみアクセス可能です"); return; }
    show("#view-admin-report");
    reportReload();
  };

  // 管理画面
  $("#btnAdminBack").onclick = ()=> show("#view-home");
  $("#btnAdminReload").onclick = ()=> adminListFetch();
  $("#btnAdminFetch").onclick = ()=> adminListFetch();
  $("#btnAdminSubmit").onclick = ()=> adminSubmit();
  $("#btnAdminReset").onclick = ()=> enterAdminCreateMode();
  $("#ad_type").addEventListener("change", adminTypeChangeAdapt);

  // レポート (管理者)
  $("#btnReportBack").onclick = ()=> show("#view-home");
  $("#btnReportReload").onclick = ()=> reportReload();
  $("#repEvent").addEventListener("change", renderReport);
  $("#repAttend").addEventListener("change", renderReport);
}

/* ===== データ読み直し ===== */
async function refreshData(){
  $("#eventsBox").innerHTML  = `読み込み中… <span class="spinner"></span>`;
  $("#answersBox").innerHTML = `会員情報照会中… <span class="spinner"></span>`;
  $("#btnPrimary").textContent = "読み込み中..."; $("#btnPrimary").disabled = true;
  $("#btnEditNames").style.display = "none";

  // イベント（Y/S 両方）
  const ev = await api("?events=1");
  state.events = (ev.status==="ok" && Array.isArray(ev.events)) ? ev.events : [];

  // 会員（Members）
  const w = await api(`?whoami=1&id=${esc(state.lineId)}`);
  state.members = (w.status==="ok" ? (w.members||[]) : []);

  // 既存回答（まとめ取得）
  state.answers = {};
  if (state.events.length > 0){
    const ids = state.events.map(e=>e.eventId);
    const r = await api(`?getAttendanceAll=1&lineId=${esc(state.lineId)}&eventIds=${esc(JSON.stringify(ids))}`);
    if (r.status === "ok" && r.map) state.answers = r.map;
  }

  renderHome();
}

/* ===== HOME描画 ===== */
function renderHome(){
  // 現在配信中の公演
  if (!state.events.length){
    $("#eventsBox").innerHTML = `<span>現在配信中の公演はありません</span>`;
  } else {
    $("#eventsBox").innerHTML = state.events.map(e=>{
      const d = parseYmdStrict(e.date);
      const dateDisp = ymdDow(d);
      const timeDisp = hmFromTimeCell(e.time);
      const deadlineStr = e.deadline ? `（締切：${e.deadline}）` : "";
      const badge = e.isNew ? `<span class="badge">NEW</span>` : "";
      return `<div class="card" style="margin:8px 0">
        <div><b>${dateDisp} ${timeDisp}</b> @ ${e.place||""} ${badge}</div>
        <div class="small muted">${deadlineStr}</div>
      </div>`;
    }).join("");
  }

  // ボタン
  const hasMembers = state.members.length > 0;
  $("#btnPrimary").textContent = hasMembers ? "出欠を入力 / 変更する" : "初回登録に進む";
  $("#btnPrimary").disabled = false;
  $("#btnEditNames").style.display = hasMembers ? "" : "none";

  // 登録状況
  if (!hasMembers){
    $("#answersBox").innerHTML = `
      <div>まだ「初回登録」が済んでいません。</div>
      <div class="small">出欠の前に、入力者名と演奏者（家族分も可）の登録をしてください。</div>`;
  } else {
    let html = "";
    for (const e of state.events){
      const ans = state.answers[e.eventId] || [];
      const perfs = Array.from(new Set(state.members.map(m=>m.performerName))).filter(Boolean);
      const map = {}; ans.forEach(r => { map[r.performerName] = r; });

      const d = parseYmdStrict(e.date);
      const dateDisp = ymdDow(d);
      const timeDisp = hmFromTimeCell(e.time);

      let rows = perfs.map(name=>{
        const a = map[name];
        let cls="stat-na", label="未回答";
        if (a && a.attend){
          if (a.attend==="参加") { cls="stat-ok"; label="参加"; }
          else if (a.attend==="欠席"){ cls="stat-ng"; label="欠席"; }
          else if (a.attend==="未定"){ cls="stat-pd"; label="未定"; }
        }
        return `<div class="row" style="justify-content:space-between;">
          <span class="pill">${name}</span>
          <span class="pill sm ${cls}">${label}</span>
        </div>`;
      }).join("");

      if (!rows) rows = `<div class="muted">演奏者が未登録です（初回登録をしてください）</div>`;

      html += `<div class="card">
        <div class="muted">【${dateDisp} ${timeDisp} @${e.place||""}】${e.isNew?` <span class="badge">NEW</span>`:""}</div>
        ${rows}
      </div>`;
    }
    if (!html) html = `<div class="muted">配信中の公演がありません</div>`;
    $("#answersBox").innerHTML = html;
  }
}

/* ===== メインボタン ===== */
function onPrimary(){
  if (state.members.length === 0){
    registerMode = "create";
    resetRegisterForm();
    $("#regTitle").textContent = "初回登録（入力者 & 演奏者）";
    $("#btnRegister").textContent = "登録する";
    show("#view-register");
  } else {
    buildFormView();
    show("#view-form");
  }
}
function onEditNames(){
  registerMode = "edit";
  buildRegisterFormFromMembers();
  $("#regTitle").textContent = "氏名編集（入力者 & 演奏者）";
  $("#btnRegister").textContent = "保存";
  show("#view-register");
}

/* ===== 出欠フォーム ===== */
function buildFormView(){
  if (!state.events.length){
    $("#formEventsBox").innerHTML = `<span>現在配信中の公演はありません</span>`;
  } else {
    const headerHtml = state.events.map(e=>{
      const d = parseYmdStrict(e.date);
      const dateDisp = ymdDow(d);
      const timeDisp = hmFromTimeCell(e.time);
      const ans = state.answers[e.eventId] || [];
      const perfs = Array.from(new Set(state.members.map(m=>m.performerName))).filter(Boolean);
      const map = {}; ans.forEach(r => { map[r.performerName] = r; });
      const rows = perfs.map(name=>{
        const a = map[name];
        let cls="stat-na", label="未回答";
        if (a && a.attend){
          if (a.attend==="参加") { cls="stat-ok"; label="参加"; }
          else if (a.attend==="欠席"){ cls="stat-ng"; label="欠席"; }
          else if (a.attend==="未定"){ cls="stat-pd"; label="未定"; }
        }
        return `<span class="pill sm ${cls}">${name}:${label}</span>`;
      }).join(" ");
      return `<div class="card" style="margin:8px 0">
        <div><b>${dateDisp} ${timeDisp}</b> @ ${e.place||""} ${e.isNew?`<span class="badge">NEW</span>`:""}</div>
        <div class="small muted">${e.deadline?`締切：${e.deadline}`:""}</div>
        <div style="margin-top:6px;">${rows||""}</div>
      </div>`;
    }).join("");
    $("#formEventsBox").innerHTML = headerHtml;
  }

  const box = $("#formFields");
  box.innerHTML = "";
  if (!state.events.length) return;

  for (const e of state.events){
    const current = state.answers[e.eventId] || [];
    const map = {}; current.forEach(r => map[r.performerName] = r);
    const performers = Array.from(new Set(state.members.map(m => m.performerName))).filter(Boolean);

    const d = parseYmdStrict(e.date);
    const dateDisp = ymdDow(d);
    const timeDisp = hmFromTimeCell(e.time);

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<div class="sectionTitle">【${dateDisp} ${timeDisp}】@${e.place||""}</div>`;

    performers.forEach((name, idx)=>{
      const row = map[name] || {};
      const attend = row.attend || "";
      const idBase = `e${e.eventId}_i${idx}`;

      const html = `
        <div style="border-top:1px dashed var(--c-border); margin:10px 0; padding-top:10px;">
          <div class="pill" style="margin-bottom:6px;">${name}</div>
          <label for="${idBase}_att">出欠</label>
          <select id="${idBase}_att" data-event="${e.eventId}" data-name="${name}">
            <option value="">（選択してください）</option>
            <option value="参加" ${attend==="参加"?"selected":""}>参加</option>
            <option value="欠席" ${attend==="欠席"?"selected":""}>欠席</option>
            <option value="未定" ${attend==="未定"?"selected":""}>未定</option>
          </select>
        </div>
      `;
      card.insertAdjacentHTML("beforeend", html);
    });
    // 公演コメント（共通1枠）
    let eventComment = "";
    for (const r of current) {
      if ((r.comment||"").trim()) { eventComment = r.comment.trim(); break; }
    }
    const comId = `e${e.eventId}_eventcom`;
    card.insertAdjacentHTML("beforeend", `
      <div class="line"></div>
      <label for="${comId}">公演コメント（任意・100文字まで、代表して1行のみ保存）</label>
      <input type="text" id="${comId}" value="${eventComment}" maxlength="100" placeholder="例：家族の予定調整中 など">
    `);
    
    box.appendChild(card);
  }
}

/* ===== 出欠送信 ===== */
async function onSubmit(){
  if (state.submitting) return;
  state.submitting = true;
  const btn = $("#btnSubmit");
  btn.disabled = true; btn.textContent = "送信中…"; logForm("");

  try{
    const payloads = [];
    const seen = new Set();

    for (const e of state.events){
      const performers = Array.from(new Set(state.members.map(m => m.performerName))).filter(Boolean);
      // 公演コメント（共通1枠）
      const eventComEl = document.getElementById(`e${e.eventId}_eventcom`);
      const eventComment = (eventComEl?.value || "").trim();
      
      performers.forEach((name, idx)=>{
        const idBase = `e${e.eventId}_i${idx}`;
        const sel = document.getElementById(`${idBase}_att`);
        if (!sel) return;
        const attend = sel.value;
        if (!attend) return; // 未選択は送信しない

        const key = `${e.eventId}||${name}`;
        if (seen.has(key)) return; seen.add(key);

        payloads.push({ eventId:e.eventId, performerName:name, attend, _eventComment: eventComment });
      });
    }

    if (!payloads.length){ alert("送信する内容がありません（出欠の選択が未入力です）"); return; }

    // イベントIDでグループ化して送信（先頭のみコメントを付ける）
    const grouped = {};
    const eventCommentMap = {};
    for (const p of payloads) {
      if (!grouped[p.eventId]) grouped[p.eventId] = [];
      grouped[p.eventId].push({ performerName: p.performerName, attend: p.attend });
      if (eventCommentMap[p.eventId] === undefined) eventCommentMap[p.eventId] = (p._eventComment || "");
    }
    
    for (const [eventId, list] of Object.entries(grouped)) {
      const eCom = String(eventCommentMap[eventId] || "");
      const bulk = list.map((it, idx) => ({
        performerName: it.performerName,
        attend: it.attend,
        comment: (idx === 0 ? eCom : "")
      }));
    
      const url = `${API_ENDPOINT}?submitBulk=1`
                + `&eventId=${esc(eventId)}`
                + `&lineId=${esc(state.lineId)}`
                + `&bulk=${esc(JSON.stringify(bulk))}`;
      const r = await fetch(url);
      const j = await r.json();
      if (j.status !== "ok") throw new Error(`送信失敗（${eventId}）: ${j.message||"unknown"}`);
    }

    alert("送信しました");
    show("#view-home");
    logHome("更新中…");
    await refreshData();
    logHome("");

  }catch(err){
    logForm(err.message || String(err));
  }finally{
    state.submitting = false;
    btn.disabled = false; btn.textContent = "送信する";
  }
}

/* ===== 初回登録 ===== */
function resetRegisterForm(){
  $("#regInputName").value = state.name || "";
  $("#perfList").innerHTML = "";
  addPerformerField("");
}
function buildRegisterFormFromMembers(){
  const inputName = (state.members[0]?.inputName || state.name || "");
  $("#regInputName").value = inputName;
  $("#perfList").innerHTML = "";
  const names = Array.from(new Set(state.members.map(m=>m.performerName))).filter(Boolean);
  if (names.length === 0) {
    addPerformerField("");
  } else {
    names.forEach(n=> addPerformerField(n));
  }
}
function addPerformerField(value=""){
  const id = "perf_" + Math.random().toString(36).slice(2);
  const row = document.createElement("div");
  row.className = "row"; row.style.margin = "6px 0";
  row.innerHTML = `
    <div style="flex:1; min-width:220px;">
      <label for="${id}" class="muted">演奏者名</label>
      <input type="text" id="${id}" class="regPerf" value="${value||""}" placeholder="例：藤塚 太郎">
    </div>
    <div>
      <button type="button" class="ghost" onclick="this.closest('.row').remove()">削除</button>
    </div>
  `;
  $("#perfList").appendChild(row);
}
async function onRegister(){
  try{
    logReg("");
    const inputName = $("#regInputName").value.trim();
    if (!inputName) throw new Error("入力者氏名を入力してください");

    const names = Array.from(document.querySelectorAll(".regPerf"))
      .map(el => (el.value||"").trim())
      .filter(Boolean);

    const uniq = Array.from(new Set(names));
    if (uniq.length === 0) throw new Error("演奏者を1名以上入力してください");

    $("#btnRegister").disabled = true; $("#btnRegister").textContent = (registerMode==="edit" ? "保存中…" : "登録中…");

    let url = "";
    if (registerMode === "edit") {
      url = `${API_ENDPOINT}?replaceMembers=1&lineId=${esc(state.lineId)}&inputName=${esc(inputName)}&list=${esc(JSON.stringify(uniq))}&purge=0`;
    } else {
      url = `${API_ENDPOINT}?registerBulk=1&lineId=${esc(state.lineId)}&inputName=${esc(inputName)}&list=${esc(JSON.stringify(uniq))}`;
    }

    const r = await fetch(url); const j = await r.json();
    if (j.status !== "ok") throw new Error(j.message || "登録に失敗しました");

    alert(registerMode==="edit" ? "氏名を保存しました" : "初回登録が完了しました");
    show("#view-home");
    logHome("更新中…");
    await refreshData();
    logHome("");

  }catch(err){
    logReg(err.message || String(err));
  }finally{
    $("#btnRegister").disabled = false; $("#btnRegister").textContent = (registerMode==="edit" ? "保存" : "登録する");
  }
}

/* ===== 今後の予定（Schedules） ===== */
async function renderSchedules(initial=false){
  const box = $("#schedulesBox");
  box.innerHTML = `読み込み中… <span class="spinner"></span>`;

  try{
    const days = Number($("#selDays").value || 60);
    const kind = $("#selKind").value || "";

    const url = kind
      ? `?schedules=1&days=${esc(days)}&kind=${esc(kind)}`
      : `?schedules=1&days=${esc(days)}`;

    const r = await api(url);
    if (r.status !== "ok" || !Array.isArray(r.schedules)) {
      box.innerHTML = `<span class="err">取得に失敗しました</span>`;
      return;
    }
    state.schedules = r.schedules;

    if (!state.schedules.length){
      box.innerHTML = `<div class="listEmpty">該当する予定はありません</div>`;
      return;
    }

    const feedUrl = `${API_ENDPOINT}?icsFeed=1`;
    let html = `<div class="small muted" style="margin-bottom:8px;">
      ・各予定から「Googleカレンダー」/「iOS(ICS)」に追加できます。購読（自動反映）は下のリンクから登録してください。
    </div>`;

    html += state.schedules.map(it=>{
      return `<div class="card">
        <div><b>${it.date} ${it.time||""}</b> @ ${it.place||""}</div>
        <div class="small muted">${it.kind||""} ${it.title||""}</div>
        ${it.memo?`<div class="small">${it.memo}</div>`:""}
      </div>`;
    }).join("");

    html += `
      <div class="card" style="margin-top:12px;">
        <div class="sectionTitle" style="margin:0 0 8px;">購読（自動反映）</div>
        <div class="small">以下のURLをカレンダーアプリの「カレンダーを購読」等の項目に貼り付けてください。</div>
        <div class="row" style="margin-top:6px; gap:8px; flex-wrap:wrap;">
          <input type="text" id="icsFeedUrl" value="${feedUrl}" style="flex:1; min-width:240px;" readonly>
          <button class="ghost" onclick="copyIcsFeed()">コピー</button>
          <button class="ghost" onclick="window.open('${feedUrl}','_blank')">開く</button>
        </div>
        <div class="small muted" style="margin-top:6px;">
          ※ Googleカレンダーに購読を追加する場合は、Googleカレンダーの「他のカレンダー」→「URL で追加」から登録してください。
        </div>
      </div>
    `;

    box.innerHTML = html;

  }catch(err){
    box.innerHTML = `<span class="err">エラー: ${err.message||err}</span>`;
  }
}
function copyIcsFeed(){
  const ipt = $("#icsFeedUrl");
  ipt.select();
  document.execCommand("copy");
  alert("購読URLをコピーしました");
}

/* ===== 予定登録（管理者） ===== */
// 種別変更に応じて UI を制御（練習=集合場所/配信フラグ/締切日も無効化）
function adminTypeChangeAdapt(){
  const t = $("#ad_type").value;
  const meetAt     = $("#ad_meetAt");
  const meetPlace  = $("#ad_meetPlace");
  const attend     = $("#ad_attendTarget");
  const deadline   = $("#ad_deadline");
  const flagSel    = $("#ad_flag");

  if (t === "練習"){
    // 練習：集合時間・集合場所・締切・配信フラグは無効化 & 値は空/Nへ
    $("#ad_meetAt").value    = "";  meetAt.disabled    = true;
    $("#ad_meetPlace").value = "";  meetPlace.disabled = true;
    attend.value = "N";             attend.disabled    = true;
    $("#ad_deadline").value  = "";  deadline.disabled  = true;
    updateFlagOptions({ type:t, forceN:true, disable:true }); // N固定、無効化

  } else if (t === "発表"){
    // 発表：すべて編集可。フラグ選択肢は新規/編集で分岐
    meetAt.disabled    = false;
    meetPlace.disabled = false;
    attend.disabled    = false;
    deadline.disabled  = false;
    updateFlagOptions({ type:t, forceN:false, disable:false });

  } else {
    // その他：集合時間は有効、集合場所も有効（要件上UIは無効化要求無し）
    meetAt.disabled    = false;
    meetPlace.disabled = false;
    attend.value       = "N";
    attend.disabled    = true;
    // 期限はUI上は編集可（サーバ側ではクリアされる）
    deadline.disabled  = false;
    updateFlagOptions({ type:t, forceN:true, disable:true }); // N固定、無効化
  }
}
// 配信フラグ選択肢の差し替え（新規=Y/Nのみ、編集=Y/S/D/N）/ 非発表はN固定
function updateFlagOptions({ type, forceN=false, disable=false }){
  const sel = $("#ad_flag");
  const cur = sel.value || "N";
  sel.innerHTML = ""; // いったん空に

  // 選択肢定義
  const opt = (v, label)=> {
    const o = document.createElement("option");
    o.value = v; o.textContent = label;
    sel.appendChild(o);
  };

  if (type === "発表" && !forceN){
    if (adminMode === "create"){
      // 新規は Y / N の2択
      opt("N","N");
      opt("Y","Y（初回配信対象）");
    }else{
      // 編集は Y/S/D/N 全て
      opt("N","N");
      opt("Y","Y（初回配信対象）");
      opt("S","S（初回配信済）");
      opt("D","D（締切超過/締切停止）");
    }
  }else{
    // 非発表（練習/その他）は N 固定
    opt("N","N");
  }

  // 既存値の維持（許可外なら N に丸め）
  const allowed = Array.from(sel.options).map(o=>o.value);
  sel.value = allowed.includes(cur) ? cur : "N";
  sel.disabled = !!disable;
}

function enterAdminCreateMode(){
  adminMode = "create";
  adminEditingId = "";
  $("#adminFormTitle").textContent = "新規登録";
  $("#adminEditingId").style.display = "none";
  $("#btnAdminSubmit").textContent = "新規登録";
  $("#ad_title").value = "";
  $("#ad_type").value = "";
  $("#ad_ymd").value = "";
  $("#ad_hm").value = "";
  $("#ad_place").value = "";
  $("#ad_meetAt").value = "";
  // ★ 集合場所のデフォルト値（新規のみ）
  $("#ad_meetPlace").value = "藤塚小学校";
  $("#ad_attendTarget").value = "N";
  $("#ad_deadline").value = "";
  $("#ad_publish").value = "Yes";
  $("#ad_status").value = "active";
  // フラグは新規時は N 初期化。種別未選択のため一旦Nのみ
  $("#ad_flag").innerHTML = `<option value="N" selected>N</option><option value="Y">Y（初回配信対象）</option>`;
  $("#ad_flag").value = "N";
  // 種別に応じたUI制御
  adminTypeChangeAdapt();
  logAdmin("");
}
function fillAdminFormFromItem(it){
  adminMode = "edit";
  adminEditingId = it.id || "";
  $("#adminFormTitle").textContent = `編集：${adminEditingId}`;
  $("#adminEditingId").style.display = "";
  $("#adminEditingId").textContent = `ID: ${adminEditingId}`;
  $("#btnAdminSubmit").textContent = "保存";

  $("#ad_title").value = it.title || "";
  $("#ad_type").value  = it.type || "";
  $("#ad_ymd").value   = toDateInputFromYmdSlash(it.ymd || "");
  $("#ad_hm").value    = it.hm || "";
  $("#ad_place").value = it.place || "";
  $("#ad_meetAt").value = it.meetAt || "";
  $("#ad_meetPlace").value = it.meetPlace || "";
  $("#ad_attendTarget").value = (it.attendTarget||"N");
  $("#ad_deadline").value = toDateInputFromYmdSlash(it.deadline || "");
  $("#ad_publish").value = it.publish || "Yes";
  $("#ad_status").value  = it.status  || "active";

  // 種別に応じたUI制御＆フラグ候補の差し替え
  adminTypeChangeAdapt();
  // 値反映（候補に無い場合はNへ）
  $("#ad_flag").value = it.flag || "N";
  if (![...$("#ad_flag").options].map(o=>o.value).includes($("#ad_flag").value)){
    $("#ad_flag").value = "N";
  }
  logAdmin("");
}
async function adminSubmit(){
  try{
    if (!state.isAdmin){ alert("管理者のみ利用できます"); return; }
    logAdmin("");

    const type  = $("#ad_type").value.trim();
    const title = $("#ad_title").value.trim();
    const ymdIn = $("#ad_ymd").value.trim();   // yyyy-mm-dd
    const hm    = $("#ad_hm").value.trim();
    const place = $("#ad_place").value.trim();
    const meetAt= $("#ad_meetAt").value.trim();
    const meetPl= $("#ad_meetPlace").value.trim();
    const attT  = $("#ad_attendTarget").value.trim().toUpperCase();
    const dlIn  = $("#ad_deadline").value.trim();
    const pub   = $("#ad_publish").value.trim();
    const st    = $("#ad_status").value.trim();
    const flag  = $("#ad_flag").value.trim();

    if (!title || !type || !ymdIn){ throw new Error("タイトル/種別/公演日は必須です"); }

    // ★ クライアント側バリデーション：発表のフラグ必須（新規=Y/N、編集=Y/S/D/N）
    if (type === "発表"){
      const allowed = (adminMode==="create") ? ["Y","N"] : ["Y","S","D","N"];
      if (!flag || !allowed.includes(flag)){
        throw new Error(adminMode==="create"
          ? "配信フラグは Y または N を選択してください（発表/新規）"
          : "配信フラグは Y/S/D/N から選択してください（発表/編集）"
        );
      }
    }

    // UI制御に従う（安全側）
    let meetAtSend = meetAt, meetPlSend = meetPl, attSend = attT, dlSend = dlIn;
    if (type==="練習"){
      meetAtSend = ""; meetPlSend = ""; attSend = "N"; dlSend = "";
    }
    if (type!=="発表"){ attSend = "N"; /* dlSendはUI可だがサーバ側でクリア */ }

    const ymd = toYmdSlashFromDateInput(ymdIn); // yyyy/MM/dd
    const dl  = dlSend ? toYmdSlashFromDateInput(dlSend) : "";

    $("#btnAdminSubmit").disabled = true;
    $("#btnAdminSubmit").textContent = (adminMode==="edit" ? "保存中…" : "登録中…");

    let res;
    if (adminMode === "create"){
      const url = `?adminUpsertSchedule=1&lineId=${esc(state.lineId)}`
        + `&type=${esc(type)}&title=${esc(title)}&ymd=${esc(ymd)}`
        + (hm?`&hm=${esc(hm)}`:"")
        + (place?`&place=${esc(place)}`:"")
        + (meetAtSend?`&meetAt=${esc(meetAtSend)}`:"")
        + (meetPlSend?`&meetPlace=${esc(meetPlSend)}`:"")
        + `&attendTarget=${esc(attSend)}`
        + (dl?`&deadline=${esc(dl)}`:"")
        + `&publish=${esc(pub)}&status=${esc(st)}&flag=${esc(flag)}`;
      res = await api(url);
      if (res.status!=="ok") throw new Error(res.message||"登録に失敗しました");
      alert(`登録しました（ID: ${res.id || "(不明)"}）`);
      enterAdminCreateMode();
      await adminListFetch();

    } else {
      if (!adminEditingId){ throw new Error("編集対象IDが不正です"); }
      const url = `?adminUpsertSchedule=1&lineId=${esc(state.lineId)}&id=${esc(adminEditingId)}`
        + `&type=${esc(type)}&title=${esc(title)}&ymd=${esc(ymd)}`
        + (hm?`&hm=${esc(hm)}`:"")
        + (place?`&place=${esc(place)}`:"")
        + (meetAtSend?`&meetAt=${esc(meetAtSend)}`:"")
        + (meetPlSend?`&meetPlace=${esc(meetPlSend)}`:"")
        + `&attendTarget=${esc(attSend)}`
        + (dl?`&deadline=${esc(dl)}`:"")
        + `&publish=${esc(pub)}&status=${esc(st)}&flag=${esc(flag)}`;
      res = await api(url);
      if (res.status!=="ok") throw new Error(res.message||"保存に失敗しました");
      alert("保存しました");
      await adminListFetch();
    }
  }catch(err){
    logAdmin(err.message || String(err));
  }finally{
    $("#btnAdminSubmit").disabled = false;
    $("#btnAdminSubmit").textContent = (adminMode==="edit" ? "保存" : "新規登録");
  }
}
async function adminListFetch(){
  try{
    $("#adminListBox").innerHTML = `読み込み中… <span class="spinner"></span>`;
    const days = Number($("#ad_days").value || 60);
    const r = await api(`?adminListSchedules=1&lineId=${esc(state.lineId)}&days=${esc(days)}`);
    if (r.status !== "ok" || !Array.isArray(r.items)){
      $("#adminListBox").innerHTML = `<span class="err">取得に失敗しました</span>`;
      return;
    }
    if (r.items.length === 0){
      $("#adminListBox").innerHTML = `<div class="listEmpty">該当する予定はありません</div>`;
      return;
    }
    
    const html = r.items.map(raw=>{
      const it = {
        id: raw.id || "",
        type: raw.type || "",
        title: raw.title || "",
        ymd: raw.ymd || "",
        hm: raw.hm || "",
        place: raw.place || "",
        meetAt: raw.meetAt || "",
        meetPlace: raw.meetPlace || "",
        attendTarget: raw.attendTarget || "N",
        deadline: raw.deadline || "",
        publish: raw.publish || "No",
        status: raw.status || "archived",
        flag: raw.flag || "N"
      };
      return `<div class="card">
        <div><b>${it.ymd}${it.hm?` ${it.hm}`:""}</b> @ ${it.place||""}</div>
        <div class="small">${it.type||""}：${it.title||""}</div>
        <div class="small muted">出欠対象:${it.attendTarget||"N"} / 期限:${it.deadline||"(なし)"} / 公開:${it.publish||"No"} / 状態:${it.status||"archived"} / 配信:${it.flag||"N"}</div>
        <div class="row" style="margin-top:8px;">
          <button class="ghost" type="button" onclick='adminEdit(${JSON.stringify(it).replace(/"/g,"&quot;")})'>編集</button>
        </div>
      </div>`;
    }).join("");
  
    $("#adminListBox").innerHTML = html;
  }catch(err){
    $("#adminListBox").innerHTML = `<span class="err">エラー：${err.message||err}</span>`;
  }
}
function adminEdit(obj){
  fillAdminFormFromItem(obj);
  window.scrollTo({ top:0, behavior:"smooth" });
}

/* ===== 出欠結果一覧（管理者） ===== */
async function reportReload(){
  $("#repBox").innerHTML = `読み込み中… <span class="spinner"></span>`;
  try{
    const r = await api(`?attendanceReport=1&lineId=${esc(state.lineId)}`);
    if (r.status!=="ok" || !Array.isArray(r.list)){
      $("#repBox").innerHTML = `<span class="err">取得に失敗しました</span>`;
      return;
    }
    state.report = r.list; // [{id, ymd, time, title, place, flag, accepting, rows:[...]}]

    // 公演セレクトを構築
    const sel = $("#repEvent");
    // 先頭に「選択してください」を維持し、他は一度クリア
    sel.innerHTML = `<option value="">（選択してください）</option>`;
    // 日時→時間→タイトルでソート
    const items = [...state.report].sort((a,b)=> 
      (String(a.ymd||"").localeCompare(b.ymd||"") || String(a.time||"").localeCompare(b.time||"") || String(a.title||"").localeCompare(b.title||""))
    );
    for (const e of items){
      const label = `${e.ymd || ""}${e.time ? " " + e.time : ""}  ${e.title || ""}`;
      const opt = document.createElement("option");
      opt.value = e.id;
      opt.textContent = label;
      sel.appendChild(opt);
    }

    // 初期表示は選択待ち
    $("#repBox").innerHTML = `公演を選択してください`;

  }catch(err){
    $("#repBox").innerHTML = `<span class="err">エラー：${err.message||err}</span>`;
  }
}
function renderReport(){
  const box = $("#repBox");
  if (!state.report || state.report.length===0){
    box.innerHTML = `<div class="listEmpty">データがありません。再取得してください。</div>`;
    return;
  }

  const selId = $("#repEvent").value; // 公演ID
  const fAtt  = $("#repAttend").value; // 出欠フィルタ

  if (!selId){
    box.innerHTML = `公演を選択してください`;
    return;
  }

  const ev = state.report.find(x => String(x.id) === String(selId));
  if (!ev){
    box.innerHTML = `<div class="listEmpty">選択した公演が見つかりません</div>`;
    return;
  }

  // rows をフィルタ
  let rows = Array.isArray(ev.rows) ? ev.rows : [];
  if (fAtt) rows = rows.filter(r => (r.attend||"") === fAtt);

  if (rows.length === 0){
    box.innerHTML = `<div class="listEmpty">該当データがありません</div>`;
    return;
  }

  // 並び：氏名→回答日時
  rows.sort((a,b)=> (String(a.name||"").localeCompare(String(b.name||"")) || String(a.answeredAt||"").localeCompare(String(b.answeredAt||""))));

  const dateDisp = `${ev.ymd || ""}${ev.time ? " " + ev.time : ""}`;
  const header = `
    <div class="card">
      <div class="row-space">
        <div><b>${dateDisp}</b> @ ${ev.place||""}</div>
        <div><span class="tag ${ev.accepting==="open"?"open":"closed"}">${ev.accepting==="open"?"受付中":"受付終了"}</span></div>
      </div>
      <div class="small muted">${ev.title||""} <span class="small muted">（ID: ${ev.id}）</span></div>
    </div>
  `;

  const body = rows.map(r=>{
    return `<div class="card">
      <div class="row" style="justify-content:space-between;">
        <div><span class="pill">${r.name||""}</span></div>
        <div><span class="pill sm ${
          r.attend==="参加" ? "stat-ok" : r.attend==="欠席" ? "stat-ng" : r.attend==="未定" ? "stat-pd" : "stat-na"
        }">${r.attend||"未回答"}</span></div>
      </div>
      ${r.comment?`<div class="small" style="margin-top:4px;">コメント：${r.comment}</div>`:""}
      ${r.answeredAt?`<div class="small muted" style="margin-top:4px;">回答：${r.answeredAt}</div>`:""}
    </div>`;
  }).join("");

  box.innerHTML = header + body;
}

/* ===== 起動 ===== */
init();
</script>
</body>
</html>
