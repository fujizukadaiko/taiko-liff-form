<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>出欠フォーム（LIFF）</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js" crossorigin="anonymous"></script>
<style>
  body { font-family: system-ui, -apple-system, sans-serif; padding: 16px; }
  h2 { margin: 0 0 8px; }
  .card { border:1px solid #ddd; border-radius:12px; padding:12px; margin:12px 0; }
  label { display:block; margin: 10px 0 6px; }
  select, input, textarea, button { width: 100%; padding: 10px; font-size: 16px; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .primary { background:#06c; color:#fff; border:none; border-radius:8px; }
  .ghost { background:#eee; color:#111; border:1px solid #ddd; border-radius:8px; }
  .disabled { opacity:.6; pointer-events:none; }
  .hint { color:#666; font-size:12px; }
  #log { white-space:pre-wrap; font-size:12px; color:#555; margin-top:8px; }
</style>
</head>
<body>
  <h2>公演 出欠登録</h2>

  <div id="eventBox" class="card">読み込み中…</div>
  <div class="row" style="margin-bottom:8px;">
    <button id="reloadBtn" class="ghost">再読込</button>
    <button id="pingBtn" class="ghost">接続テスト</button>
  </div>
  <div id="userName" class="hint"></div>

  <!-- 未登録時：会員登録フォーム -->
  <div id="regBox" class="card" style="display:none;">
    <h3>初回登録</h3>
    <label>入力者氏名</label>
    <input id="inputName" type="text" placeholder="例）山田太郎" />
    <label>演奏者氏名</label>
    <input id="performerName" type="text" placeholder="例）山田花子" />
    <label>入力者は演奏者ですか？</label>
    <select id="isPerformer">
      <option value="">選択してください</option>
      <option value="Y">はい（演奏者）</option>
      <option value="N">いいえ（保護者など）</option>
    </select>
    <button id="regBtn" class="primary" style="margin-top:12px;">登録する</button>
  </div>

  <!-- 登録済み：出欠フォーム -->
  <div id="attBox" class="card" style="display:none;">
    <h3>出欠入力</h3>
    <div id="perfWrap">
      <label>対象の演奏者</label>
      <select id="selPerformer"></select>
    </div>
    <label>出欠</label>
    <select id="attend">
      <option value="">選択してください</option>
      <option value="参加">参加</option>
      <option value="不参加">不参加</option>
      <option value="未定">未定</option>
    </select>
    <div id="pendingWrap" style="display:none;">
      <label>未定の回答予定日（YYYY/MM/DD）</label>
      <input id="pendingDate" type="text" placeholder="例）2025/09/10" />
    </div>
    <label>コメント（任意）</label>
    <textarea id="comment" rows="3"></textarea>
    <button id="submitBtn" class="primary" style="margin-top:12px;">送信</button>
  </div>

  <div id="debug" class="hint" style="margin-top:8px;"></div>
  <div id="log"></div>

<script>
/* ===== 設定（実値に差し替え） ===== */
const LIFF_ID = "2008020568-2jVl00Rn";
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbzbQbbDNajBj18rQ6B5AJdVkCvQOgOSGmv1sDHqYNRMaFj1jKqEEXrT4nNahGudkHsCrA/exec";
/* ================================== */

const $ = id => document.getElementById(id);
const log = m => { $("log").textContent += m + "\n"; };

let inFlight = false;
const setSubmitting = on => {
  const b = $("submitBtn");
  if (!b) return;
  if (on) { b.textContent = "送信中…"; b.classList.add("disabled"); b.disabled = true; inFlight = true; }
  else { b.textContent = "送信"; b.classList.remove("disabled"); b.disabled = false; inFlight = false; }
};

function makeNonce(){
  const a = new Uint8Array(16); crypto.getRandomValues(a);
  return Array.from(a).map(x=>x.toString(16).padStart(2,"0")).join("");
}

function getDecoded(){ try{ return liff.getDecodedIDToken(); }catch(_){ return null; } }
function getIdToken(){ try{ return liff.getIDToken(); }catch(_){ return null; } }
function showTokenDebug(){
  const p = getDecoded();
  if(!p){ $("debug").textContent="IDトークンなし"; return; }
  const now = Math.floor(Date.now()/1000);
  $("debug").textContent = "aud:"+p.aud+" / exp:"+p.exp+" / 残り(秒):"+(p.exp-now);
}

// CORS回避のため FormData でPOST
async function apiPostForm(payload){
  const fd = new FormData();
  Object.entries(payload).forEach(([k,v])=>{
    if (v === undefined || v === null) return;
    if (k === "form") fd.append("form", JSON.stringify(v));
    else fd.append(k, String(v));
  });
  const res = await fetch(API_ENDPOINT + "?ts=" + Date.now(), { method:"POST", body: fd, cache:"no-store" });
  const txt = await res.text();
  try { return JSON.parse(txt); } catch { return { status:"error", raw:txt }; }
}

/* ===== 再認証ループ防止の仕掛け ===== */
// 直近の再ログイン時刻（ms）を sessionStorage に保持し、60秒未満は再ログインしない
const REAUTH_KEY = "reauth_at_ms";
function shouldSkipReauthWithin(ms=60000){
  const v = Number(sessionStorage.getItem(REAUTH_KEY) || "0");
  return (Date.now() - v) < ms;
}
function markReauthNow(){ sessionStorage.setItem(REAUTH_KEY, String(Date.now())); }

// サーバが verify failed を返した時だけ 1回 re-login。復帰後に「保存済みペイロード」で自動再送
const RESUME_KEY = "resume_payload";

function requestReauthAndResume(payload){
  if (shouldSkipReauthWithin(60000)) {
    alert("認証を更新しました。画面を開き直してください。");
    return;
  }
  sessionStorage.setItem(RESUME_KEY, JSON.stringify(payload));
  markReauthNow();
  const url = new URL(location.href);
  url.searchParams.set("resume","1");
  liff.login({ redirectUri: url.href });
}

function tryAutoResume(){
  const url = new URL(location.href);
  if (url.searchParams.get("resume") === "1") {
    const saved = sessionStorage.getItem(RESUME_KEY);
    sessionStorage.removeItem(RESUME_KEY);
    if (saved) {
      const payload = JSON.parse(saved);
      // 送信再実行（whoami/登録/出欠 どれにも対応）
      handleAction(payload);
    }
    // 二重再ログイン防止：URLの resume を消す
    history.replaceState(null, "", location.pathname + location.search.replace(/([?&])resume=1(&|$)/, "$1").replace(/[?&]$/, ""));
  }
}

/* ===== イベント表示 ===== */
function formatEvent(ev){
  if (!ev) return "現在、配信中の公演はありません。";
  return `公演ID: ${ev.eventId}\n日時: ${ev.date} ${ev.time}\n場所: ${ev.place}`;
}

function buildPerformerSelect(members){
  const sel = $("selPerformer");
  sel.innerHTML = "";
  const perfs = (members||[]).filter(m => (m.isPerformer||"").toUpperCase() === "Y");
  const list  = perfs.length ? perfs : (members||[]);
  list.forEach(m=>{
    const opt = document.createElement("option");
    opt.value = m.performerName;
    opt.textContent = m.performerName;
    sel.appendChild(opt);
  });
}

/* ===== 共通アクション実行（再送にも使う） ===== */
async function handleAction(payload){
  // payload は {action, idToken?, nonce?, form?}
  if (payload.action !== "activeEvent" && !payload.idToken) {
    const tok = getIdToken();
    if (!tok) { requestReauthAndResume(payload); return; }
    payload.idToken = tok;
  }
  const resp = await apiPostForm(payload);
  if (resp.status === "error" && resp.message === "verify failed") {
    requestReauthAndResume(payload);
    return;
  }
  return resp;
}

/* ===== 初期化 ===== */
$("attend").addEventListener("change", e=>{
  $("pendingWrap").style.display = (e.target.value === "未定") ? "block" : "none";
});
$("reloadBtn").onclick = ()=>{ location.replace(location.href.split("#")[0]); };
$("pingBtn").onclick = ()=>{
  fetch(API_ENDPOINT + "?ping=1&ts="+Date.now(), { method:"GET", cache:"no-store" })
    .then(r=>r.text()).then(t=>alert("接続: "+t)).catch(e=>alert("失敗: "+e));
};

$("regBtn").onclick = async ()=>{
  const inputName = $("inputName").value.trim();
  const performerName = $("performerName").value.trim();
  const isPerformer = $("isPerformer").value;
  if (!inputName || !performerName || !isPerformer) { alert("未入力があります"); return; }
  const payload = { action:"registerMember", form:{ inputName, performerName, isPerformer } };
  const resp = await handleAction(payload);
  if (!resp) return; // 再認証へ遷移済み
  if (resp.status === "ok") {
    alert("登録しました。出欠入力に進みます。");
    buildPerformerSelect(resp.members||[]);
    $("regBox").style.display = "none";
    $("attBox").style.display = "block";
  } else {
    alert("登録に失敗しました: " + (resp.raw||resp.message));
  }
};

$("submitBtn").onclick = async ()=>{
  if (inFlight) return;
  const eventId = window.__ACTIVE_EVENT_ID__ || "";
  if (!eventId) { alert("配信中の公演がありません"); return; }
  const performerName = $("selPerformer").value;
  const attend = $("attend").value;
  const pendingDate = $("pendingDate").value.trim();
  const comment = $("comment").value.trim();
  if (!performerName) { alert("演奏者を選択してください"); return; }
  if (!attend) { alert("出欠を選択してください"); return; }

  const nonce = makeNonce();
  setSubmitting(true);
  const payload = {
    action:"submitAttendance",
    nonce,
    form:{ eventId, performerName, attend, pendingDate, comment }
  };
  const resp = await handleAction(payload);
  setSubmitting(false);

  if (!resp) return; // 再認証へ遷移済み（復帰後に自動再送されます）
  if (resp.status === "ok") {
    alert(resp.duplicate ? "（重複はスキップしました）送信済です。" : "送信しました。ありがとうございます！");
    try{ liff.closeWindow(); }catch(_){}
  } else {
    alert("送信エラー: " + (resp.raw || resp.message));
  }
};

window.addEventListener("error", ev=>{ alert("JSエラー: "+ev.message); });
window.addEventListener("unhandledrejection", ev=>{ alert("通信エラー: "+(ev.reason && (ev.reason.message||ev.reason))); });

(async function init(){
  try{
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login({ redirectUri: location.href }); return; }

    // イベント表示（トークン不要）
    const ev = await handleAction({ action:"activeEvent" });
    if (ev && ev.status==="ok" && ev.event) {
      $("eventBox").textContent = formatEvent(ev.event);
      window.__ACTIVE_EVENT_ID__ = ev.event.eventId;
    } else {
      $("eventBox").textContent = "現在、配信中の公演はありません。";
    }

    // whoami（idToken必要：取れなければ handleAction 内で再認証→復帰後に自動再呼び出し）
    const who = await handleAction({ action:"whoami" });
    if (!who) return; // 再認証に遷移→復帰後に自動再実行
    const idp = getDecoded(); if (idp && idp.name) $("userName").textContent = "対象：" + idp.name + " さん";
    showTokenDebug();

    const members = who.members || [];
    if (members.length === 0) {
      $("regBox").style.display = "block";
    } else {
      buildPerformerSelect(members);
      $("attBox").style.display = "block";
    }

    // ログイン復帰時の自動再送（登録/出欠）
    tryAutoResume();
  }catch(e){
    alert("初期化エラー: " + e);
  }
})();
</script>
</body>
</html>
