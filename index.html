<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>公演 出欠フォーム</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{
      --c-primary:#0b74de; --c-bg:#fafafa; --c-border:#e5e5e5;
      --c-text:#222; --c-muted:#666; --c-ok:#0a7; --c-err:#c33;
      --c-accent:#ff6b6b;
    }
    body{ font-family: system-ui, -apple-system, Segoe UI, sans-serif; margin:0; background:var(--c-bg); color:var(--c-text);}
    header{ padding:14px 16px; font-size:18px; font-weight:700; background:#fff; border-bottom:1px solid var(--c-border); display:flex; justify-content:space-between; align-items:center;}
    main{ padding:14px 16px; }
    .ver{ font-size:12px; color:#888; font-weight:500; }
    .card{ background:#fff; border:1px solid var(--c-border); border-radius:12px; padding:12px; margin:10px 0; }
    .muted{ color:var(--c-muted); font-size:13px; }
    .row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .row-space{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    button{ appearance:none; border:none; border-radius:10px; padding:10px 14px; background:var(--c-primary); color:#fff; font-size:16px; }
    button.ghost{ background:#f4f4f4; color:#222; border:1px solid var(--c-border); }
    button.warn{ background:#ffb703; color:#222; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .ok{ color:var(--c-ok); }
    .err{ color:var(--c-err); }
    .sectionTitle{ font-weight:700; margin:8px 0; }
    .line{ height:1px; background:var(--c-border); margin:10px 0; }
    .warnBox{ background:#fff7d6; border:1px solid #f3d27a; padding:10px; border-radius:10px; color:#7a5b00; }
    .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#f5f5f5; border:1px solid var(--c-border); }
    .right{ text-align:right; }
    .badge{ display:inline-block; font-size:12px; padding:2px 6px; background:var(--c-accent); color:#fff; border-radius:999px; margin-left:8px; }
    .small{ font-size:12px; color:var(--c-muted); }

    [data-view]{ display:none; }
    [data-view].show{ display:block; }

    .spinner{ width:18px; height:18px; border:2px solid #ddd; border-top-color:var(--c-primary); border-radius:50%; animation:spin 1s linear infinite; display:inline-block; vertical-align:middle; }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    label{ display:block; font-size:14px; margin:6px 0 4px; }
    input[type="text"], input[type="date"], select, textarea{
      width:100%; border:1px solid var(--c-border); border-radius:8px; padding:8px; font-size:15px; background:#fff;
    }
    .listEmpty{ color:#888; font-size:14px; }

    /* NEW バッジ（既に入っていれば不要） */
    .badge{
      display:inline-block;
      margin-left:6px;
      padding:2px 6px;
      font-size:12px;
      color:#fff;
      background:#e53935;
      border-radius:999px;
      vertical-align:middle;
    }
    
    /* 小さめのピルと状態色 */
    .pill.sm { font-size:12px; padding:2px 8px; }
    .stat-ok  { background:#e8f8f3; border:1px solid #cdeee4; color:#0a7; }   /* 参加 */
    .stat-ng  { background:#fdeaea; border:1px solid #f6cccc; color:#c33; }   /* 欠席 */
    .stat-pd  { background:#fff7d6; border:1px solid #f3d27a; color:#7a5b00;} /* 未定 */
    .stat-na  { background:#f5f5f5; border:1px solid var(--c-border); color:#666;} /* 未回答 */
  </style>
</head>
<body>
<header>
  <div>公演 出欠フォーム</div>
  <div class="ver" id="ver"></div>
</header>
<main>

  <!-- 友だち未追加アラート（任意） -->
  <div id="friendAlert" class="card warnBox" style="display:none;">
    このLIFFのBotが「友だち追加」されていません。通知を受け取るには公式アカウントを友だち追加してください。
  </div>

  <!-- ===== HOME ===== -->
  <section id="view-home" data-view class="show">
    <div id="hello" class="muted"></div>

    <div class="card">
      <div class="sectionTitle">現在配信中の公演</div>
      <div id="eventsBox" class="muted">読み込み中… <span class="spinner"></span></div>
    </div>

    <div class="card">
      <div class="sectionTitle">あなたの登録状況</div>
      <div id="answersBox" class="muted">会員情報照会中… <span class="spinner"></span></div>
    </div>

    <div class="row" style="margin-top:6px;">
      <button id="btnPrimary">読み込み中...</button>
      <button id="btnEditNames" class="ghost" style="display:none;">氏名を編集する</button>
      <button id="btnSchedules" class="ghost">今後の予定を見る</button>
      <button id="btnReload" class="ghost">再読み込み</button>
    </div>
    <div id="homeLog" class="muted" style="margin-top:8px;"></div>
  </section>

  <!-- ===== フォーム（出欠） ===== -->
  <section id="view-form" data-view>
    <div class="row-space">
      <div class="sectionTitle">出欠入力フォーム</div>
      <button id="btnBackFromForm" class="ghost">トップに戻る</button>
    </div>

    <div id="formEventsBox" class="card muted">公演読み込み中… <span class="spinner"></span></div>
    <div id="formFields"></div>

    <div class="line"></div>
    <div class="row right">
      <button id="btnSubmit">送信する</button>
    </div>
    <div id="formLog" class="muted" style="margin-top:8px;"></div>
  </section>

  <!-- ===== 初回登録/氏名編集 ===== -->
  <section id="view-register" data-view>
    <div class="row-space">
      <div class="sectionTitle" id="regTitle">初回登録（入力者 & 演奏者）</div>
      <button id="btnBackFromReg" class="ghost">トップに戻る</button>
    </div>

    <div class="card">
      <label for="regInputName">入力者氏名（あなたの名前）</label>
      <input type="text" id="regInputName" placeholder="例：山田 太郎"/>

      <div class="line"></div>
      <div class="row-space">
        <div class="sectionTitle" style="margin:0;">演奏者（家族も追加可）</div>
        <button id="btnAddPerf" class="ghost" type="button">＋ 演奏者を追加</button>
      </div>
      <div id="perfList"></div>
      <div class="small muted">※ あなた自身が演奏する場合は、演奏者としてあなたの名前も追加してください。</div>
    </div>

    <div class="row right">
      <button id="btnRegister">登録する</button>
    </div>
    <div id="regLog" class="muted" style="margin-top:8px;"></div>
  </section>

  <!-- ===== 今後の予定 ===== -->
  <section id="view-schedules" data-view>
    <div class="row-space">
      <div class="sectionTitle">今後の予定</div>
      <button id="btnBackFromSchedules" class="ghost">トップに戻る</button>
    </div>

    <div class="card">
      <div class="row" style="gap:12px;">
        <div>
          <label for="selDays">表示期間（日数）</label>
          <select id="selDays">
            <option value="30">30日</option>
            <option value="60" selected>60日</option>
            <option value="90">90日</option>
          </select>
        </div>
        <div>
          <label for="selKind">種別フィルタ</label>
          <select id="selKind">
            <option value="">（すべて）</option>
            <option value="発表">発表</option>
            <option value="練習">練習</option>
            <option value="その他">その他</option>
          </select>
        </div>
        <div style="align-self:flex-end;">
          <button id="btnFetchSchedules" class="ghost">再取得</button>
        </div>
      </div>
      <div id="schedulesBox" class="muted" style="margin-top:8px;">読み込み待機中</div>
    </div>

    <div class="small muted">
      ※ 予定はシート「Schedules（公開=Yes, ステータス=active）」から表示されます。<br>
      ※ 過去日と期間外の予定は自動的に表示から除外されます。
    </div>
  </section>

</main>

<script>
/* ===== 設定 ===== */
const FRONT_VERSION = "Front v0.8";
const LIFF_ID = "2008020568-2jVl00Rn";
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbzGAEJcYOiXy9y3AtfzHZ5Z4hbamA5kpK-jroZVB_S4NWQBDv3UMqyEkMJQP4f7DPKHZg/exec";

/* ===== 状態 ===== */
let state = {
  lineId: "",
  name: "",
  members: [],       // [{lineId,inputName,performerName}]
  events:  [],       // [{eventId,date,time,place,deadline,initialAt,isNew}]
  answers: {},       // { eventId: [{performerName,attend,comment,answeredAt,pendingDate(互換)}] }
  schedules: [],     // 今後の予定の表示用
  submitting: false
};
let registerMode = "create"; // "create" | "edit"

/* ===== ユーティリティ ===== */
const $ = s => document.querySelector(s);
function show(id){ document.querySelectorAll("[data-view]").forEach(v=>v.classList.remove("show")); $(id).classList.add("show"); }
function logHome(t){ $("#homeLog").textContent = t||""; }
function logForm(t){ $("#formLog").textContent = t||""; }
function logReg(t){ $("#regLog").textContent = t||""; }

function z(n){ return String(n).padStart(2,"0"); }
function ymdDow(d){
  if (!(d instanceof Date) || isNaN(d)) return "";
  const yo = "日月火水木金土"[d.getDay()];
  return `${d.getFullYear()}/${z(d.getMonth()+1)}/${z(d.getDate())}（${yo}）`;
}
function hmFromTimeCell(v){
  // GAS側は "Sat Dec 30 1899 HH:MM..." 形式のDate相当が来ることがある
  const s = String(v||"").trim();
  const tryDate = new Date(s);
  if (!isNaN(tryDate)) return `${z(tryDate.getHours())}:${z(tryDate.getMinutes())}`;
  // "H:MM" / "HH:MM"
  const m = s.match(/^(\d{1,2}):(\d{2})$/); 
  if (m) return `${z(m[1])}:${m[2]}`;
  return "";
}
function parseDateLike(s){
  // "Mon Sep 15 2025 ..." or "2025/09/15" など雑に対応
  const d = new Date(s);
  return isNaN(d) ? null : d;
}
function todayISO(){
  const d = new Date();
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
}
function esc(s){ return encodeURIComponent(String(s||"")); }

/* Google Calendar 追加URLを生成（開始・終了が必要） */
const DFLT_MIN = { "発表":90, "練習":150, "その他":60 };
function toDatesParam(ymdStr, hmStr, kind){
  // ymdStr: "yyyy/MM/dd", hmStr: "HH:mm" or ""
  const m = String(ymdStr||"").match(/^(\d{4})\/(\d{2})\/(\d{2})$/);
  if (!m) return "";
  const H = hmStr ? Number(hmStr.split(":")[0]) : 0;
  const M = hmStr ? Number(hmStr.split(":")[1]) : 0;
  const st = new Date(Number(m[1]), Number(m[2])-1, Number(m[3]), H, M, 0);
  const mins = DFLT_MIN[kind] || 60;
  const ed = new Date(st.getTime() + mins*60000);
  const fmt = (d)=>{
    return `${d.getFullYear()}${z(d.getMonth()+1)}${z(d.getDate())}T${z(d.getHours())}${z(d.getMinutes())}00`;
  };
  return `${fmt(st)}/${fmt(ed)}`;
}
function makeGoogleCalUrl(title, ymd, hm, place, kind, memo){
  const base = "https://calendar.google.com/calendar/render?action=TEMPLATE";
  const dates = toDatesParam(ymd, hm, kind);
  const params = [
    `text=${esc(title)}`,
    dates ? `dates=${dates}` : "",
    place ? `location=${esc(place)}` : "",
    memo  ? `details=${esc(memo)}` : "",
    `ctz=${esc("Asia/Tokyo")}`
  ].filter(Boolean).join("&");
  return `${base}&${params}`;
}

/* ===== API ===== */
async function api(path){ const r = await fetch(API_ENDPOINT + path); return r.json(); }

/* ===== 初期化 ===== */
async function init(){
  try{
    $("#ver").textContent = FRONT_VERSION;

    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()){ liff.login(); return; }

    if (liff.getFriendship){
      try{
        const fr = await liff.getFriendship();
        if (fr && fr.friendFlag===false) $("#friendAlert").style.display="";
      }catch(_){}
    }

    const idt = liff.getDecodedIDToken();
    state.lineId = idt ? idt.sub : "";
    state.name   = idt && idt.name ? idt.name : "";
    $("#hello").textContent = state.name ? `こんにちは、${state.name} さん` : "";

    // ボタン
    $("#btnReload").onclick      = async ()=>{ logHome("再読み込み中…"); await refreshData(); logHome(""); };
    $("#btnPrimary").onclick     = onPrimary;
    $("#btnEditNames").onclick   = onEditNames;
    $("#btnBackFromForm").onclick= ()=> show("#view-home");
    $("#btnBackFromReg").onclick = ()=> show("#view-home");
    $("#btnSubmit").onclick      = onSubmit;

    $("#btnAddPerf").onclick     = ()=> addPerformerField("");
    $("#btnRegister").onclick    = onRegister;

    $("#btnSchedules").onclick   = ()=>{ show("#view-schedules"); renderSchedules(true); };
    $("#btnBackFromSchedules").onclick = ()=> show("#view-home");
    $("#btnFetchSchedules").onclick    = ()=> renderSchedules(false);

    resetRegisterForm();
    await refreshData();

  }catch(err){
    $("#eventsBox").innerHTML = `<span class="err">初期化に失敗しました: ${err.message||err}</span>`;
  }
}

/* ===== データ読み直し（高速化版：getAttendanceAll） ===== */
async function refreshData(){
  $("#eventsBox").innerHTML  = `読み込み中… <span class="spinner"></span>`;
  $("#answersBox").innerHTML = `会員情報照会中… <span class="spinner"></span>`;
  $("#btnPrimary").textContent = "読み込み中..."; $("#btnPrimary").disabled = true;
  $("#btnEditNames").style.display = "none";

  // イベント（Y/S 両方）
  const ev = await api("?events=1");
  state.events = (ev.status==="ok" && Array.isArray(ev.events)) ? ev.events : [];

  // 会員（Members）
  const w = await api(`?whoami=1&id=${esc(state.lineId)}`);
  state.members = (w.status==="ok" ? (w.members||[]) : []);

  // 既存回答（まとめ取得）
  state.answers = {};
  if (state.events.length > 0){
    const ids = state.events.map(e=>e.eventId);
    const r = await api(`?getAttendanceAll=1&lineId=${esc(state.lineId)}&eventIds=${esc(JSON.stringify(ids))}`);
    if (r.status === "ok" && r.map) state.answers = r.map;
  }

  renderHome();
}

/* ===== HOME描画 ===== */
function renderHome(){
  // 現在配信中の公演（New バッジ・締切表示）
  if (!state.events.length){
    $("#eventsBox").innerHTML = `<span>現在配信中の公演はありません</span>`;
  } else {
    $("#eventsBox").innerHTML = state.events.map(e=>{
      const d = parseDateLike(e.date);
      const dateDisp = ymdDow(d);
      const timeDisp = hmFromTimeCell(e.time);
      const deadlineStr = e.deadline ? `（締切：${e.deadline}）` : "";
      const badge = e.isNew ? `<span class="badge">NEW</span>` : "";
      return `<div class="card" style="margin:8px 0">
        <div><b>${dateDisp} ${timeDisp}</b> @ ${e.place||""} ${badge}</div>
        <div class="small muted">${deadlineStr}</div>
      </div>`;
    }).join("");
  }

  // ボタンの切り替え
  const hasMembers = state.members.length > 0;
  $("#btnPrimary").textContent = hasMembers ? "出欠を入力 / 変更する" : "初回登録に進む";
  $("#btnPrimary").disabled = false;
  $("#btnEditNames").style.display = hasMembers ? "" : "none";

  // あなたの登録状況（イベント別にサマリ）
  if (!hasMembers){
    $("#answersBox").innerHTML = `
      <div>まだ「初回登録」が済んでいません。</div>
      <div class="small">出欠の前に、入力者名と演奏者（家族分も可）の登録をしてください。</div>`;
  } else {
    let html = "";
    for (const e of state.events){
      const ans = state.answers[e.eventId] || []; // [{performerName,attend,comment,...}]
      const perfs = Array.from(new Set(state.members.map(m=>m.performerName))).filter(Boolean);
      const map = {}; ans.forEach(r => { map[r.performerName] = r; });

      const d = parseDateLike(e.date);
      const dateDisp = ymdDow(d);
      const timeDisp = hmFromTimeCell(e.time);

      let rows = perfs.map(name=>{
        const a = map[name];
        let cls="stat-na", label="未回答";
        if (a && a.attend){
          if (a.attend==="参加") { cls="stat-ok"; label="参加"; }
          else if (a.attend==="欠席"){ cls="stat-ng"; label="欠席"; }
          else if (a.attend==="未定"){ cls="stat-pd"; label="未定"; }
        }
        return `<div class="row" style="justify-content:space-between;">
          <span class="pill">${name}</span>
          <span class="pill sm ${cls}">${label}</span>
        </div>`;
      }).join("");

      if (!rows) rows = `<div class="muted">演奏者が未登録です（初回登録をしてください）</div>`;

      html += `<div class="card">
        <div class="muted">【${dateDisp} ${timeDisp} @${e.place||""}】${e.isNew?` <span class="badge">NEW</span>`:""}</div>
        ${rows}
      </div>`;
    }
    if (!html) html = `<div class="muted">配信中の公演がありません</div>`;
    $("#answersBox").innerHTML = html;
  }
}

/* ===== メインボタンの動作 ===== */
function onPrimary(){
  if (state.members.length === 0){
    // 初回登録へ
    registerMode = "create";
    resetRegisterForm();
    $("#regTitle").textContent = "初回登録（入力者 & 演奏者）";
    $("#btnRegister").textContent = "登録する";
    show("#view-register");
  } else {
    // 出欠フォームへ
    buildFormView();
    show("#view-form");
  }
}
function onEditNames(){
  registerMode = "edit";
  buildRegisterFormFromMembers();
  $("#regTitle").textContent = "氏名編集（入力者 & 演奏者）";
  $("#btnRegister").textContent = "保存";
  show("#view-register");
}

/* ===== 出欠フォーム構築（ヘッダ簡易サマリ＋入力欄） ===== */
function buildFormView(){
  // ヘッダ：イベント簡易サマリ（HOMEの「あなたの登録状況」と同等）
  if (!state.events.length){
    $("#formEventsBox").innerHTML = `<span>現在配信中の公演はありません</span>`;
  } else {
    const headerHtml = state.events.map(e=>{
      const d = parseDateLike(e.date);
      const dateDisp = ymdDow(d);
      const timeDisp = hmFromTimeCell(e.time);
      const ans = state.answers[e.eventId] || [];
      const perfs = Array.from(new Set(state.members.map(m=>m.performerName))).filter(Boolean);
      const map = {}; ans.forEach(r => { map[r.performerName] = r; });
      const rows = perfs.map(name=>{
        const a = map[name];
        let cls="stat-na", label="未回答";
        if (a && a.attend){
          if (a.attend==="参加") { cls="stat-ok"; label="参加"; }
          else if (a.attend==="欠席"){ cls="stat-ng"; label="欠席"; }
          else if (a.attend==="未定"){ cls="stat-pd"; label="未定"; }
        }
        return `<span class="pill sm ${cls}">${name}:${label}</span>`;
      }).join(" ");
      return `<div class="card" style="margin:8px 0">
        <div><b>${dateDisp} ${timeDisp}</b> @ ${e.place||""} ${e.isNew?`<span class="badge">NEW</span>`:""}</div>
        <div class="small muted">${e.deadline?`締切：${e.deadline}`:""}</div>
        <div style="margin-top:6px;">${rows||""}</div>
      </div>`;
    }).join("");
    $("#formEventsBox").innerHTML = headerHtml;
  }

  // 入力欄：各イベント×演奏者
  const box = $("#formFields");
  box.innerHTML = "";
  if (!state.events.length) return;

  for (const e of state.events){
    const current = state.answers[e.eventId] || [];
    const map = {}; current.forEach(r => map[r.performerName] = r);
    const performers = Array.from(new Set(state.members.map(m => m.performerName))).filter(Boolean);

    const d = parseDateLike(e.date);
    const dateDisp = ymdDow(d);
    const timeDisp = hmFromTimeCell(e.time);

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<div class="sectionTitle">【${dateDisp} ${timeDisp}】@${e.place||""}</div>`;

    performers.forEach((name, idx)=>{
      const row = map[name] || {};
      const attend = row.attend || "";
      const idBase = `e${e.eventId}_i${idx}`;

      const html = `
        <div style="border-top:1px dashed var(--c-border); margin:10px 0; padding-top:10px;">
          <div class="pill" style="margin-bottom:6px;">${name}</div>
          <label for="${idBase}_att">出欠</label>
          <select id="${idBase}_att" data-event="${e.eventId}" data-name="${name}">
            <option value="">（選択してください）</option>
            <option value="参加" ${attend==="参加"?"selected":""}>参加</option>
            <option value="欠席" ${attend==="欠席"?"selected":""}>欠席</option>
            <option value="未定" ${attend==="未定"?"selected":""}>未定</option>
          </select>

          <label for="${idBase}_com">コメント（任意・100文字まで）</label>
          <input type="text" id="${idBase}_com" value="${row.comment||""}" maxlength="100" placeholder="例：家族の都合で検討中 など">
        </div>
      `;
      card.insertAdjacentHTML("beforeend", html);
    });

    box.appendChild(card);
  }
}

/* ===== 出欠送信（submitBulk） ===== */
async function onSubmit(){
  if (state.submitting) return;
  state.submitting = true;
  const btn = $("#btnSubmit");
  btn.disabled = true; btn.textContent = "送信中…"; logForm("");

  try{
    const payloads = [];
    const seen = new Set();

    for (const e of state.events){
      const performers = Array.from(new Set(state.members.map(m => m.performerName))).filter(Boolean);
      performers.forEach((name, idx)=>{
        const idBase = `e${e.eventId}_i${idx}`;
        const sel = document.getElementById(`${idBase}_att`);
        if (!sel) return;
        const attend = sel.value;

        const comEl  = document.getElementById(`${idBase}_com`);
        const comment = (comEl?.value || "").trim();

        if (!attend) return; // 未選択は送信しない

        const key = `${e.eventId}||${name}`;
        if (seen.has(key)) return; seen.add(key);

        payloads.push({ eventId:e.eventId, performerName:name, attend, comment });
      });
    }

    if (!payloads.length){ alert("送信する内容がありません（出欠の選択が未入力です）"); return; }

    const grouped = {};
    for (const p of payloads){
      if (!grouped[p.eventId]) grouped[p.eventId] = [];
      grouped[p.eventId].push({ performerName:p.performerName, attend:p.attend, comment:p.comment });
    }

    // まとめ送信
    for (const [eventId, list] of Object.entries(grouped)){
      const url = `${API_ENDPOINT}?submitBulk=1&eventId=${esc(eventId)}&lineId=${esc(state.lineId)}&bulk=${esc(JSON.stringify(list))}`;
      const r = await fetch(url); const j = await r.json();
      if (j.status !== "ok") throw new Error(`送信失敗（${eventId}）: ${j.message||"unknown"}`);
    }

    alert("送信しました");
    show("#view-home");
    logHome("更新中…");
    await refreshData();
    logHome("");

  }catch(err){
    logForm(err.message || String(err));
  }finally{
    state.submitting = false;
    btn.disabled = false; btn.textContent = "送信する";
  }
}

/* ===== 初回登録ビュー ===== */
function resetRegisterForm(){
  $("#regInputName").value = state.name || "";
  $("#perfList").innerHTML = "";
  addPerformerField(""); // 最低1行
}
function buildRegisterFormFromMembers(){
  const inputName = (state.members[0]?.inputName || state.name || "");
  $("#regInputName").value = inputName;
  $("#perfList").innerHTML = "";
  const names = Array.from(new Set(state.members.map(m=>m.performerName))).filter(Boolean);
  if (names.length === 0) {
    addPerformerField("");
  } else {
    names.forEach(n=> addPerformerField(n));
  }
}
function addPerformerField(value=""){
  const id = "perf_" + Math.random().toString(36).slice(2);
  const row = document.createElement("div");
  row.className = "row"; row.style.margin = "6px 0";
  row.innerHTML = `
    <div style="flex:1; min-width:220px;">
      <label for="${id}" class="muted">演奏者名</label>
      <input type="text" id="${id}" class="regPerf" value="${value||""}" placeholder="例：藤塚 太郎">
    </div>
    <div>
      <button type="button" class="ghost" onclick="this.closest('.row').remove()">削除</button>
    </div>
  `;
  $("#perfList").appendChild(row);
}
async function onRegister(){
  try{
    logReg("");
    const inputName = $("#regInputName").value.trim();
    if (!inputName) throw new Error("入力者氏名を入力してください");

    const names = Array.from(document.querySelectorAll(".regPerf"))
      .map(el => (el.value||"").trim())
      .filter(Boolean);

    const uniq = Array.from(new Set(names));
    if (uniq.length === 0) throw new Error("演奏者を1名以上入力してください");

    $("#btnRegister").disabled = true; $("#btnRegister").textContent = (registerMode==="edit" ? "保存中…" : "登録中…");

    let url = "";
    if (registerMode === "edit") {
      url = `${API_ENDPOINT}?replaceMembers=1&lineId=${esc(state.lineId)}&inputName=${esc(inputName)}&list=${esc(JSON.stringify(uniq))}&purge=0`;
    } else {
      url = `${API_ENDPOINT}?registerBulk=1&lineId=${esc(state.lineId)}&inputName=${esc(inputName)}&list=${esc(JSON.stringify(uniq))}`;
    }

    const r = await fetch(url); const j = await r.json();
    if (j.status !== "ok") throw new Error(j.message || "登録に失敗しました");

    alert(registerMode==="edit" ? "氏名を保存しました" : "初回登録が完了しました");
    show("#view-home");
    logHome("更新中…");
    await refreshData();
    logHome("");

  }catch(err){
    logReg(err.message || String(err));
  }finally{
    $("#btnRegister").disabled = false; $("#btnRegister").textContent = (registerMode==="edit" ? "保存" : "登録する");
  }
}

/* ===== 今後の予定（Schedules） ===== */
async function renderSchedules(initial=false){
  const box = $("#schedulesBox");
  box.innerHTML = `読み込み中… <span class="spinner"></span>`;

  try{
    const days = Number($("#selDays").value || 60);
    const kind = $("#selKind").value || "";

    const url = kind
      ? `?schedules=1&days=${esc(days)}&kind=${esc(kind)}`
      : `?schedules=1&days=${esc(days)}`;

    const r = await api(url);
    if (r.status !== "ok" || !Array.isArray(r.schedules)) {
      box.innerHTML = `<span class="err">取得に失敗しました</span>`;
      return;
    }
    state.schedules = r.schedules;

    if (!state.schedules.length){
      box.innerHTML = `<div class="listEmpty">該当する予定はありません</div>`;
      return;
    }

    // ICS購読リンク
    const feedUrl = `${API_ENDPOINT}?icsFeed=1`;
    let html = `<div class="small muted" style="margin-bottom:8px;">
      ・各予定から「Googleカレンダー」/「iOS(ICS)」に追加できます。購読（自動反映）は下のリンクから登録してください。
    </div>`;

    html += state.schedules.map(it=>{
      // it: { id, date, time, title, place, kind, memo }
      const ymd = (it.date || "").replace(/（.）/,"").trim().slice(0,10); // "yyyy/MM/dd"
      const gcal = makeGoogleCalUrl(it.title, ymd, it.time||"", it.place, it.kind, it.memo||"");
      const ics  = `${API_ENDPOINT}?ics=1&id=${esc(it.id)}`;

      return `<div class="card">
        <div><b>${it.date} ${it.time||""}</b> @ ${it.place||""}</div>
        <div class="small muted">${it.kind||""} ${it.title||""}</div>
        ${it.memo?`<div class="small">${it.memo}</div>`:""}
        <div class="row" style="margin-top:8px;">
          <button class="ghost" onclick="window.open('${gcal}','_blank')">Googleカレンダー</button>
          <button class="ghost" onclick="window.open('${ics}','_blank')">iOS/ICS</button>
        </div>
      </div>`;
    }).join("");

    html += `
      <div class="card" style="margin-top:12px;">
        <div class="sectionTitle" style="margin:0 0 8px;">購読（自動反映）</div>
        <div class="small">以下のURLをカレンダーアプリの「カレンダーを購読」等の項目に貼り付けてください。</div>
        <div class="row" style="margin-top:6px; gap:8px; flex-wrap:wrap;">
          <input type="text" id="icsFeedUrl" value="${feedUrl}" style="flex:1; min-width:240px;" readonly>
          <button class="ghost" onclick="copyIcsFeed()">コピー</button>
          <button class="ghost" onclick="window.open('${feedUrl}','_blank')">開く</button>
        </div>
        <div class="small muted" style="margin-top:6px;">
          ※ Googleカレンダーに購読を追加する場合は、Googleカレンダーの「他のカレンダー」→「URL で追加」から登録してください。
        </div>
      </div>
    `;

    box.innerHTML = html;

  }catch(err){
    box.innerHTML = `<span class="err">エラー: ${err.message||err}</span>`;
  }
}
function copyIcsFeed(){
  const ipt = $("#icsFeedUrl");
  ipt.select();
  document.execCommand("copy");
  alert("購読URLをコピーしました");
}

/* ===== 起動 ===== */
init();
</script>
</body>
</html>
